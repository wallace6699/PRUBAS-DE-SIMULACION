ESTE SIMULADOR SE ENCUENTRA EN FASE DE PRUEBA - PUEDEN OCURRIR ERRORES DURANTE EL FUNCIONAMIENTO 2.3 / KEEP TRAINING 
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SETCA</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">

// delLast old handler removed
document.getElementById('confirmDelete').onclick = ()=>{
  const id = document.getElementById('deleteSelect').value;
  if(id && st && st.planes){
    st.planes = st.planes.filter(p=>p.id!==id);
    if(st.sel) st.sel = st.sel.filter(x=>x!==id);
    repaintPlanesList && repaintPlanesList();
    repaintNav && repaintNav();
    repaintAlt && repaintAlt();
    repaintPairs && repaintPairs();
  }
  document.getElementById('deleteModal').style.display='none';
};
document.getElementById('cancelDelete').onclick = ()=>{
  document.getElementById('deleteModal').style.display='none';
};

</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  const firebaseConfig = {
  apiKey: "AIzaSyDzwPIoWMV14NyvfxykylPjpB4GpFVwW9M",
  authDomain: "odi-gci.firebaseapp.com",
  databaseURL: "https://odi-gci-default-rtdb.firebaseio.com",
  projectId: "odi-gci",
  storageBucket: "odi-gci.firebasestorage.app",
  messagingSenderId: "324648898211",
  appId: "1:324648898211:web:3ef3adf57747e329fc3916"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  function getRoomId() {
    const h = (location.hash || "").replace(/^#/, "").trim();
    return h || "sala-default";
  }
  const ROOM_ID = getRoomId();
  const stateRef = ref(db, `rooms/${ROOM_ID}/state`);
  let currentUID = null;

  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, (user) => {
    if (!user) return;
    currentUID = user.uid;
    const presRef = ref(db, `rooms/${ROOM_ID}/presence/${currentUID}`);
    set(presRef, true);
    onDisconnect(presRef).remove();
  });

  async function pushStateToCloud(local) {
    if (!local) return;
    const payload = {
      planes: local.planes,
      roles: local.roles,
      drawings: local.drawings, 
      mode: local.mode,
      metric: local.metric,
      altUnit: local.altUnit,
      lastWriteBy: currentUID,
      missiles: local.missiles,
      lastUpdate: serverTimestamp()
    };
    await set(stateRef, payload);
  }

  onValue(stateRef, (snap) => {
    const v = snap.val();
    if (!v || v.lastWriteBy === currentUID) return;
    try {
      if (Array.isArray(v.planes)) st.planes = v.planes;
      else if (v.planes && typeof v.planes === "object") st.planes = Object.values(v.planes);
      if (v.roles) st.roles = v.roles; 
      if (v.drawings) st.drawings = v.drawings;
      if (v.mode) st.mode = v.mode;if (typeof v.metric === "boolean") st.metric = v.metric;
      if (v.altUnit) st.altUnit = v.altUnit;
      if (v.missiles) st.missiles = v.missiles;

      repaintPlanesList && repaintPlanesList();
      repaintNav && repaintNav();
      repaintAlt && repaintAlt();
      repaintPairs && repaintPairs();
      repaintStudent && repaintStudent();
    } catch(e){ console.warn("Apply remote state error:", e); }
  });

  window._SETCA_SYNC = {
    push: () => pushStateToCloud(st)
  };
</script>

 <style>
  :root{
    --crt:#020b03; --grid:#0d2c13; --grid2:#0e3a17; --crtLine:#2ee74f;
    --ui:#0a100c; --br:#20502a; --txt:#eaffea; --mut:#b6f3b6;
    --btn:#143a1d; --btnh:#1f5b2c; --warn:#ffe066; --alert:#ff4d4d;
    --sel:#1c6f3a; --sel2:#3be37f; --ink:#0ff; --ink2:#ffd166;
    --card:#0b140d; --card2:#0f1d12;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:#000;color:var(--txt);font-family:Segoe UI,Tahoma,Arial,sans-serif;overflow:hidden}
  .app{display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:auto 1fr;grid-template-areas:"top top top" "left center right";gap:8px;padding:8px;height:100vh}
  header{grid-area:top;background:linear-gradient(180deg,#0b150e,#07100a);border:1px solid var(--br);border-radius:10px;padding:8px;display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:18px;color:var(--mut);letter-spacing:.3px}
  .timer{margin-left:auto;background:#030; border:1px solid #164; border-radius:8px; padding:6px 10px; font-family:monospace; color:var(--warn)}
  .panel{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--br);border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:8px;min-height:0}
  .panel-header{display:flex;align-items:center;gap:8px;border-bottom:1px solid #163; padding-bottom:6px}
  .panel-header h3{margin:0;font-size:15px;color:var(--mut);flex:1;text-align:center}
  .toggle{background:#0b1a10;border:1px solid #2a5; border-radius:6px; padding:2px 6px; font-size:14px; cursor:pointer}
  .panel-body{display:flex;flex-direction:column;gap:8px}
  #left{grid-area:left;display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:2px}
  #right{grid-area:right;display:flex;flex-direction:column;gap:8px;overflow:auto;padding-left:2px}
  #center{grid-area:center;position:relative;overflow:hidden;padding:0;background:var(--crt)}
  #radar{position:absolute;inset:0;cursor:crosshair;image-rendering:pixelated}
  #radar.panning{cursor:grabbing}
  #hud{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.45);border:1px solid #1b3b1f;border-radius:6px;padding:6px 8px;font-family:monospace;font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:8px}
  button,.btn,input[type="number"],input[type="text"],select,textarea{
    padding:8px 10px;font-size:13px;border:1px solid #2a6; border-radius:8px; background: #0e2b17; color:var(--txt); cursor:pointer; transition:.14s;
  }
  button:hover,.btn:hover{background:#164f2b}
  .ghost{background:#0c1d12;color:#d7ffd7;border-color:#2a6}
  .chip{background:#132015;border:1px solid #2a6;border-radius:999px;padding:2px 8px;font-size:12px}
  .mini{font-size:12px}
  .pill{padding:2px 6px;border-radius:999px;border:1px solid #2c6e34;background:#0a110b;font-size:11px}
  .hi{box-shadow:0 0 8px #35ff79;border-color:#35ff79}
  .card{border:1px solid #2a5;border-radius:10px;padding:8px;background:linear-gradient(180deg,#0b160e,#0a1310)}
  .card strong{color:#b7ffca}

/* ===== NAV: Sesgo de giro I/D ===== */
.biasBtn{min-width:32px;padding:6px 8px;font-weight:700;letter-spacing:.05em}
.biasOn{
  background:rgba(255,209,102,.20)!important;
  border-color:#ffd166!important;
  color:#ffd166!important;
  box-shadow:0 0 10px rgba(255,209,102,.20);
}

  
  /* ===== Missile Alerts (tactical) ===== */
  .missileCard{
    border:1px solid #b21;
    border-radius:12px;
    padding:10px 10px 9px;
    background:linear-gradient(180deg, rgba(35,0,0,.78), rgba(10,0,0,.62));
    color:#ffe8a3;
    position:relative;
    overflow:hidden;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }
  .missileCard::before{
    content:"";
    position:absolute; inset:0;
    background: repeating-linear-gradient(
      to bottom,
      rgba(255,255,255,.055),
      rgba(255,255,255,.055) 1px,
      rgba(0,0,0,0) 3px,
      rgba(0,0,0,0) 7px
    );
    opacity:.18;
    pointer-events:none;
    mix-blend-mode:overlay;
  }
  .missileCard::after{
    content:"";
    position:absolute; left:0; top:0; bottom:0; width:4px;
    background:linear-gradient(180deg,#ff4d4d,#ffb703);
    opacity:.9;
    pointer-events:none;
  }
  .missileHdr{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
  .missileTitle{
    display:flex;align-items:center;gap:8px;
    font-size:12px; letter-spacing:.12em; text-transform:uppercase;
    color:#ffd166;
  }
  .missileDot{
    width:8px;height:8px;border-radius:50%;
    background:#ff3b3b; box-shadow:0 0 10px rgba(255,59,59,.65);
    animation:missPulse 1.15s infinite;
  }
  @keyframes missPulse{0%{transform:scale(1);opacity:.9}50%{transform:scale(1.35);opacity:.45}100%{transform:scale(1);opacity:.9}}
  .missileDist{
    font-size:12px; letter-spacing:.08em;
    color:#e9ffbf;
    padding:2px 8px;
    border:1px solid rgba(255,209,102,.35);
    border-radius:999px;
    background:rgba(0,0,0,.25);
    white-space:nowrap;
  }
  .missileGrid{display:grid;grid-template-columns: 1fr; gap:5px}
  .missileRow{display:flex;flex-wrap:wrap;gap:8px;align-items:baseline}
  .missileK{font-size:11px; letter-spacing:.14em; text-transform:uppercase; color:rgba(255,209,102,.9)}
  .missileV{font-size:12px; color:#fff2c2; font-weight:400}
  .missileArrow{opacity:.85}
  .missileEmpty{
    border:1px solid #2a5;border-radius:12px;padding:10px;
    background:linear-gradient(180deg,#0b160e,#0a1310);
    color:#b7ffca;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    letter-spacing:.06em;
    text-transform:uppercase;
    font-size:12px;
  }
.warn{color:var(--warn)}
  /* Focus / Selection contrast */
  .focusGlow,.focusGlow:focus{outline:2px solid var(--ink)!important; box-shadow:0 0 0 2px rgba(0,255,255,.35)!important; background:#0b1e2a!important}
  .focusAlt{outline:2px solid var(--ink2)!important; box-shadow:0 0 0 2px rgba(255,209,102,.3)!important; background:#231f0e!important}
  .flash{animation:flash .35s ease-out} @keyframes flash{0%{background:#1a5c32}100%{background:transparent}}
  /* Modal Reporte */
  .modal{position:fixed;inset:5% 5%;background:#f9fafb;color:#000;border:2px solid #000;border-radius:10px;box-shadow:0 10px 32px rgba(0,0,0,.6);display:none;overflow:auto;padding:14px;z-index:1000}
  .modal .close{position:absolute;top:8px;right:12px;color:#d00;font-weight:900;cursor:pointer;font-size:22px}
  .modal h2,.modal h3{text-align:center;margin:.4rem 0}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #aaa;padding:4px;text-align:left} thead tr{background:#e5e7eb}
  .charts{display:flex;gap:16px} .charts>div{flex:1;min-height:35vh}
  @media print{@page{size:A4 landscape;margin:10mm} body{background:#fff;color:#000} .app,header,#center{display:none} #report{display:block !important;position:static;border:none;box-shadow:none;padding:0}}
  /* tiny status footer */
  #status{position:absolute;left:8px;bottom:6px;font:11px monospace;opacity:.8}
  /* Pair list badge */
  .badge{display:inline-block;padding:1px 6px;border-radius:999px;border:1px solid #48bb78;background:#0c2a19;font:11px monospace;color:#d6ffe5}
  /* Alturas: n√∫meros un poco m√°s grandes */
  #altList .badge{font-size:13px;padding:2px 8px}

#pNet{display:none!important}

/* ======= Responsive Layout Enhancements ======= */
@media (max-width: 1400px) {
  .app {grid-template-columns: 260px 1fr 300px;}
}
@media (max-width: 1024px) {
  .app {grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; grid-template-areas:
    "top"
    "left"
    "center";}
  #right {display:block;}
  header{flex-wrap:wrap;gap:6px;justify-content:center;text-align:center;}
}
@media (max-width: 768px) {
  body{font-size:13px;}
  .app{padding:4px;gap:4px;}
  header h1{font-size:15px;}
  #left,#right{width:100%;max-height:40vh;overflow:auto;}
  #center{grid-area:center;width:100%;height:60vh;}
  canvas#radar{width:100%!important;height:100%!important;}
  .panel{padding:6px;}
  button,.btn,input,select{font-size:12px;padding:6px 8px;}
  .mini{font-size:11px;}
  .timer{font-size:12px;}
}
@media (max-width: 480px) {
  header h1{font-size:14px;}
  #hud{font-size:11px;padding:4px 6px;}
  #status{font-size:10px;}
  .panel-header h3{font-size:13px;}
  button,.btn,input,select{font-size:11px;padding:5px 6px;}
}

@media (max-width: 900px) {
  #main { display: block !important; }
  #left, #right { width: 100% !important; margin: 0 !important; padding: 0 !important; }
  #radarBox { width: 100% !important; height: auto !important; }
  canvas#radar { width: 100% !important; height: auto !important; }
}


@media (max-width: 1024px) {
  #main { display:flex !important; flex-direction:column !important; }
  #left, #right { width:100% !important; max-width:100% !important; }
  #radarBox { width:100% !important; }
  canvas#radar { width:100% !important; height:auto !important; }
}


/* === FLUID RESPONSIVE FIX === */
body{overflow:auto!important;}
.app{height:auto!important;min-height:100vh!important;}
#center{height:auto!important;min-height:50vh!important;}
canvas#radar{width:100%!important;height:auto!important;max-width:100vw!important;}


/* === RESPONSIVE FULL ADAPTATION (NO FEATURES CHANGED) === */
:root { --pad: 6px; }
* { box-sizing: border-box; }

/* Allow scroll and fluid scaling */
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: auto !important;
}

/* Main layout adapts to width */
.app {
  display: grid;
  grid-template-columns: 300px 1fr 340px;
  grid-template-rows: auto 1fr;
  grid-template-areas:
    "top top top"
    "left center right";
  gap: 8px;
  width: 100%;
  height: auto;
  min-height: 100vh;
}

/* Medium screens: stack right panel below left */
@media (max-width: 1200px) {
  .app {
    grid-template-columns: 280px 1fr;
    grid-template-areas:
      "top top"
      "left center"
      "right center";
  }
}

/* Tablet: vertical stacking */
@media (max-width: 900px) {
  .app {
    grid-template-columns: 1fr;
    grid-template-areas:
      "top"
      "center"
      "left"
      "right";
  }
}

/* Radar always full width */
#center {
  width: 100% !important;
  height: auto !important;
  padding: 0 !important;
  margin: 0 !important;
}
canvas#radar {
  width: 100% !important;
  height: auto !important;
  display: block;
}

/* Panels scroll independently */
#left, #right {
  width: 100%;
  overflow-y: auto;
}

/* ===== NAV: panel de navegaci√≥n compacto y alineado ===== */
#navCards{ 
  --navCtlW:60px;
  --navCtlH:20px;
  --navGap:4px;
}

/* Controles uniformes (inputs, selects y botones del panel) */
#navCards .navRow input[type="number"],
#navCards .navRow select,
#navCards .navRow button{
  width:var(--navCtlW);
  height:var(--navCtlH);
  font-size:12px;
  padding:2px 3px;
  margin:0;
  text-align:center;
  border-radius:4px;
  box-sizing:border-box;
}

/* Tarjeta y header */
#navCards .navCard{ padding:6px 8px; }
#navCards .navHeader{
  display:flex;
  align-items:center;
  gap:6px;
  justify-content:space-between;
  margin-bottom:4px;
}
#navCards .navHeader input{
  flex:1;
  width:auto !important;
  min-width:90px;
}
#navCards .navTitle{
  font-size:11px;
  font-weight:800;
  letter-spacing:.10em;
  opacity:.9;
}

/* Filas */
#navCards .navRow{
  display:flex;
  align-items:center;
  gap:var(--navGap);
  margin:2px 0;
  flex-wrap:nowrap;
}
#navCards .navRow .lbl{
  width:50px;
  flex:0 0 50px;
  font-size:11px;
  opacity:.85;
}

/* Rumbo: I/D m√°s delgados para que todo entre en una sola l√≠nea */
#navCards .biasBtn{
  width:26px !important;
  min-width:26px !important;
  padding:0 !important;
}

/* Bottom row: permite envolver y usa el ancho completo */
#navCards .navBottom{ flex-wrap:wrap; }

/* ROL y OBJ: mismo ancho que el resto */
#navCards .navObj{
  width:var(--navCtlW) !important;
  min-width:var(--navCtlW);
  flex:0 0 var(--navCtlW);
}

/* Botones finales: ocupan TODO el ancho (3 columnas iguales) */
#navCards .navWeapons{
  flex:1 0 100%;
  width:100%;
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:4px;
  margin-top:4px;
}
#navCards .navWeapons button{
  width:100% !important;
  min-width:0 !important;
}

/* ===== Habilita zoom t√°ctil con dos dedos en el radar ===== */
canvas#radar {
  touch-action: none;           /* evita el zoom/pan del navegador */
  -webkit-user-select: none;    /* evita selecci√≥n accidental en iPhone/iPad */
  user-select: none;            /* evita selecci√≥n en Android y PC */
}

/* tus estilos anteriores... */

/* ===== Color negro exclusivo para el reporte t√°ctico ===== */
#reportContent, 
#reportContent * {
  color: #000000 !important;
}


#modeDigital { display:none !important; }

/* Compact CMD buttons */
#pCmdBody .btn.mini {
  padding:2px 6px !important;
  font-size:11px !important;
  min-width:60px !important;
}
#pCmdBody input {
  height:20px !important;
}


/* Compact Formaciones buttons (more compact but fills full width) */
#pFormationsBody .btn-grid{
  gap:6px !important;
  grid-template-columns:repeat(auto-fit, minmax(92px, 1fr)) !important;
  align-items:stretch !important;
}
#pFormationsBody .btn.mini{
  padding:2px 6px !important;
  font-size:11px !important;
  line-height:1.1 !important;
  min-height:22px !important;
  border-radius:7px !important;
  letter-spacing:0.02em !important;
}

/* Compact Herramientas de Dibujo buttons (compact but fills full width) */
#pDrawBody .btn-grid{
  gap:6px !important;
  grid-template-columns:repeat(auto-fit, minmax(78px, 1fr)) !important;
  align-items:stretch !important;
}
#pDrawBody .btn.mini{
  padding:2px 6px !important;
  font-size:11px !important;
  line-height:1.1 !important;
  min-height:22px !important;
  border-radius:7px !important;
  letter-spacing:0.02em !important;
}
/* Make coord grid a touch tighter to match */
#pDrawBody .coord-grid{
  gap:6px !important;
}
#pDrawBody .coord-grid input{
  padding:6px 8px !important;
  min-height:22px !important;
  font-size:11px !important;
}



.btn:active, .btn.btn-hold {
  background: yellow !important;
  color:black !important;
}


  /* === Men√∫ contextual de gr√°ficos === */
  #drawingCtxMenu{
    position:fixed;
    z-index:99999;
    display:none;
    background:rgba(5,10,6,0.95);
    border:1px solid var(--warn);
    border-radius:10px;
    padding:6px;
    box-shadow:0 10px 25px rgba(0,0,0,0.55);
    font-family:monospace;
    min-width:170px;
  }
  #drawingCtxMenu .ctxItem{
    width:100%;
    text-align:left;
    background:transparent;
    border:0;
    color:var(--txt);
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    font-weight:400;
  }
  #drawingCtxMenu .ctxItem:hover{
    background:rgba(255,224,102,0.12);
  }



/* === UI order / layout polish (CMD, Formaciones, Dibujo) === */
.group{
  border:1px solid rgba(42,102,51,0.55);
  background:rgba(0,0,0,0.18);
  border-radius:10px;
  padding:8px;
}
.group-title{
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--mut);
  opacity:.95;
  margin:0 0 6px 0;
}
.btn-grid{
  display:grid;
  gap:8px;
  grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
  align-items:stretch;
}
.btn-grid.small{
  grid-template-columns:repeat(auto-fit, minmax(90px, 1fr));
}
.btn-grid.radar3{
  grid-template-columns:repeat(3, 1fr);
}
.cmd-row-2{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:nowrap;
}
.cmd-row-2 .pred-inline{flex:1;justify-content:flex-end;flex-wrap:nowrap;white-space:nowrap;}

.pred-inline{
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:nowrap;
  justify-content:flex-end;
  white-space:nowrap;
}

.coord-grid{
  display:grid;
  gap:8px;
  grid-template-columns: 1fr 1fr auto;
  align-items:stretch;
}
.coord-grid input{width:100%}


/* ===== APTO selector (LOCAL) ===== */
.aptoOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.60);z-index:9998}
.aptoCard{width:min(720px,92vw);max-height:82vh;background:#0b0f0c;color:#eaffea;border:1px solid rgba(46,231,79,.35);border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,.65);display:flex;flex-direction:column;overflow:hidden}
.aptoHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(46,231,79,.18)}
.aptoTitle{font-weight:800;letter-spacing:.3px}
.aptoBody{padding:10px 12px;display:flex;flex-direction:column;gap:10px;overflow:hidden}
.aptoRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.aptoLocal{font-size:11px;opacity:.85;border:1px solid rgba(255,224,102,.35);padding:2px 7px;border-radius:999px;color:#ffe066}
.aptoSeg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.aptoSeg .btn{width:100%}
#aptoSearch{width:100%;padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background:#08110b;color:#eaffea;outline:none}
.aptoCustom{display:flex;flex-direction:column;gap:8px}
.aptoCustom.hidden{display:none}
.aptoList{flex:1;max-height:44vh;overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:rgba(0,0,0,.22);padding:6px}
.aptoItem{display:flex;gap:8px;align-items:flex-start;padding:6px 6px;border-radius:8px}
.aptoItem:hover{background:rgba(46,231,79,.06)}
.aptoItem input{margin-top:2px}
.aptoItem .t{font-size:12px;line-height:1.15}
.aptoItem .s{font-size:11px;opacity:.72;margin-top:2px}
.aptoActions{display:flex;gap:6px}
.aptoActions .btn{flex:1}
.aptoFoot{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(46,231,79,.18)}
.aptoFoot .btn{flex:1}

</style>
</head>
<body>
<div class="app">
<header>
  <h1>SETCA</h1>

  <button id="start" style="display:none" class="btn focusable">‚ñ∂Ô∏è Iniciar</button>
  <button id="pause" class="btn focusable">‚è∏Ô∏è Pausar</button>
<button id="toggleLabels" class="btn focusable">üß∑ Etiquetas</button>
  <button id="reportBtn" class="btn focusable">üìù Reporte T√°ctico</button>

  <button
    id="reportPartialBtn"
    class="btn focusable"
    style="margin-left:10px;"
    onclick="window.open('https://wallace6699.github.io/odi-simulador-2025/reporte.html', '_blank')">
    üìÑ Ver / Imprimir Informe Parcial
  </button>

  <span id="stateChip" class="pill">Pausada</span>
  <span id="timer" class="timer"></span>
</header>
  
  <aside id="left">
    <section class="panel" id="pCmd">
      <div class="panel-header"><h3>Centro de Mando</h3><span class="toggle" data-target="#pCmdBody">‚ñæ</span></div>
      <div id="pCmdBody" class="panel-body">
        <div class="group">
          <div class="group-title">Unidades</div>
          <div class="btn-grid small">
            <button id="uMetric" class="btn mini focusable">M√©trico</button>
            <button id="uImperial" class="btn mini focusable">Imperial</button>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Radar</div>
          <div class="btn-grid small radar3">
            <button id="failRadar" class="btn mini focusable">Falla Radar</button>
            <button id="toggleSweep" class="btn mini focusable">Haz Radar</button>
                      <button id="toggleAirports" class="btn mini focusable">APTO</button>
</div>
        </div>

        <div class="group">
          <div class="group-title">Predicci√≥n</div>
          <div class="cmd-row-2">
            <button id="modeDigital" class="btn mini focusable">Digital</button>
            <div class="pred-inline">
              <span class="chip">Pred</span>
              <button id="predMinus" class="btn mini focusable">-</button>
              <span id="predVal" class="pill">5</span>
              <button id="predPlus" class="btn mini focusable">+</button>
            </div>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Gesti√≥n de Unidades</div>
          <div class="btn-grid small">
            <button id="addFighter" class="btn mini focusable">‚ûï Caza</button>
            <button id="addCom" class="btn mini focusable">‚úàÔ∏è Comercial</button>
            <button id="delLast" class="btn mini focusable">üóëÔ∏è Eliminar</button>
          </div>

          <div class="btn-grid small" style="margin-top:8px">
            <button id="exportFormBtn" class="btn mini focusable">üíæ Exportar</button>
            <button id="importFormBtn" class="btn mini focusable">üìÇ Cargar</button>
          </div>
          <input type="file" id="formFileInput" accept=".json" style="display:none">
        </div>
      </div>
    </section>

    <section class="panel" id="pPlanes">
      <div class="panel-header"><h3>Aviones</h3><span class="toggle" data-target="#pPlanesBody">‚ñæ</span></div>
      <div id="pPlanesBody" class="panel-body"><div id="planeList" class="col"></div></div>
    </section>

    <section class="panel" id="pNav">
      <div class="panel-header"><h3>Panel de Navegaci√≥n</h3><span class="toggle" data-target="#pNavBody">‚ñæ</span></div>
      <div id="pNavBody" class="panel-body" style="max-height:70vh;overflow:auto; font-size:14px;"><div id="navCards" class="col"></div></div>
    </section>
  </aside>

  <main id="center" class="panel">
    <canvas id="radar"></canvas>
    <div id="hud" class="mini"></div>
    <div id="status">FPS: <span id="fps">0</span> ‚Ä¢ Estado: <span id="simstate">PAUSA</span></div>
  </main>

  <aside id="right">
    

    <section class="panel" id="pPair">
      <div class="panel-header"><h3>Emparejamientos</h3><span class="toggle" data-target="#pPairBody">‚ñæ</span></div>
      <div id="pPairBody" class="panel-body">
        <div class="row">
          <select id="pairA" class="ghost focusable" style="flex:1"></select>
          <select id="pairB" class="ghost focusable" style="flex:1"></select>
        </div>
        <div class="row">
          <button id="doPair" class="btn mini focusable">Parear</button>
          <button id="unPair" class="btn mini focusable">Soltar todo</button>
        </div>
        <div id="pairList" class="col" style="max-height:22vh;overflow:auto"></div>
      </div>
    </section>

    <section class="panel" id="pAlt">
      <div class="panel-header"><h3>Informaci√≥n de ayuda al vuelo</h3><span class="toggle" data-target="#pAltBody">‚ñæ</span></div>
      <div id="pAltBody" class="panel-body">
        <div class="row" style="display:none"><button id="altFt" class="btn mini focusable">FT</button><button id="altM" class="btn mini focusable">M</button></div>

        <div class="row">
          <span class="chip">Viento</span>
          <span class="mini">Vel</span><input id="windSpd" class="ghost focusable" type="number" value="0" style="width:55px">
          <span class="mini">Dir</span><input id="windDir" class="ghost focusable" type="number" value="0" style="width:55px">
        </div>

        <div id="altList" class="col" style="max-height:22vh;overflow:auto"></div>
      </div>
    </section>

    
    <section class="panel" id="pFormations">
      <div class="panel-header"><h3>Formaciones</h3><span class="toggle" data-target="#pFormationsBody">‚ñæ</span></div>
      <div id="pFormationsBody" class="panel-body">
        <div class="btn-grid">
          <button class="btn mini focusable" data-form="RANGE">Range</button>
          <button class="btn mini focusable" data-form="VIC">Vic</button>
          <button class="btn mini focusable" data-form="CHAMPAGNE">Champagne</button>
          <button class="btn mini focusable" data-form="AZIMUT2">Azimut de 2</button>
          <button class="btn mini focusable" data-form="WALL4">Wall de 4</button>
          <button class="btn mini focusable" data-form="LEADTRAIL2">Lead Trail de 2</button>
          <button class="btn mini focusable" data-form="LINEABREAST2">Line Abreast de 2</button>
          <button class="btn mini focusable" data-form="BOX6">Box de 6</button>
          <button class="btn mini focusable" data-form="CONTAINER4">Container de 4</button>
        </div>
      </div>
    </section>

    <section class="panel" id="pDraw">
      <div class="panel-header"><h3>Herramientas de Dibujo</h3><span class="toggle" data-target="#pDrawBody">‚ñæ</span></div>
      <div id="pDrawBody" class="panel-body">
        <div class="btn-grid small">
          <button class="btn mini tool focusable" data-tool="point">Punto</button>
          <button class="btn mini tool focusable" data-tool="line">L√≠nea</button>
          <button class="btn mini tool focusable" data-tool="arwy">ARWY</button>
          <button class="btn mini tool focusable" data-tool="circle">C√≠rculo</button>
          <button class="btn mini tool focusable" data-tool="square">Cuadrado</button>
          <button class="btn mini tool focusable" data-tool="polygon">Pol√≠gono</button>
          <button class="btn mini tool focusable" data-tool="bullseye">Bullseye</button>
          <button class="btn mini tool focusable" data-tool="label">Etiqueta</button>
        </div>
<div class="coord-grid">
          <input id="coordLat" class="ghost focusable" type="text" placeholder="Lat (DMS o decimal)">
          <input id="coordLon" class="ghost focusable" type="text" placeholder="Lon (DMS o decimal)">
          <button id="placeLL" class="btn mini focusable">Crear (Coord)</button>
        </div>

      </div>
    </section>

    <section class="panel" id="pAlerts">
      <div class="panel-header"><h3>Misiles Entrantes</h3><span class="toggle" data-target="#pAlertsBody">‚ñæ</span></div>
      <div id="pAlertsBody" class="panel-body"><div id="missileAlerts" class="col"></div></div>
    </section>

  </aside>
</div>

<!-- Reporte -->
<div id="report" class="modal"><span id="closeReport" class="close">&times;</span><div id="reportContent"></div></div>

<script>
/* ===== Utils ===== */
const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
function togglePanel(el){const t=el.getAttribute('data-target');const b=$(t);if(!b)return;const v=b.style.display!=='none';b.style.display=v?'none':'';el.textContent=v?'‚ñ∏':'‚ñæ';}
$$('.toggle').forEach(el=>el.addEventListener('click',()=>togglePanel(el)));
function flash(el){el.classList.add('flash');setTimeout(()=>el.classList.remove('flash'),250);}

/* ===== Constantes / Estado ===== */
const NM2KM=1.852,KTS2KMH=1.852,KMH2KTS=1/1.852,FT2M=0.3048;
const MAX_RANGE_NM=1000,GRID_STEP_NM=10,PX_PER_NM=20;
/* ===== Aeropuertos (Per√∫) / Centro radar =====
   Coordenadas en grados decimales (lat/lon). Posici√≥n local en NM relativa al centro (SPJC).
*/
const CENTER_AIRPORT = { icao:'SPJC', iata:'LIM', name:'Jorge Ch√°vez', city:'Lima', lat:-12.0219, lon:-77.1143 };
const AIRPORTS_PE = [
  {icao:'SPJC', iata:'LIM', name:"Jorge Ch√°vez International Airport", city:"Lima", lat:-12.0219, lon:-77.114305, type:'large_airport', primary:true},
  {icao:'PE-0001', iata:'', name:"Lagunas Airstrip", city:"Lagunas", lat:-5.2475, lon:-75.678, type:'small_airport'},
  {icao:'PE-0003', iata:'', name:"Cabo Pantoja Airstrip", city:"Cabo Pantoja", lat:-0.952, lon:-75.179731, type:'small_airport'},
  {icao:'PE-0004', iata:'', name:"Santa Maria de Fatima Airport", city:'', lat:-11.940815, lon:-68.994212, type:'small_airport'},
  {icao:'PE-0005', iata:'', name:"Kirigueti Airfield", city:"Kirigueti", lat:-11.574279, lon:-73.128657, type:'closed'},
  {icao:'PE-0007', iata:'', name:"Pucallpa West Airport", city:"Pucallpa", lat:-8.361953, lon:-74.656877, type:'small_airport'},
  {icao:'PE-0008', iata:'', name:"Saramuro Airport", city:"Saramuro", lat:-4.707892, lon:-74.876733, type:'small_airport'},
  {icao:'PE-0010', iata:'', name:"Pativilca Airstrip", city:"Pativilca", lat:-10.705015, lon:-77.800884, type:'small_airport'},
  {icao:'PE-0011', iata:'', name:"Patao Airport", city:"Barranca", lat:-10.714039, lon:-77.746854, type:'small_airport'},
  {icao:'PE-0012', iata:'', name:"Chinchero International Airport (Under Construction)", city:"Chinchero", lat:-13.3915, lon:-72.069, type:'closed'},
  {icao:'PE-0013', iata:'', name:"Pucallpa Air Force Heliport", city:"Pucallpa", lat:-8.3515, lon:-74.5819, type:'heliport'},
  {icao:'PE-0014', iata:'', name:"Misi√≥n SAM Airport", city:"Pucallpa", lat:-8.35681, lon:-74.66043, type:'small_airport'},
  {icao:'PE-0015', iata:'', name:"Puerto Anapati Heliport", city:"Puerto Anapati", lat:-11.92859, lon:-73.9877, type:'heliport'},
  {icao:'PE-0016', iata:'', name:"Micaela Bastidas Morales Heliport", city:"Misi√≥n", lat:-11.857, lon:-73.9589, type:'heliport'},
  {icao:'PE-0017', iata:'', name:"Puerto Ocopa Heliport", city:"Puerto Ocopa", lat:-11.14793, lon:-74.30629, type:'heliport'},
  {icao:'PE-0018', iata:'', name:"Tanquin Heliport", city:"Tanquin", lat:-12.12632, lon:-74.07599, type:'heliport'},
  {icao:'PE-0019', iata:'', name:"Tamburco Airport", city:"Tamburco", lat:-13.56872, lon:-72.82457, type:'small_airport'},
  {icao:'PE-0020', iata:'', name:"Diospi Suyana Hospital Heliport", city:"Curahuasi", lat:-13.54249, lon:-72.70599, type:'heliport'},
  {icao:'PE-0021', iata:'', name:"Pichari Airport", city:"Sivia", lat:-12.50306, lon:-73.85287, type:'small_airport'},
  {icao:'PE-0022', iata:'', name:"Camposol Chao Airport", city:"Vir√∫", lat:-8.58173, lon:-78.68142, type:'small_airport'},
  {icao:'PE-0024', iata:'', name:"Yapatera Airport", city:"Yapatera", lat:-5.06777, lon:-80.14731, type:'small_airport'},
  {icao:'PE-0025', iata:'', name:"Huacho Airport", city:"Santa Mar√≠a", lat:-11.11008, lon:-77.55382, type:'small_airport'},
  {icao:'PE-0027', iata:'', name:"San Bartolo Airport", city:"San Bartolo", lat:-12.38084, lon:-76.78206, type:'small_airport'},
  {icao:'PE-0028', iata:'', name:"Chilca Airport", city:"Chilca", lat:-12.50469, lon:-76.74428, type:'closed'},
  {icao:'PE-0029', iata:'', name:"Las Plumas Airport", city:"Cerro Azul", lat:-12.91902, lon:-76.49186, type:'small_airport'},
  {icao:'PE-0030', iata:'', name:"Aeroclub Alas del Mar", city:"Santa Mar√≠a del Mar", lat:-12.40001, lon:-76.76806, type:'small_airport'},
  {icao:'PE-0031', iata:'', name:"Aldora Airport", city:"Paita", lat:-5.15176, lon:-80.94737, type:'closed'},
  {icao:'PE-0032', iata:'', name:"Chivay Airport", city:"Chivay", lat:-15.63627, lon:-71.61376, type:'small_airport'},
  {icao:'PE-0034', iata:'', name:"Central FAP Hospital Helipad", city:"Miraflores", lat:-12.103711, lon:-77.030216, type:'heliport'},
  {icao:'PE-0035', iata:'', name:"Collique Airport", city:"Collique Bajo", lat:-11.9287, lon:-77.061096, type:'closed'},
  {icao:'PE-0036', iata:'', name:"Camana Airport", city:"Camana", lat:-16.606999, lon:-72.697649, type:'closed'},
  {icao:'PE-0037', iata:'', name:"Satipo Airport", city:"Satipo", lat:-11.2625, lon:-74.647778, type:'closed'},
  {icao:'PE-0038', iata:'', name:"Puerto Ocopa Airport", city:"Puerto Ocopa", lat:-11.143755, lon:-74.307153, type:'closed'},
  {icao:'PE-0039', iata:'', name:"Paramonga Airport", city:"Paramonga", lat:-10.667, lon:-77.833, type:'closed'},
  {icao:'PE-0040', iata:'', name:"Requena Airport", city:"Requena", lat:-5.078026, lon:-73.856404, type:'closed'},
  {icao:'PE-0041', iata:'', name:"Bay√≥var Airport", city:"Bay√≥var", lat:-5.83075, lon:-81.025803, type:'closed'},
  {icao:'PE-0042', iata:'', name:"Chincha Airport", city:"Chincha", lat:-13.37036, lon:-76.11276, type:'closed'},
  {icao:'PE-0043', iata:'', name:"Ica Airport", city:"Ica", lat:-14.2001, lon:-75.573898, type:'closed'},
  {icao:'PE-0044', iata:'', name:"Anc√≥n Airport", city:"Anc√≥n", lat:-11.7947, lon:-77.180901, type:'closed'},
  {icao:'PE-0045', iata:'', name:"Sullana Airport", city:"Sullana", lat:-4.903889, lon:-80.68528, type:'closed'},
  {icao:'PE-0046', iata:'', name:"San Juan Aposento Airport", city:"San Juan Aposento", lat:-15.3539, lon:-75.167099, type:'closed'},
  {icao:'PE-0047', iata:'', name:"Barranca Airport", city:"Barranca", lat:-10.75, lon:-77.76667, type:'closed'},
  {icao:'PE-0048', iata:'', name:"Cunocuno Airport", city:"Cunocuno", lat:-15.977222, lon:-73.10833, type:'closed'},
  {icao:'PE-0049', iata:'', name:"Fausa Airport", city:"Fausa", lat:-14.7094, lon:-71.731102, type:'closed'},
  {icao:'PE-0050', iata:'', name:"Olmos Airport", city:"Olmos", lat:-5.984722, lon:-79.745277, type:'closed'},
  {icao:'PE-0051', iata:'', name:"Lobitos Airport", city:"Lobitos", lat:-4.448611, lon:-81.275558, type:'closed'},
  {icao:'PE-0052', iata:'', name:"Santa Maria Airport", city:"Santa Mar√≠a", lat:-11.983334, lon:-77.0, type:'closed'},
  {icao:'PE-0053', iata:'', name:"Zorritos Airport", city:"Contralmirante Villar", lat:-3.67374, lon:-80.652397, type:'closed'},
  {icao:'PE-0054', iata:'', name:"Pomacocha Airport", city:"Pomacocha", lat:-15.1792, lon:-73.274399, type:'closed'},
  {icao:'PE-0055', iata:'', name:"Tintay Airport", city:"Tintay", lat:-13.959167, lon:-73.185837, type:'closed'},
  {icao:'PE-0056', iata:'BLP', name:"Huallaga Airport", city:"Bellavista", lat:-7.06056, lon:-76.582199, type:'small_airport'},
  {icao:'PE-0057', iata:'', name:"La Perla Naval Base Heliport", city:"Callao", lat:-12.070465, lon:-77.105331, type:'heliport'},
  {icao:'PE-0058', iata:'', name:"Naval Medical Center Heliport", city:"Callao", lat:-12.060212, lon:-77.092275, type:'heliport'},
  {icao:'SOML', iata:'', name:"Malin Airport", city:"Malin", lat:-7.63333, lon:-78.650002, type:'small_airport'},
  {icao:'SPAA', iata:'', name:"Caraz Airport", city:"Ancash", lat:-9.051429, lon:-77.810143, type:'small_airport'},
  {icao:'SPAB', iata:'', name:"Huancabamba Airport", city:"Huancabamba", lat:-5.25677, lon:-79.442902, type:'small_airport'},
  {icao:'SPAC', iata:'', name:"Ciro Alegria Airport", city:"Santa Mar√≠a de Nieva", lat:-4.607492, lon:-77.940935, type:'small_airport'},
  {icao:'SPAG', iata:'', name:"Aguaytia Airport", city:"Aguaytia", lat:-9.03741, lon:-75.509201, type:'small_airport'},
  {icao:'SPAI', iata:'', name:"Urpay Airport", city:"Pataz", lat:-8.3495, lon:-77.3985, type:'small_airport'},
  {icao:'SPAL', iata:'', name:"Alao Airport", city:"El Dorado", lat:-6.5, lon:-76.716698, type:'small_airport'},
  {icao:'SPAP', iata:'', name:"Picota Airport", city:"Picota", lat:-6.909451, lon:-76.32909, type:'small_airport'},
  {icao:'SPAR', iata:'ALD', name:"Alerta Airport", city:"Fortaleza", lat:-11.65018, lon:-69.229614, type:'small_airport'},
  {icao:'SPAS', iata:'AOP', name:"Alferez FAP Alfredo Vladimir Sara Bauer Airport", city:"Andoas", lat:-2.79613, lon:-76.466599, type:'small_airport'},
  {icao:'SPAT', iata:'', name:"Aguas Calientes Airport", city:"Aguas Calientes", lat:-8.83333, lon:-74.683296, type:'small_airport'},
  {icao:'SPAY', iata:'AYX', name:"Teniente General Gerardo P√©rez Pinedo Airport", city:"Atalaya", lat:-10.7291, lon:-73.766502, type:'medium_airport'},
  {icao:'SPBB', iata:'MBP', name:"Moyobamba Airport", city:"Moyobamba", lat:-6.018889, lon:-76.988327, type:'small_airport'},
  {icao:'SPBC', iata:'', name:"Caballococha Airport", city:"Caballococha", lat:-3.91686, lon:-70.508202, type:'medium_airport'},
  {icao:'SPBJ', iata:'', name:"Buncuyo", city:"Ram√≥n Castilla", lat:-6.516667, lon:-74.583333, type:'small_airport'},
  {icao:'SPBL', iata:'', name:"Bolognesi Airport", city:"Bolognesi", lat:-10.029555, lon:-73.943375, type:'small_airport'},
  {icao:'SPBQ', iata:'', name:"Nuevo Acari Airport", city:"San Isidro", lat:-15.45003, lon:-74.74423, type:'small_airport'},
  {icao:'SPBR', iata:'IBP', name:"Iberia Airport", city:"Iberia", lat:-11.4116, lon:-69.488701, type:'medium_airport'},
  {icao:'SPBS', iata:'', name:"Bellavista Airport", city:"Jeberos", lat:-5.28839, lon:-76.292099, type:'small_airport'},
  {icao:'SPBT', iata:'', name:"Obenteni Airport", city:"Obenteni", lat:-10.755137, lon:-74.221749, type:'small_airport'},
  {icao:'SPCC', iata:'', name:"Ciudad Constituci√≥n Airport", city:"Ciudad Constituci√≥n", lat:-9.865278, lon:-75.008888, type:'small_airport'},
  {icao:'SPCG', iata:'', name:"Casa Grande Airport", city:"Ascope", lat:-7.743889, lon:-79.186386, type:'small_airport'},
  {icao:'SPCH', iata:'', name:"Tocache Airport", city:"Tocache", lat:-8.195356, lon:-76.530241, type:'small_airport'},
  {icao:'SPCI', iata:'', name:"Campamento De Ilo Aerodrome", city:'', lat:-17.615403, lon:-71.330883, type:'small_airport'},
  {icao:'SPCL', iata:'PCL', name:"Cap FAP David Abenzur Rengifo International Airport", city:"Pucallpa", lat:-8.378064, lon:-74.574495, type:'large_airport'},
  {icao:'SPCM', iata:'', name:"Contamana Airport", city:"Contamana", lat:-7.335827, lon:-74.992531, type:'small_airport'},
  {icao:'SPCP', iata:'', name:"Pucacaca Airport", city:"Pucacaca", lat:-6.843543, lon:-76.33959, type:'small_airport'},
  {icao:'SPCR', iata:'', name:"Acar√≠ Airbase Airport", city:"Acar√≠", lat:-15.5, lon:-74.666672, type:'small_airport'},
  {icao:'SPCT', iata:'', name:"Chota Airport", city:"Chota", lat:-6.55, lon:-78.650002, type:'small_airport'},
  {icao:'SPCV', iata:'', name:"Quempiri Airfield", city:"Cutivireni", lat:-11.876932, lon:-73.916868, type:'small_airport'},
  {icao:'SPDN', iata:'', name:"Colonia Angamos Airport", city:"Colonia Angamos", lat:-5.137125, lon:-72.867889, type:'small_airport'},
  {icao:'SPDO', iata:'', name:"Mollendo Airport", city:"Mollendo", lat:-17.045401, lon:-71.983704, type:'small_airport'},
  {icao:'SPDR', iata:'TDP', name:"Trompeteros Airport", city:"Corrientes", lat:-3.80601, lon:-75.039299, type:'small_airport'},
  {icao:'SPDS', iata:'', name:"Cuajone Botiflaca Airport", city:"Cuajone", lat:-17.070833, lon:-70.770833, type:'small_airport'},
  {icao:'SPDU', iata:'', name:"Pueblo Libre Del Codo Airport", city:'', lat:-9.664617, lon:-75.285337, type:'small_airport'},
  {icao:'SPEB', iata:'', name:"Pebas Airport", city:"Loreto", lat:-3.3333, lon:-71.816704, type:'small_airport'},
  {icao:'SPEE', iata:'', name:"El Estrecho Airport", city:'', lat:-2.45406, lon:-72.670601, type:'small_airport'},
  {icao:'SPEN', iata:'', name:"Iscozasin Airport", city:"Iscozasin", lat:-10.183, lon:-75.150002, type:'small_airport'},
  {icao:'SPEO', iata:'CHM', name:"FAP Lieutenant Jaime Andres de Montreuil Morales Airport", city:"Chimbote", lat:-9.14961, lon:-78.523804, type:'medium_airport'},
  {icao:'SPEP', iata:'', name:"Puerto Esperanza Airport", city:"Esperanza", lat:-9.76813, lon:-70.706497, type:'small_airport'},
  {icao:'SPEQ', iata:'', name:"Cesar Torke Podesta Airport", city:"Moquegua", lat:-17.179001, lon:-70.930801, type:'small_airport'},
  {icao:'SPEZ', iata:'', name:"Puerto Bermudez Airport", city:"Oxapampa", lat:-10.2992, lon:-74.937202, type:'small_airport'},
  {icao:'SPGB', iata:'', name:"Galilea Airport", city:'', lat:-4.03188, lon:-77.758797, type:'small_airport'},
  {icao:'SPGL', iata:'CGL', name:"Chagual Airport", city:'', lat:-7.797624, lon:-77.651249, type:'small_airport'},
  {icao:'SPGM', iata:'TGI', name:"Tingo Maria Airport", city:"Tingo Maria", lat:-9.289667, lon:-76.005058, type:'small_airport'},
  {icao:'SPGP', iata:'', name:"G√ºeppi¬≠ Airport", city:'', lat:-0.119056, lon:-75.247902, type:'small_airport'},
  {icao:'SPGS', iata:'', name:"Lagunas Airport", city:"Cajamarca", lat:-6.9, lon:-78.633331, type:'small_airport'},
  {icao:'SPGT', iata:'', name:"Puerto Victoria Airport", city:"Puerto Victoria", lat:-9.90261, lon:-74.964104, type:'small_airport'},
  {icao:'SPGU', iata:'', name:"Bagu√° Airport", city:"Bagu√°", lat:-5.634722, lon:-78.530556, type:'small_airport'},
  {icao:'SPHC', iata:'', name:"Chala Airport", city:"Puerto Chala", lat:-15.80703, lon:-74.28699, type:'small_airport'},
  {icao:'SPHI', iata:'CIX', name:"Capit√°n FAP Jos√© A. Qui√±ones Gonz√°lez International Airport", city:"Chiclayo", lat:-6.789223, lon:-79.828254, type:'large_airport'},
  {icao:'SPHO', iata:'AYP', name:"Air Force Colonel Alfredo Mendivil Duarte Airport", city:"Ayacucho", lat:-13.1548, lon:-74.204399, type:'medium_airport'},
  {icao:'SPHU', iata:'', name:"Huancayo Airport", city:"Huancayo", lat:-12.0699, lon:-75.198502, type:'small_airport'},
  {icao:'SPHV', iata:'', name:"Hu√°nuco Viejo Airport", city:"Hu√°nuco Viejo", lat:-9.92632, lon:-76.233902, type:'small_airport'},
  {icao:'SPHY', iata:'ANS', name:"Andahuaylas Airport", city:"Andahuaylas", lat:-13.7064, lon:-73.350403, type:'small_airport'},
  {icao:'SPHZ', iata:'ATA', name:"Comandante FAP German Arias Graziani Airport", city:"Anta", lat:-9.34744, lon:-77.598396, type:'medium_airport'},
  {icao:'SPID', iata:'', name:"Teniente Bergerie Airport", city:"Iquitos", lat:-3.7422, lon:-73.2604, type:'small_airport'},
  {icao:'SPIL', iata:'UMI', name:"Quincemil Air Base", city:"Quince Mil", lat:-13.231357, lon:-70.75145, type:'small_airport'},
  {icao:'SPIN', iata:'', name:"I√±apari Airport", city:"I√±apari", lat:-10.979, lon:-69.559402, type:'small_airport'},
  {icao:'SPIR', iata:'', name:"Patria Airport", city:"Pillcopata", lat:-12.966295, lon:-71.429936, type:'small_airport'},
  {icao:'SPIS', iata:'', name:"Pias Airport", city:"Pataz", lat:-7.92062, lon:-77.52518, type:'small_airport'},
  {icao:'SPIT', iata:'', name:"Paita Airport", city:"Paita Wesr", lat:-5.08595, lon:-81.152802, type:'small_airport'},
  {icao:'SPIY', iata:'', name:"Yauri Airport", city:"Yauri", lat:-14.796129, lon:-71.431818, type:'small_airport'},
  {icao:'SPIZ', iata:'UCZ', name:"Uchiza Airport", city:"Uchiza", lat:-8.467, lon:-76.349998, type:'small_airport'},
  {icao:'SPJA', iata:'RIJ', name:"Juan Simons Vela Airport", city:"Rioja", lat:-6.06786, lon:-77.160004, type:'medium_airport'},
  {icao:'SPJB', iata:'', name:"Pampa Grande Airport", city:"Pampa Grande", lat:-7.61447, lon:-78.06159, type:'small_airport'},
  {icao:'SPJE', iata:'JAE', name:"Shumba Airport", city:"Ja√©n", lat:-5.59248, lon:-78.774002, type:'medium_airport'},
  {icao:'SPJI', iata:'JJI', name:"Juanjui Airport", city:"Juanju√≠", lat:-7.1691, lon:-76.7286, type:'medium_airport'},
  {icao:'SPJJ', iata:'JAU', name:"Francisco Carle Airport", city:"Jauja", lat:-11.7831, lon:-75.473396, type:'medium_airport'},
  {icao:'SPJL', iata:'JUL', name:"Inca Manco Capac International Airport", city:"Juliaca", lat:-15.467689, lon:-70.15653, type:'large_airport'},
  {icao:'SPJN', iata:'SJA', name:"San Juan de Marcona Airport", city:"San Juan de Marcona", lat:-15.357508, lon:-75.135005, type:'small_airport'},
  {icao:'SPJR', iata:'CJA', name:"Mayor General FAP Armando Revoredo Iglesias Airport", city:"Cajamarca", lat:-7.13918, lon:-78.489403, type:'medium_airport'},
  {icao:'SPKI', iata:'', name:"Kiteni Airport", city:"La Convenci√≥n", lat:-12.648669, lon:-73.036579, type:'small_airport'},
  {icao:'SPLA', iata:'', name:"Luisiana Airport", city:"Luisiana", lat:-12.673815, lon:-73.710266, type:'small_airport'},
  {icao:'SPLC', iata:'', name:"Mariano Melgar Airport", city:"La Joya", lat:-16.7915, lon:-71.886597, type:'small_airport'},
  {icao:'SPLD', iata:'', name:"Celend√≠n Airport", city:"Celend√≠n", lat:-6.8676, lon:-78.149902, type:'small_airport'},
  {icao:'SPLG', iata:'', name:"Lagarto Nuevo Airport", city:"Lagarto", lat:-12.6416, lon:-69.837502, type:'small_airport'},
  {icao:'SPLH', iata:'', name:"Las Dunas Airport", city:"Ica", lat:-14.03561, lon:-75.76004, type:'small_airport'},
  {icao:'SPLN', iata:'RIM', name:"San Nicolas Airport", city:"Rodriguez de Mendoza", lat:-6.39231, lon:-77.501198, type:'small_airport'},
  {icao:'SPLO', iata:'ILQ', name:"General Jorge Fernandez Maldon Airport", city:"Ilo", lat:-17.695, lon:-71.344002, type:'medium_airport'},
  {icao:'SPLP', iata:'', name:"Las Palmas Air Base", city:"Chorrillos", lat:-12.1607, lon:-76.998901, type:'small_airport'},
  {icao:'SPLS', iata:'', name:"Zorrillos Airport", city:"Zorrillos", lat:-8.417, lon:-75.133003, type:'small_airport'},
  {icao:'SPLX', iata:'', name:"Lib Mandi Metropolitan Airport", city:"San Bartolo", lat:-12.38875, lon:-76.75834, type:'small_airport'},
  {icao:'SPME', iata:'TBP', name:"Captain Pedro Canga Rodr√≠guez International Airport", city:"Tumbes", lat:-3.552074, lon:-80.381086, type:'medium_airport'},
  {icao:'SPMF', iata:'MZA', name:"Mayor PNP Nancy Flores Paucar Airport", city:"Mazamari", lat:-11.3254, lon:-74.535598, type:'small_airport'},
  {icao:'SPMS', iata:'YMS', name:"Moises Benzaquen Rengifo Airport", city:"Yurimaguas", lat:-5.89377, lon:-76.118202, type:'medium_airport'},
  {icao:'SPNC', iata:'HUU', name:"Alferez Fap David Figueroa Fernandini Airport", city:"Hu√°nuco", lat:-9.87881, lon:-76.204803, type:'medium_airport'},
  {icao:'SPNH', iata:'', name:"Laguna Choclococha Airport", city:"Choclococha", lat:-13.1657, lon:-75.071999, type:'small_airport'},
  {icao:'SPNM', iata:'', name:"Nuevo Mundo Airport", city:"Nuevo Mundo", lat:-11.5415, lon:-73.142197, type:'small_airport'},
  {icao:'SPNP', iata:'', name:"Ventilla Airport", city:"Ventilla", lat:-15.85131, lon:-70.05871, type:'small_airport'},
  {icao:'SPNR', iata:'', name:"Ricr√°n Airport", city:"Ricr√°n", lat:-10.77795, lon:-76.251312, type:'small_airport'},
  {icao:'SPNT', iata:'', name:"Intuto Airport", city:"Intuto", lat:-3.583, lon:-74.75, type:'small_airport'},
  {icao:'SPNU', iata:'', name:"Manu Airport", city:"Manu", lat:-12.289721, lon:-70.890199, type:'small_airport'},
  {icao:'SPOA', iata:'SQU', name:"Saposoa Airport", city:"Plaza Saposoa", lat:-6.96003, lon:-76.768402, type:'small_airport'},
  {icao:'SPON', iata:'', name:"Orellana Airport", city:"Orellana", lat:-6.896733, lon:-75.153182, type:'small_airport'},
  {icao:'SPOR', iata:'', name:"Orcopampa Airport", city:"Orcopampa", lat:-15.315232, lon:-72.352095, type:'small_airport'},
  {icao:'SPOV', iata:'', name:"Shiringayoc/Hacienda Hda Mejia Airport", city:"Leon Velarde", lat:-11.9, lon:-69.167, type:'small_airport'},
  {icao:'SPOY', iata:'', name:"Atico Airport", city:"Atico", lat:-16.232846, lon:-73.605652, type:'small_airport'},
  {icao:'SPPB', iata:'', name:"Tipishsa Airport", city:"Puerto Breu", lat:-9.53306, lon:-72.756897, type:'small_airport'},
  {icao:'SPPE', iata:'', name:"Palmapampa Airport", city:"Palmapampa", lat:-12.763889, lon:-73.652778, type:'small_airport'},
  {icao:'SPPH', iata:'', name:"Pampa Hermosa Airport", city:"Pampa Hermosa", lat:-7.206774, lon:-75.297559, type:'small_airport'},
  {icao:'SPPL', iata:'', name:"Playa Airport", city:"Trismaje", lat:-8.51782, lon:-76.480499, type:'small_airport'},
  {icao:'SPPN', iata:'', name:"Palmas del Espino Airport", city:"Palmas del Espino", lat:-8.343722, lon:-76.48935, type:'small_airport'},
  {icao:'SPPO', iata:'', name:"Pozuzo Airport", city:"Pozuzo", lat:-10.0701, lon:-75.550003, type:'small_airport'},
  {icao:'SPPP', iata:'', name:"Huanacopampa Airport", city:"Huanacopampa", lat:-14.14334, lon:-72.33455, type:'small_airport'},
  {icao:'SPPY', iata:'CHH', name:"Chachapoyas Airport", city:"Chachapoyas", lat:-6.201911, lon:-77.856195, type:'medium_airport'},
  {icao:'SPPZ', iata:'', name:"Palcaz√∫ Airport", city:"Porvenir", lat:-9.895833, lon:-75.117775, type:'small_airport'},
  {icao:'SPQJ', iata:'', name:"Jaqu√≠ Airport", city:"Jaqu√≠", lat:-15.466667, lon:-74.433334, type:'small_airport'},
  {icao:'SPQM', iata:'', name:"San Lorenzo Airport", city:"San Lorenzo", lat:-4.824369, lon:-76.56032, type:'small_airport'},
  {icao:'SPQR', iata:'', name:"Quiruvilca Airport", city:"Qiruvilca", lat:-7.966667, lon:-78.199997, type:'small_airport'},
  {icao:'SPQT', iata:'IQT', name:"Coronel FAP Francisco Secada Vignetta International Airport", city:"Iquitos", lat:-3.78474, lon:-73.3088, type:'large_airport'},
  {icao:'SPQU', iata:'AQP', name:"Rodr√≠guez Ball√≥n International Airport", city:"Arequipa", lat:-16.340786, lon:-71.569485, type:'large_airport'},
  {icao:'SPRF', iata:'', name:"San Rafael Airport", city:"San Rafael", lat:-14.28201, lon:-70.37989, type:'small_airport'},
  {icao:'SPRG', iata:'', name:"San Regis Airport", city:"Chincha", lat:-13.5113, lon:-76.08398, type:'small_airport'},
  {icao:'SPRL', iata:'', name:"Imperial Airport", city:"Imperial", lat:-12.316667, lon:-75.066666, type:'small_airport'},
  {icao:'SPRM', iata:'', name:"Capit√°n FAP Leonardo Alvari√±o Herr Airport", city:"San Ram√≥n", lat:-11.1286, lon:-75.350502, type:'small_airport'},
  {icao:'SPRR', iata:'', name:"Revalora Airport", city:"San Vicente de Ca√±ete", lat:-13.22283, lon:-76.26927, type:'small_airport'},
  {icao:'SPRU', iata:'TRU', name:"Capit√°n FAP Carlos Mart√≠nez de Pinillos International Airport", city:"Trujillo", lat:-8.082382, lon:-79.108821, type:'large_airport'},
  {icao:'SPSA', iata:'', name:"Casma Airport", city:"Casma", lat:-9.450235, lon:-78.294346, type:'small_airport'},
  {icao:'SPSE', iata:'', name:"Sepahua Airport", city:"Sepahua", lat:-11.14227, lon:-73.034327, type:'small_airport'},
  {icao:'SPSF', iata:'', name:"San Francisco Airport", city:"San Francisco de Yeso", lat:-6.61668, lon:-77.766701, type:'small_airport'},
  {icao:'SPSI', iata:'', name:"Siguas Airport", city:"Siguas", lat:-16.367001, lon:-72.167, type:'small_airport'},
  {icao:'SPSJ', iata:'', name:"San Jos√© de Sisa Airport", city:"El Dorado", lat:-6.61649, lon:-76.6884, type:'small_airport'},
  {icao:'SPSL', iata:'', name:"Lamas Airport", city:"Lamas", lat:-6.416667, lon:-76.533333, type:'small_airport'},
  {icao:'SPSN', iata:'', name:"Shapaja Airport", city:"Shapaja", lat:-6.57972, lon:-76.262802, type:'small_airport'},
  {icao:'SPSO', iata:'PIO', name:"Captain Ren√°n El√≠as Olivera International Airport", city:"Pisco", lat:-13.7449, lon:-76.220299, type:'large_airport'},
  {icao:'SPSS', iata:'', name:"Masisea Airport", city:"Masisea", lat:-8.61142, lon:-74.309962, type:'small_airport'},
  {icao:'SPST', iata:'TPP', name:"Cadete FAP Guillermo Del Castillo Paredes Airport", city:"Tarapoto", lat:-6.50874, lon:-76.373199, type:'medium_airport'},
  {icao:'SPSY', iata:'SYC', name:"Shiringayoc Airport", city:"Shiringayoc", lat:-11.898, lon:-69.0625, type:'small_airport'},
  {icao:'SPTA', iata:'', name:"Nauta Airport", city:"Nauta", lat:-4.54186, lon:-73.562951, type:'small_airport'},
  {icao:'SPTE', iata:'', name:"San Francisco Airport", city:"San Francisco", lat:-12.533, lon:-73.800003, type:'small_airport'},
  {icao:'SPTI', iata:'', name:"Puerto Inca Airport", city:"Puerto Inca", lat:-9.383, lon:-74.967003, type:'small_airport'},
  {icao:'SPTN', iata:'TCQ', name:"Coronel FAP Carlos Ciriani Santa Rosa International Airport", city:"Tacna", lat:-18.053301, lon:-70.275803, type:'medium_airport'},
  {icao:'SPTO', iata:'', name:"Tulpo Airport", city:"Santa Clara de Tulpo", lat:-8.127167, lon:-77.988, type:'small_airport'},
  {icao:'SPTP', iata:'', name:"El Pato Air Base", city:"Talara", lat:-4.54981, lon:-81.224098, type:'small_airport'},
  {icao:'SPTQ', iata:'', name:"Toquepala Airport", city:"Toquepala", lat:-17.2995, lon:-70.652802, type:'small_airport'},
  {icao:'SPTR', iata:'', name:"Tournavista Airport", city:"Tournavista", lat:-8.922406, lon:-74.715234, type:'small_airport'},
  {icao:'SPTU', iata:'PEM', name:"Padre Aldamiz International Airport", city:"Puerto Maldonado", lat:-12.6136, lon:-69.2286, type:'medium_airport'},
  {icao:'SPUC', iata:'', name:"Huamachuco Airport", city:"Huamachuco", lat:-7.81808, lon:-78.02834, type:'small_airport'},
  {icao:'SPUR', iata:'PIU', name:"PAF Captain Guillermo Concha Iberico International Airport", city:"Piura", lat:-5.20575, lon:-80.616402, type:'medium_airport'},
  {icao:'SPVA', iata:'', name:"Hacienda El Valor Airport", city:"El Valor", lat:-5.672621, lon:-78.644257, type:'small_airport'},
  {icao:'SPVI', iata:'', name:"Vicco Airport", city:"Vicco", lat:-10.847844, lon:-76.246956, type:'small_airport'},
  {icao:'SPVL', iata:'', name:"Caraveli Airport", city:"Caraveli", lat:-15.77904, lon:-73.36176, type:'small_airport'},
  {icao:'SPVN', iata:'', name:"Vilcashuam√°n Airport", city:"Vilcashuam√°n", lat:-13.67817, lon:-73.927, type:'small_airport'},
  {icao:'SPVR', iata:'', name:"Vitor Airport", city:"La Joya", lat:-16.429199, lon:-71.837799, type:'small_airport'},
  {icao:'SPWB', iata:'PTL', name:"Walter Braedt Seg√∫ Airport", city:"M√°ncora", lat:-4.08687, lon:-81.02577, type:'small_airport'},
  {icao:'SPWT', iata:'VVN', name:"Las Malvinas/Echarate Airport", city:"Las Malvinas", lat:-11.854861, lon:-72.939332, type:'small_airport'},
  {icao:'SPYA', iata:'', name:"Luya Airport", city:"Luya", lat:-6.6917, lon:-79.701698, type:'small_airport'},
  {icao:'SPYC', iata:'', name:"Yarinacocha Airport", city:"Pucallpa", lat:-8.340436, lon:-74.597906, type:'small_airport'},
  {icao:'SPYL', iata:'TYL', name:"Captain Victor Montes Arias International Airport", city:"Talara", lat:-4.57664, lon:-81.254097, type:'medium_airport'},
  {icao:'SPYO', iata:'', name:"Pacasmayo Airport", city:"Pacasmayo", lat:-7.40694, lon:-79.568901, type:'small_airport'},
  {icao:'SPYU', iata:'', name:"Yauca Airport", city:"Yauca", lat:-15.6189, lon:-74.536102, type:'small_airport'},
  {icao:'SPZA', iata:'NZC', name:"Maria Reiche Neuman Airport", city:"Nazca", lat:-14.854, lon:-74.961502, type:'medium_airport'},
  {icao:'SPZH', iata:'', name:"Pachiza Airport", city:"Pachiza", lat:-7.29928, lon:-76.774597, type:'small_airport'},
  {icao:'SPZO', iata:'CUZ', name:"Alejandro Velasco Astete International Airport", city:"Cusco", lat:-13.5357, lon:-71.938797, type:'large_airport'},
  {icao:'SPZT', iata:'', name:"Chazuta Airport", city:"Chazuta", lat:-6.574167, lon:-76.136665, type:'small_airport'},
];
function llToLocalNM(lat, lon, refLat, refLon){
  const k = Math.cos(refLat * Math.PI/180);
  return { x: (lon - refLon) * k * 60, y: -(lat - refLat) * 60 };
}
function setupAirports(){
  st.radarCenter = { ...CENTER_AIRPORT, label: `${CENTER_AIRPORT.icao}/${CENTER_AIRPORT.iata}` };
  st.airports = AIRPORTS_PE.map(ap=>{
    const p = llToLocalNM(ap.lat, ap.lon, CENTER_AIRPORT.lat, CENTER_AIRPORT.lon);
    return { ...ap, x:p.x, y:p.y };
  });
  if(!window.__uiAptoCfg || typeof window.__uiAptoCfg!=='object'){
  let cfg=null;
  try{ cfg = JSON.parse(localStorage.getItem('setca_apto_cfg_v2')||'null'); }catch(_){ cfg=null; }
  if(!cfg || typeof cfg!=='object') cfg = {};
  const legacy = (localStorage.getItem('setca_showAirports')||'1');
  const enabled = (typeof cfg.enabled==='boolean') ? cfg.enabled : (legacy !== '0');
  const mode = (cfg.mode==='all' || cfg.mode==='major' || cfg.mode==='custom') ? cfg.mode : 'all';
  const custom = Array.isArray(cfg.custom) ? cfg.custom.filter(x=>typeof x==='string') : [];
  window.__uiAptoCfg = { enabled, mode, custom, customSet: new Set(custom) };
}
window.__uiShowAirports = !!window.__uiAptoCfg.enabled && (window.__uiAptoCfg.mode!=='custom' || window.__uiAptoCfg.customSet.size>0);
}
const CONTACT_PERSIST_MS=5000; // ‚Üê 5 seg en anal√≥gico
const INIT_PLANES=[
  {name:'R1',id:'R1',x:-30,y:0,hdg:0, spd:450, tgtSpd:450, alt:20000, tgtAlt:20000, turn:2, tgtHdg:0, ghosts:[], lastDet:0, fail:{comms:false,eng:'none',cab:'none',gear:false,bird:false}, kills:0, fuel:100, jamming:false},
  {name:'R2',id:'R2',x:30,y:0, hdg:45, spd:450, tgtSpd:450, alt:21000, tgtAlt:21000, turn:2, tgtHdg:45, ghosts:[], lastDet:0, fail:{comms:false,eng:'none',cab:'none',gear:false,bird:false}, kills:0, fuel:100, jamming:false},
  {name:'R3',id:'R3',x:0,y:-40,hdg:90, spd:500, tgtSpd:500, alt:22000, tgtAlt:22000, turn:2.5,tgtHdg:90, ghosts:[], lastDet:0, fail:{comms:false,eng:'none',cab:'none',gear:false,bird:false}, kills:0, fuel:100, jamming:false},
];
let st={
  showLabels:true,
  labelMode:0,
  planes: [],
  roles: {R1:'Friend',R2:'Bandit',R3:'Friend'},
  sel: [],
  metric:false,
  paused:false,
  t0:0, elapsed:0,
  windKmh:0, windDir:0,
  sweep:true, sweepAng:0, sweepSpd:24, // ‚Üê m√°s lento
  predMin:5,
  mode:'digital',
  missiles:[],
  splashes:[],
  drawings:[],
  selectedDrawing:null,
  altUnit:'ft',
  pairs:[],
  radarFail:false
};
setupAirports();

// === FORMATION CONSTANTS (sourced) ===
// Line Abreast (Spread): 6000‚Äì9000 ft (~1.0‚Äì1.5 NM) typical mutual support spacing .
// Wall (4-ship line abreast): apply tactical line abreast spacing ~1.5‚Äì3.0 NM .
// Lead‚ÄìTrail: 1.0‚Äì2.0 NM trail spacing minimums 
// Vic/Wedge: 30‚Äì45¬∞ bearing with 0.3‚Äì1.0 NM separation
// Box (two elements line abreast, trailing element 1.5‚Äì3 NM aft) .
// Azimuth split: two groups primarily separated in bearing; we use 8‚Äì12 NM lateral between elements per common BVR practice.
// Range split: two groups primarily separated in range; we use 8‚Äì12 NM longitudinal separation.
// Champagne: two forward groups (line abreast) and one trailing group; forward spacing 1.5‚Äì2.0 NM, trail 1.5‚Äì3.0 NM aft.
const FORM = {
  LA_MIN_NM: 1.0, LA_MAX_NM: 1.5,
  WALL_MIN_NM: 1.5, WALL_MAX_NM: 3.0,
  TRAIL_MIN_NM: 1.0, TRAIL_MAX_NM: 2.0,
  WEDGE_MIN_NM: 0.3, WEDGE_MAX_NM: 1.0,
  BOX_TRAIL_MIN_NM: 1.5, BOX_TRAIL_MAX_NM: 3.0,
  AZI_MIN_NM: 8.0, AZI_MAX_NM: 12.0,
  RNG_MIN_NM: 8.0, RNG_MAX_NM: 12.0,
  FWD_MIN_NM: 1.5, FWD_MAX_NM: 2.0
};
function randNM(a,b){ return a + Math.random()*(b-a); }
function placeAt(cx, cy, hdgDeg, dxNM, dyNM){
  const ang = (hdgDeg-90)*Math.PI/180;
  const x = cx + (dxNM*Math.cos(ang) - dyNM*Math.sin(ang));
  const y = cy + (dxNM*Math.sin(ang) + dyNM*Math.cos(ang));
  return {x,y};
}
function basePlane(name,x,y,hdg){
  const spd = 350 + Math.random()*200;
  const alt = 12000 + Math.random()*16000;
  return { name, id:'F-'+Math.random().toString(36).slice(2,6).toUpperCase(), x,y, hdg, spd, tgtSpd:spd, alt, tgtAlt:alt, tgtHdg:hdg, turn:2, ghosts:[], kills:0, fuel:100, jamming:false };
}

// === FORMATION GENERATORS (FORMACIONES INDEPENDIENTES SIN REQUERIMIENTO DE LIDER)  ===
const GenForm = {
  LINEABREAST2(center){ // two-ship spread
    const s = randNM(FORM.LA_MIN_NM, FORM.LA_MAX_NM);
    const hdg = Math.random()*360;
    const a = placeAt(center.x, center.y, hdg, 0, -s/2);
    const b = placeAt(center.x, center.y, hdg, 0, +s/2);
    return [
      basePlane('LINE-1', a.x,a.y,hdg),
      basePlane('LINE-2', b.x,b.y,hdg),
    ];
  },
  WALL4(center){
    const s = randNM(FORM.WALL_MIN_NM, FORM.WALL_MAX_NM);
    const hdg = Math.random()*360;
    const offs = [-1.5,-0.5,0.5,1.5];
    return offs.map((k,i)=>{
      const p = placeAt(center.x, center.y, hdg, 0, k*s);
      return basePlane('WALL-'+(i+1), p.x, p.y, hdg);
    });
  },
  LEADTRAIL2(center){
    const s = randNM(FORM.TRAIL_MIN_NM, FORM.TRAIL_MAX_NM);
    const hdg = Math.random()*360;
    const lead = placeAt(center.x, center.y, hdg, 0, 0);
    const trail = placeAt(center.x, center.y, hdg, -s, 0);
    return [ basePlane('LT-LEAD', lead.x,lead.y,hdg), basePlane('LT-TRAIL', trail.x,trail.y,hdg) ];
  },
  VIC(center){ // wedge three-ship
    const r = randNM(FORM.WEDGE_MIN_NM, FORM.WEDGE_MAX_NM);
    const hdg = Math.random()*360;
    const lead = placeAt(center.x, center.y, hdg, 0, 0);
    const l = placeAt(center.x, center.y, hdg, r*Math.cos(Math.PI/4), -r*Math.sin(Math.PI/4));
    const rgt = placeAt(center.x, center.y, hdg, r*Math.cos(Math.PI/4), +r*Math.sin(Math.PI/4));
    return [ basePlane('VIC-1', lead.x,lead.y,hdg), basePlane('VIC-2', l.x,l.y,hdg), basePlane('VIC-3', rgt.x,rgt.y,hdg) ];
  },
  BOX4(center){
    const fwdS = randNM(FORM.FWD_MIN_NM, FORM.FWD_MAX_NM);
    const trailS = randNM(FORM.BOX_TRAIL_MIN_NM, FORM.BOX_TRAIL_MAX_NM);
    const hdg = Math.random()*360;
    // Forward element (2-ship line abreast)
    const f1 = placeAt(center.x, center.y, hdg, 0, -fwdS/2);
    const f2 = placeAt(center.x, center.y, hdg, 0, +fwdS/2);
    // Trailing element (2-ship line abreast) trail distance behind
    const t1 = placeAt(center.x, center.y, hdg, -trailS, -fwdS/2);
    const t2 = placeAt(center.x, center.y, hdg, -trailS, +fwdS/2);
    return [
      basePlane('BOX-1', f1.x,f1.y,hdg),
      basePlane('BOX-2', f2.x,f2.y,hdg),
      basePlane('BOX-3', t1.x,t1.y,hdg),
      basePlane('BOX-4', t2.x,t2.y,hdg),
    ];
  },
  AZIMUT2(center){ // two elements separated in bearing
    const s = randNM(FORM.AZI_MIN_NM, FORM.AZI_MAX_NM);
    const hdg = Math.random()*360;
    const a = placeAt(center.x, center.y, hdg, 0, -s/2);
    const b = placeAt(center.x, center.y, hdg, 0, +s/2);
    return [ basePlane('AZ-1', a.x,a.y,hdg), basePlane('AZ-2', b.x,b.y,hdg) ];
  },
  RANGE2(center){ // two elements separated in range
    const s = randNM(FORM.RNG_MIN_NM, FORM.RNG_MAX_NM);
    const hdg = Math.random()*360;
    const lead = placeAt(center.x, center.y, hdg, 0, 0);
    const trail = placeAt(center.x, center.y, hdg, -s, 0);
    return [ basePlane('RANGE-LEAD', lead.x,lead.y,hdg), basePlane('RANGE-TRAIL', trail.x,trail.y,hdg) ];
  },
  CHAMPAGNE(center){
    const fwdS = randNM(FORM.FWD_MIN_NM, FORM.FWD_MAX_NM);
    const trailS = randNM(FORM.BOX_TRAIL_MIN_NM, FORM.BOX_TRAIL_MAX_NM);
    const hdg = Math.random()*360;
    const f1 = placeAt(center.x, center.y, hdg, 0, -fwdS/2);
    const f2 = placeAt(center.x, center.y, hdg, 0, +fwdS/2);
    const t = placeAt(center.x, center.y, hdg, -trailS, 0);
    return [
      basePlane('CHAMP-1', f1.x,f1.y,hdg),
      basePlane('CHAMP-2', f2.x,f2.y,hdg),
      basePlane('CHAMP-3', t.x,t.y,hdg),
    ];
  }
};
function spawnFormation(key){
  const center = { x:(Math.random()*200-100), y:(Math.random()*200-100) };
  let planes = [];
  switch(key){
    case 'LINEABREAST2': planes = GenForm.LINEABREAST2(center); break;
    case 'WALL4': planes = GenForm.WALL4(center); break;
    case 'LEADTRAIL2': planes = GenForm.LEADTRAIL2(center); break;
    case 'VIC': planes = GenForm.VIC(center); break;
    case 'BOX4': planes = GenForm.BOX4(center); break;
    case 'AZIMUT2': planes = GenForm.AZIMUT2(center); break;
    case 'RANGE': planes = GenForm.RANGE2(center); break;
    case 'CHAMPAGNE': planes = GenForm.CHAMPAGNE(center); break;
    default: planes = GenForm.LINEABREAST2(center); break;
  }
  planes.forEach(p=>{ st.planes.push(p); st.roles[p.id] = Math.random()>.5?'Friend':'Bandit'; });
  repaintPlanesList(); repaintNav(); repaintAlt();
}


/* ===== Canvas ===== */
const cvs=$('#radar'),ctx=cvs.getContext('2d'); let W=0,H=0,CX=0,CY=0,zoom=1,offX=0,offY=0;

/* === Pan t√°ctil (mover radar con un dedo) === */
let __touchPan = null;
cvs.addEventListener('touchstart', e=>{
  if(e.touches.length !== 1) return; // evitar conflicto con zoom
  const t = e.touches[0];
  __touchPan = { x:t.clientX, y:t.clientY, ox:offX, oy:offY };
},{passive:true});

cvs.addEventListener('touchmove', e=>{
  if(!__touchPan || e.touches.length !== 1) return;
  e.preventDefault();
const t = e.touches[0];
const sensitivity = 0.4; 
offX = __touchPan.ox + (t.clientX - __touchPan.x) * sensitivity;
offY = __touchPan.oy + (t.clientY - __touchPan.y) * sensitivity;
},{passive:false});

cvs.addEventListener('touchend', ()=>{ __touchPan = null; });

function resize(){W=$('#center').clientWidth;H=$('#center').clientHeight;cvs.width=W;cvs.height=H;CX=W/2;CY=H/2;}
addEventListener('resize',resize);resize();

/* ===== Timer UI ===== */
const timerEl=$('#timer'),stateChip=$('#stateChip'),fpsEl=$('#fps'),simStateEl=$('#simstate');
function tickTimer(){const now=new Date();const s=String(now.getSeconds()).padStart(2,'0');const m=String(now.getMinutes()).padStart(2,'0');const h=String(now.getHours()).padStart(2,'0');const d=String(now.getDate()).padStart(2,'0');const mo=String(now.getMonth()+1).padStart(2,'0');const y=now.getFullYear();timerEl.textContent=`${d}-${mo}-${y} ${h}:${m}:${s}`;}
setInterval(tickTimer,1000);tickTimer();

/* ===== Zoom ultra preciso centrado en el puntero ===== */
const MIN_Z = 0.02, MAX_Z = 15; // l√≠mites de zoom
cvs.addEventListener('wheel', e => {
  e.preventDefault();

  const BASE = 1.01; // suavidad base
  const dy = Math.max(-240, Math.min(240, e.deltaY || 0));
  const f = Math.pow(BASE, -dy / 100); // factor de escala suave

  const newZoom = Math.min(MAX_Z, Math.max(MIN_Z, zoom * f));

  // === Mantener el punto bajo el mouse fijo ===
  const rect = cvs.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  // Coordenadas del mouse en espacio del mundo antes del zoom
  const worldX = (mx - CX - offX) / (zoom * PX_PER_NM);
  const worldY = (my - CY - offY) / (zoom * PX_PER_NM);

  // Cambiar el zoom
  zoom = newZoom;

  // Recalcular offset para que ese punto se mantenga en pantalla
  const newScreenX = worldX * zoom * PX_PER_NM + CX + offX;
  const newScreenY = worldY * zoom * PX_PER_NM + CY + offY;

  offX -= (newScreenX - mx);
  offY -= (newScreenY - my);

}, { passive: false });


  
/* ===== Pan con bot√≥n derecho ===== */
let panning=false, panStart=null, offStart=null;
cvs.addEventListener('contextmenu',e=>e.preventDefault());
cvs.addEventListener('mousedown',e=>{
  if(e.button===2){ // right button
    panning=true; cvs.classList.add('panning');
    panStart={x:e.clientX,y:e.clientY}; offStart={x:offX,y:offY};
  }
});
addEventListener('mousemove',e=>{
  if(panning){ offX = offStart.x + (e.clientX - panStart.x); offY = offStart.y + (e.clientY - panStart.y); }
});
addEventListener('mouseup',()=>{ panning=false; cvs.classList.remove('panning'); });

/* ===== Coord HUD ===== */
cvs.addEventListener('mousemove',e=>{const r=cvs.getBoundingClientRect();const xnm=(e.clientX-r.left-CX-offX)/(zoom*PX_PER_NM);const ynm=(e.clientY-r.top-CY-offY)/(zoom*PX_PER_NM);$('#hud').innerHTML=st.metric?`X: ${(xnm*NM2KM).toFixed(1)} km<br>Y: ${(ynm*NM2KM).toFixed(1)} km`:`X: ${xnm.toFixed(1)} NM<br>Y: ${ynm.toFixed(1)} NM`;});

function toScreen(x,y){return {x:CX+offX+x*zoom*PX_PER_NM,y:CY+offY+y*zoom*PX_PER_NM};}
function toWorld(px,py){return {x:(px-CX-offX)/(zoom*PX_PER_NM),y:(py-CY-offY)/(zoom*PX_PER_NM)};}

/* ===== Anal√≥gico: detecci√≥n por haz ===== */
function sweepDetect(dt){
  if(st.paused||!st.sweep) return;
  st.sweepAng=(st.sweepAng+st.sweepSpd*dt)%360;
  const start=st.sweepAng,width=10;
  st.planes.forEach(p=>{
    const ang=(Math.atan2(p.y,p.x)*180/Math.PI+360)%360;
    let end=(start+width)%360;
    const inSector=start<=end?(ang>=start&&ang<=end):(ang>=start||ang<=end);
    if(inSector) p.lastDet=performance.now();
  });
}

/* ===== Aviones ===== */
function updatePlane(p,dt){
  const acc=40;
  if(p.spd<p.tgtSpd) p.spd=Math.min(p.spd+acc*dt,p.tgtSpd);
  else if(p.spd>p.tgtSpd) p.spd=Math.max(p.spd-acc*dt,p.tgtSpd);
// Giro hacia rumbo objetivo (con sesgo opcional I/D)
const diffCW  = (p.tgtHdg - p.hdg + 360) % 360;   // giro a la derecha (clockwise)
const diffCCW = (p.hdg - p.tgtHdg + 360) % 360;   // giro a la izquierda (counterclockwise)
if (Math.min(diffCW, diffCCW) > 0.1) {
  const tr = (p.turn || 2) * dt;
  if (p.turnBias === 'L') {
    p.hdg -= Math.min(diffCCW, tr);
  } else if (p.turnBias === 'R') {
    p.hdg += Math.min(diffCW, tr);
  } else {
    // Por defecto: giro m√°s corto
    if (diffCW > 180) p.hdg -= Math.min(diffCCW, tr);
    else p.hdg += Math.min(diffCW, tr);
  }
  p.hdg = (p.hdg + 360) % 360;
}
  const climb=200;if(p.alt!==p.tgtAlt){const d=p.tgtAlt-p.alt;const c=climb*dt;if(Math.abs(d)<=c) p.alt=p.tgtAlt; else p.alt+=d>0?c:-c;}
  const nmps=(p.spd/NM2KM)/3600;
  const vrad=(st.windDir-90)*Math.PI/180,wnd=(st.windKmh/NM2KM)/3600;
  const hrad=(p.hdg-90)*Math.PI/180;
  p.x+=Math.cos(hrad)*nmps*dt+Math.cos(vrad)*wnd*dt;
  p.y+=Math.sin(hrad)*nmps*dt+Math.sin(vrad)*wnd*dt;
  p._gt=(p._gt||0)+dt*1000;if(p._gt>1800){p.ghosts.push({x:p.x,y:p.y});if(p.ghosts.length>40)p.ghosts.shift();p._gt=0;}
}
function drawPlane(p){
  const s=toScreen(p.x,p.y);
  // Modo 3: radar anal√≥gico (solo puntos naranjas de contactos detectados por el radar)
  if(st.labelMode===3){
    const age=performance.now()-p.lastDet;
    if(age<CONTACT_PERSIST_MS){ // 5 s
      const fade=1-Math.min(1,age/CONTACT_PERSIST_MS);
      ctx.fillStyle=`rgba(255,153,0,${0.2+0.8*fade})`;
      ctx.beginPath();ctx.arc(s.x,s.y,5,0,2*Math.PI);ctx.fill();
    }
    return;
  }
  const role=st.roles[p.id]||'Neutral';
  const color=role==='Civilian'?'#4de3ff':(role==='Friend'?'#35ff79':(role==='Bandit'?'#ff7070':'#7CFC00'));
  p.ghosts.forEach((g,i)=>{const sg=toScreen(g.x,g.y);const op=(i+1)/p.ghosts.length*.35;ctx.fillStyle=`rgba(179,0,255,${op})`;ctx.fillRect(sg.x-1,sg.y-1,2,2);});
  ctx.save();ctx.translate(s.x,s.y);ctx.rotate(p.hdg*Math.PI/180);ctx.strokeStyle=color;ctx.lineWidth=2;ctx.strokeRect(-5,-5,10,10);ctx.restore();
  const lr=(p.hdg-90)*Math.PI/180;ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+Math.cos(lr)*25,s.y+Math.sin(lr)*25);ctx.strokeStyle='#35ff79';ctx.lineWidth=1;ctx.stroke();
  if(st.predMin>0){const t=st.predMin*60,nmps=(p.spd/NM2KM)/3600;const d=nmps*t;const ex=p.x+Math.cos(lr)*d,ey=p.y+Math.sin(lr)*d;const se=toScreen(ex,ey);ctx.setLineDash([5,5]);ctx.strokeStyle='#2ee74f';ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(se.x,se.y);ctx.stroke();ctx.setLineDash([]);}
  ctx.fillStyle='#eaffea';ctx.font='12px monospace';ctx.textAlign='left';
  // labelMode: 0 = normal (data block), 1 = solo nombre, 2 = sin etiquetas, 3 = radar anal√≥gico
  if(st.labelMode===0 || st.labelMode===1){
    if(p.tagDx===undefined) p.tagDx=12;
    if(p.tagDy===undefined) p.tagDy=-6;

    const bx = s.x + p.tagDx;
    const by = s.y + p.tagDy;

    if(st.labelMode===1){
      // Solo nombre (sin data block)
      ctx.fillText(p.name, bx+2, by);
    } else {
      const w = 88;
      const h = 56;

      // --- connector line (very thin) ---
      ctx.strokeStyle = 'rgba(255,255,255,0.6)';
      ctx.lineWidth = 0.25;
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(bx+4, by+4);
      ctx.stroke();

      // --- transparent box ---
      ctx.strokeStyle = 'rgba(255,255,255,0.8)';
      ctx.lineWidth = 0.4;
      ctx.strokeRect(bx, by-12, w, h);

      // --- text ---
      ctx.fillText(p.name, bx+4, by);
      if(st.metric){
        ctx.fillText(`${(p.alt*FT2M|0)} m`, bx+4, by+14);
        ctx.fillText(`${p.spd.toFixed(0)} km/h`, bx+4, by+28);
        ctx.fillText(`${String(p.hdg|0).padStart(3,'0')}¬∞`, bx+4, by+42);
      } else {
        ctx.fillText(`${p.alt|0} ft`, bx+4, by+14);
        ctx.fillText(`${(p.spd*KMH2KTS).toFixed(0)} kts`, bx+4, by+28);
        ctx.fillText(`${String(p.hdg|0).padStart(3,'0')}¬∞`, bx+4, by+42);
      }
    }
  }
  if(st.sel.includes(p.id)){ctx.strokeStyle='#ffe066';ctx.strokeRect(s.x-10,s.y-10,20,20);}
  if(p.jamming){
    const t=(performance.now()%1000)/1000;const r=10+8*Math.sin(t*2*Math.PI);
    ctx.strokeStyle='rgba(179,0,255,0.85)';ctx.beginPath();ctx.arc(s.x,s.y,r,0,2*Math.PI);ctx.stroke();
    ctx.strokeStyle='rgba(179,0,255,0.45)';ctx.beginPath();ctx.arc(s.x,s.y,r+10,0,2*Math.PI);ctx.stroke();
  }
}

/* ===== Grid + Sweep (CRT) ===== */
function drawAirports(){
  const cfg = window.__uiAptoCfg;
  if(!cfg || !window.__uiShowAirports) return;
  if(!Array.isArray(st.airports) || st.airports.length===0) return;

  ctx.save();
  ctx.lineWidth = 1;

  for(const ap of st.airports){
    // Filtro local (APTO)
    if(cfg.mode==='major'){
      if(!(ap.primary || ap.type==='large_airport' || ap.type==='medium_airport')) continue;
    }else if(cfg.mode==='custom'){
      if(!cfg.customSet || !cfg.customSet.has(ap.icao)) continue;
    }
    const ax = ap.x || 0, ay = ap.y || 0;
    const dist = Math.hypot(ax, ay);
    if(dist > MAX_RANGE_NM * 1.02) continue;

    const s = toScreen(ax, ay);
    const primary = !!ap.primary;
    const closed = (ap.type==='closed');

    ctx.strokeStyle = primary ? 'rgba(255,224,102,.85)' : (closed ? 'rgba(180,180,180,.35)' : 'rgba(46,231,79,.55)');
    ctx.fillStyle   = primary ? 'rgba(255,224,102,.14)' : (closed ? 'rgba(180,180,180,.08)' : 'rgba(46,231,79,.10)');

    // Marcador tipo "fix" (rombo)
    ctx.beginPath();
    ctx.moveTo(s.x,   s.y-4);
    ctx.lineTo(s.x+4, s.y);
    ctx.lineTo(s.x,   s.y+4);
    ctx.lineTo(s.x-4, s.y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // Etiqueta del aeropuerto (independiente del bot√≥n de Etiquetas)
    {
      ctx.save();
      ctx.font = '11px monospace';
      ctx.textAlign = 'left';
      ctx.fillStyle = primary ? '#ffe066' : (closed ? '#bdbdbd' : '#b6f3b6');
      ctx.globalAlpha = primary ? 0.95 : 0.75;
      ctx.fillText(`${ap.icao}${ap.iata?`/${ap.iata}`:''}`, s.x+7, s.y-6);

      if(ap.city){
        ctx.font = '10px monospace';
        ctx.globalAlpha = primary ? 0.80 : 0.55;
        ctx.fillText(ap.city, s.x+7, s.y+6);
      }
      ctx.restore();
    }
  }
  ctx.restore();
}
function drawGrid(){
  const grd=ctx.createLinearGradient(0,0,0,H);grd.addColorStop(0,'#031106');grd.addColorStop(1,'#000');ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
ctx.strokeStyle='#0d2c13';ctx.lineWidth=1;
  for(let r=GRID_STEP_NM;r<=MAX_RANGE_NM;r+=GRID_STEP_NM){
    ctx.beginPath();ctx.arc(CX+offX,CY+offY,r*zoom*PX_PER_NM,0,2*Math.PI);ctx.stroke();
    if(r%50===0){ctx.fillStyle='#164a1f';ctx.font='10px monospace';ctx.textAlign='center';const txt=st.metric?`${(r*NM2KM).toFixed(0)} km`:`${r} NM`;ctx.fillText(txt,CX+offX,CY+offY-r*zoom*PX_PER_NM-4);}
  }
  ctx.strokeStyle='#0e3a17';
  for(let a=0;a<360;a+=30){const rad=(a-90)*Math.PI/180;const ex=CX+offX+Math.cos(rad)*MAX_RANGE_NM*zoom*PX_PER_NM,ey=CY+offY+Math.sin(rad)*MAX_RANGE_NM*zoom*PX_PER_NM;ctx.beginPath();ctx.moveTo(CX+offX,CY+offY);ctx.lineTo(ex,ey);ctx.stroke();}
  // Centro radar (Aeropuerto de referencia)
  if(st.radarCenter){
    ctx.fillStyle = 'rgba(255,224,102,.9)';
    ctx.beginPath(); ctx.arc(CX+offX, CY+offY, 3, 0, 2*Math.PI); ctx.fill();
    if(st.labelMode!==2 && st.labelMode!==3){
      ctx.font='11px monospace';
      ctx.fillStyle='#ffe066';
      ctx.textAlign='left';
      ctx.fillText(st.radarCenter.label || 'CENTRO', CX+offX+7, CY+offY-6);
      if(st.radarCenter.city){
        ctx.font='10px monospace';
        ctx.globalAlpha=0.65;
        ctx.fillText(st.radarCenter.city, CX+offX+7, CY+offY+7);
        ctx.globalAlpha=1;
      }
    }
  }
}
function drawSweep(dt){
  if(st.radarFail) return;
  if(st.sweep){
    st.sweepAng=(st.sweepAng+(st.paused?0:st.sweepSpd*dt))%360;
    const rad=Math.max(W,H)*2;const a=st.sweepAng*Math.PI/180;
    ctx.save();ctx.translate(CX+offX,CY+offY);ctx.rotate(a);
    const g=ctx.createRadialGradient(0,0,0,0,0,rad);g.addColorStop(0,'rgba(46,231,79,.06)');g.addColorStop(.5,'rgba(46,231,79,.22)');g.addColorStop(1,'rgba(46,231,79,.5)');
    ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,rad,0,Math.PI/28);ctx.closePath();ctx.fillStyle=g;ctx.fill();ctx.restore();
  }
}

/* ===== Regla (LEFT click & hold) ===== */
let measuring=false,rA=null,rB=null;
cvs.addEventListener('mousedown',e=>{ if(e.button!==0) return; // block measure when drawing tool is active
  if(e.altKey) return;
  if(tool && tool.tool && tool.tool!=='none') return; // drawing active, skip measuring
  measuring=true; const r=cvs.getBoundingClientRect();
  rA={x:e.clientX-r.left,y:e.clientY-r.top}; rB={...rA};
});
addEventListener('mousemove',e=>{ if(measuring){const r=cvs.getBoundingClientRect(); rB={x:e.clientX-r.left,y:e.clientY-r.top}; }});
addEventListener('mouseup',e=>{ if(measuring){ measuring=false; rA=rB=null; }});

/* ===== Misiles + Splash + Jamming ===== */
function launch(launcherId,targetId,type){
  const L=st.planes.find(p=>p.id===launcherId),T=st.planes.find(p=>p.id===targetId);if(!L||!T) return;
  const missile={id:'MS'+Date.now(),name:type==='R77'?'R-77':'AMRAAM',x:L.x,y:L.y,alt:L.alt,spd:2500,tgt:targetId,launcher:launcherId,rangeKM:type==='R77'?110:90,travKM:0,status:'fly',drift:0};
  st.missiles.push(missile); logEvent(`LANZAMIENTO: ${L.name} lanz√≥ ${missile.name} a ${T.name}`);
}
function updateMissiles(dt){
  st.missiles.forEach(m=>{
    if(m.status!=='fly') return;
    const T=st.planes.find(p=>p.id===m.tgt); if(!T){m.status='lost';return;}
    if(T.jamming && Math.random()<0.25*dt){m.drift+=(Math.random()-0.5)*10;}
    const dx=T.x-m.x,dy=T.y-m.y;let angDeg=(Math.atan2(dy,dx)*180/Math.PI)+m.drift;const ang=angDeg*Math.PI/180;
    const nmps=(m.spd/NM2KM)/3600;const step=nmps*dt; m.travKM+=step*NM2KM; if(m.travKM>=m.rangeKM){m.status='oor';return;}
    const distNM=Math.hypot(dx,dy); if(distNM<1.0){m.status='hit';st.splashes.push({x:T.x,y:T.y,t:0});T._hit=true;logEvent(`SPLASH: ${T.name} destruido`);const L=st.planes.find(p=>p.id===m.launcher);if(L) L.kills=(L.kills||0)+1;return;}
    m.x+=Math.cos(ang)*step; m.y+=Math.sin(ang)*step; m.alt += (T.alt-m.alt)*0.5*dt;
  });
  st.missiles=st.missiles.filter(m=>m.status==='fly');
}
function drawMissiles(){
  st.missiles.forEach(m=>{const s=toScreen(m.x,m.y);const T=st.planes.find(p=>p.id===m.tgt);if(!T)return;const t=toScreen(T.x,T.y);
    ctx.fillStyle='#ffe066';ctx.beginPath();ctx.arc(s.x,s.y,4,0,2*Math.PI);ctx.fill();
    ctx.strokeStyle='#ffe066';ctx.setLineDash([2,4]);ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(t.x,t.y);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='#ffe066';ctx.font='10px monospace';ctx.textAlign='center';ctx.fillText(m.name,s.x,s.y-8);
  });
  st.splashes.forEach(sp=>{sp.t+=1/60;const r=(sp.t*60);const s=toScreen(sp.x,sp.y);ctx.strokeStyle=`rgba(255,100,100,${Math.max(0,1-sp.t)})`;ctx.beginPath();ctx.arc(s.x,s.y,r,0,2*Math.PI);ctx.stroke();});
  st.splashes=st.splashes.filter(sp=>sp.t<1.2);
}

/* ===== Emparejamientos ===== */
function updatePairs(){
  st.pairs.forEach(pr=>{
    const A=st.planes.find(p=>p.id===pr.a),B=st.planes.find(p=>p.id===pr.b); if(!A||!B) return;
    const dx=B.x-A.x,dy=B.y-A.y;const dNM=Math.hypot(dx,dy),dKM=dNM*NM2KM;const ang=(Math.atan2(dx,-dy)*180/Math.PI+360)%360;
    pr.dNM=dNM; pr.dKM=dKM; pr.rel=ang; pr.dAlt=B.alt-A.alt;
  });
}

/* === ASPECT ANGLE 360¬∞ SYSTEM === */
function computeAspectAngle360(target, attacker) {
  const dx = attacker.x - target.x;
  const dy = attacker.y - target.y;
  let los = Math.atan2(dx, -dy) * 180 / Math.PI;
  if (los < 0) los += 360;
  const tailHdg = (target.hdg + 180) % 360;
  let raw = (los - tailHdg + 360) % 360;
  const hemi = raw <= 180 ? 'R' : 'L';
  let aa = raw;
  if (aa > 180) aa = 360 - aa;
  return { aa, hemi };
}
function classifyAspectSector360(AA){
  if (AA >= 340 || AA < 20) return "HOT";
  if (AA >= 300 && AA < 340) return "FLANK LEFT";
  if (AA >= 20 && AA < 60) return "FLANK RIGHT";
  if (AA >= 240 && AA < 300) return "BEAM LEFT";
  if (AA >= 60 && AA < 120) return "BEAM RIGHT";
  if (AA >= 120 && AA < 240) return "COLD";
  return "UNKNOWN";
}
function getAspectCode(sector){
  switch(sector){
    case "HOT": return "(H)";
    case "FLANK LEFT": return "(FL)";
    case "FLANK RIGHT": return "(FR)";
    case "BEAM LEFT": return "(BL)";
    case "BEAM RIGHT": return "(BR)";
    case "COLD": return "(C)";
  }
  return "(?)";
}
function drawPairs(){
  st.pairs.forEach(pr=>{
    const A=st.planes.find(p=>p.id===pr.a),B=st.planes.find(p=>p.id===pr.b); if(!A||!B) return;
    const s1=toScreen(A.x,A.y),s2=toScreen(B.x,B.y);
    ctx.beginPath();ctx.moveTo(s1.x,s1.y);ctx.lineTo(s2.x,s2.y);ctx.strokeStyle='#eaffea';ctx.lineWidth=1;ctx.stroke();
    const midX=(s1.x+s2.x)/2,midY=(s1.y+s2.y)/2;
    const brg=String(Math.round(pr.rel||0)).padStart(3,'0')+'¬∞';
    const dist=st.metric?(pr.dKM||0).toFixed(1)+' KM':(pr.dNM||0).toFixed(1)+' NM';
    const dal=st.metric?((pr.dAlt||0)*FT2M|0)+' m':((pr.dAlt||0)|0)+' ft';
    const BALT = st.metric?((B.alt*FT2M|0)+' m'):((B.alt|0)+' ft');
      const DALT = st.metric?((pr.dAlt*FT2M|0)+' m'):((pr.dAlt|0)+' ft');
      // SNAP logic
      const ownHdg = A.hdg||0;
      const relClock = (((pr.rel - ownHdg)+360)%360);
      const clock = ((Math.round(relClock/30)%12)||12);
      const updown = pr.dAlt>0 ? 'UP' : (pr.dAlt<0 ? 'DOWN' : 'LVL');
      const distVal = st.metric ? pr.dKM : pr.dNM;
      const snapMode = st.metric ? (pr.dKM<=15) : (pr.dNM<=8); // ~15km ‚âà 8nm
      const snapDistNM = st.metric ? (15/NM2KM) : 15; // 15 km or equivalent NM
const snapActive = pr.dNM <= snapDistNM;
// SNAP info = CLOCK / DIST / UP-DOWN
const snapClock = clock;
const snapDistTxt = dist;
const snapUD = updown;
let snapInfo = snapActive ? `${snapClock} / ${snapDistTxt} / ${snapUD}` : 'NY';
const AAinfo = computeAspectAngle360(B, A);
      const AA = Math.round(AAinfo.aa);
      const hemi = AAinfo.hemi;
      const txt = `${brg} / ${dist} / ${BALT} / (${AA}¬∞${hemi}) SNAP (${snapInfo})`;
    ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(midX-95,midY-10,190,20);
    ctx.fillStyle='#eaffea';ctx.font='12px monospace';ctx.textAlign='center';ctx.fillText(txt,midX,midY+5);
  });
}
function repaintPairList(){
  const list=$('#pairList'); list.innerHTML='';
  st.pairs.forEach((pr,idx)=>{
    const A=st.planes.find(x=>x.id===pr.a),B=st.planes.find(x=>x.id===pr.b);
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<span class="badge">${A?A.name:pr.a}</span> ‚Üî <span class="badge">${B?B.name:pr.b}</span>
      <button class="mini btn focusable" data-i="${idx}">Quitar</button>`;
    const btn=row.querySelector('button'); btn.onclick=()=>{ st.pairs.splice(idx,1); repaintPairList(); };
    list.appendChild(row);
  });
}

/* ===== Dibujo ===== */


/* ===== Mapa Per√∫ (desde MAPA DEL PERU.json) ===== */
// Capa visual NO interactiva y NO sincronizada (solo render)
const PERU_MAP_LINES = [
  [395.548,379.84,399.667,377.163],
  [399.541,377.259,405.083,377.834],
  [404.361,377.78,414.774,374.752],
  [414.479,374.778,418.899,374.68],
  [418.899,374.63,422.976,370.848],
  [428.347,365.576,431.825,358.243],
  [432.117,355.493,427.987,340.854],
  [427.995,340.899,429.618,337.495],
  [437.228,338.544,448.921,328.778],
  [442.656,315.969,448.693,320.839],
  [438.27,315.067,449.615,304.324],
  [453.43,300.108,463.671,288.963],
  [466.181,282.588,476.722,278.12],
  [474.082,273.041,476.692,278.111],
  [477.275,264.968,487.264,257.84],
  [477.314,250.492,469.583,252.65],
  [461.591,247.278,469.623,252.75],
  [461.643,247.421,451.88,216.031],
  [463.175,204.121,461.462,199.705],
  [461.367,199.734,469.712,193.177],
  [469.694,193.19,454.224,173.975],
  [454.224,174.084,462.692,153.323],
  [476.841,140.922,478.189,131.483],
  [486.476,131.66,477.307,117.441],
  [478.542,115.878,477.157,114.704],
  [477.166,114.732,480.881,107.434],
  [476.442,105.736,477.68,104.247],
  [477.666,104.239,472.18,98.362],
  [478.127,94.938,484.775,72.974],
  [484.734,73.008,484.183,50.312],
  [484.159,50.347,493.47,39.615],
  [493.494,39.633,491.37,36.843],
  [491.371,36.899,497.11,29.135],
  [443.463,-65.547,398.258,-56.506],
  [398.301,-56.41,388.448,-66.398],
  [378.642,-60.511,386.636,-155.222],
  [386.799,-154.98,337.097,-119.702],
  [337.175,-119.834,289.997,-121.836],
  [290.046,-121.774,280.285,-152.058],
  [228.101,-154.963,183.296,-268.368],
  [201.477,-283.158,194.07,-300.16],
  [235.483,-334.665,248.579,-412.989],
  [248.772,-412.914,318.705,-452.203],
  [318.541,-452.197,421.024,-459.698],
  [420.897,-460.716,376.521,-469.997],
  [376.866,-471.614,400.262,-492.975],
  [399.262,-493.986,373.799,-493.214],
  [373.775,-493.208,415.184,-555.45],
  [415.198,-555.465,358.358,-588.129],
  [315.032,-592.672,281.278,-570.596],
  [281.284,-570.656,246.635,-575.062],
  [246.726,-575.053,211.247,-620.701],
  [215.225,-627.166,166.225,-667.383],
  [133.807,-710.255,85.985,-714.324],
  [86.05,-713.965,114.2,-664.787],
  [114.336,-664.925,100.091,-665.942],
  [90.935,-626.86,68.551,-600.745],
  [32.126,-567.814,-43.167,-542.038],
  [-42.886,-546.631,-73.071,-517.802],
  [-73.146,-517.828,-60.998,-512.043],
  [-61.071,-512.376,-90.574,-446.718],
  [-91.17,-447.98,-103.896,-440.749],
  [-101.582,-439.592,-110.549,-418.767],
  [-126.803,-422.052,-139.498,-449.749],
  [-140.066,-447.685,-148.432,-455.559],
  [-148.539,-455.561,-155.921,-449.328],
  [-155.863,-449.371,-179.91,-463.185],
  [-176.289,-487.966,-185.372,-516.468],
  [-185.111,-516.562,-244.244,-464.978],
  [-179.946,-463.234,-192.527,-454.427],
  [-194.448,-453.694,-195.706,-467.785],
  [-194.803,-481.768,-176.182,-488.059],
  [-244.138,-465.044,-248.919,-440.636],
  [-239.106,-415.976,-229.544,-419.499],
  [-239.205,-408.821,-222.598,-391.711],
  [-222.622,-391.448,-222.873,-370.312],
  [-232.113,-374.557,-222.803,-370.28],
  [-236.618,-369.451,-237.855,-363.677],
  [-237.846,-363.707,-233.646,-356.897],
  [-234.04,-356.714,-216.105,-343.206],
  [-215.921,-343.3,-169.38,-314.127],
  [-169.45,-314.864,-165.477,-306.804],
  [-165.483,-306.819,-144.482,-278.1],
  [-145.494,-275.947,-136.668,-259.435],
  [-138.312,-258.585,-105.458,-216.997],
  [-107.837,-215.627,-95.256,-197.677],
  [-95.253,-197.681,-96.856,-195.277],
  [-96.843,-195.283,-26.235,-49.068],
  [-31.37,-47.288,-26.518,-48.961],
  [-31.916,-43.424,-4.474,-16.316],
  [-4.508,-16.354,-4.842,4.06],
  [-4.849,4.055,19.749,24.47],
  [17.458,29.052,52.096,83.101],
  [52.716,83.246,48.7,106.673],
  [48.74,106.607,42.381,106.607],
  [42.418,106.567,39.573,113.93],
  [41.915,114.751,49.458,116.396],
  [49.483,116.457,50.992,111.246],
  [50.967,111.249,48.361,130.723],
  [48.354,130.707,70.15,158.039],
  [70.031,157.956,95.937,175.658],
  [96.014,175.674,92.302,176.735],
  [92.263,176.699,112.416,200.347],
  [112.183,200.311,182.775,242.364],
  [182.659,242.364,276.782,287.329],
  [277.231,287.391,336.99,341.791],
  [336.64,341.584,366.111,359.29],
  [366.039,359.257,379.892,369.905],
  [379.829,369.811,395.609,379.811],
  [41.91,114.722,39.637,113.881],
  [52.034,83.043,52.72,83.23],
  [19.727,24.451,17.486,29.078],
  [-31.884,-43.409,-31.36,-47.296],
  [-26.519,-48.954,-26.232,-49.056],
  [-107.828,-215.621,-105.456,-217.003],
  [-138.316,-258.58,-136.663,-259.409],
  [-145.496,-275.96,-144.489,-278.099],
  [-169.453,-314.854,-169.378,-314.117],
  [-216.089,-343.21,-215.917,-343.296],
  [-234.043,-356.715,-233.653,-356.901],
  [-236.616,-369.451,-232.142,-374.606],
  [-222.621,-391.441,-222.621,-391.722],
  [-238.922,-416.115,-239.111,-408.756],
  [-229.488,-419.448,-248.923,-440.77],
  [-195.659,-467.792,-194.785,-481.772],
  [-194.39,-453.712,-192.423,-454.443],
  [-140.019,-447.675,-139.533,-449.761],
  [-126.776,-421.999,-125.744,-423.481],
  [-125.793,-423.446,-110.465,-418.792],
  [-103.752,-440.721,-101.649,-439.491],
  [-91.154,-447.994,-90.55,-446.718],
  [-42.894,-546.61,-43.104,-541.933],
  [32.367,-567.906,68.779,-601.057],
  [90.856,-626.871,100.027,-666.135],
  [133.939,-710.411,166.226,-667.395],
  [215.147,-627.191,211.265,-620.591],
  [314.784,-592.642,358.634,-588.176],
  [399.029,-494.04,400.282,-493.005],
  [376.885,-471.624,376.536,-469.985],
  [420.878,-460.772,421.021,-459.628],
  [235.535,-334.831,194.334,-334.25],
  [194.437,-334.28,194.23,-299.921],
  [201.544,-283.237,183.286,-268.399],
  [228.099,-154.92,245.864,-176.964],
  [245.855,-176.969,280.355,-152.012],
  [378.721,-60.557,388.431,-66.332],
  [443.276,-65.607,496.875,29.29],
  [472.18,98.37,478.156,94.926],
  [476.462,105.717,480.894,107.466],
  [477.287,117.391,478.533,115.918],
  [478.181,131.487,486.498,131.666],
  [462.651,153.319,476.863,140.781],
  [463.215,203.998,451.905,216.033],
  [477.242,250.474,487.266,257.846],
  [474.135,273.039,477.453,264.805],
  [466.237,282.577,463.63,289.017],
  [449.609,304.323,453.467,300.027],
  [438.263,315.068,442.682,316.015],
  [448.905,328.754,448.666,320.787],
  [429.613,337.47,437.243,338.556],
  [432.107,355.476,431.833,358.249],
  [422.947,370.869,428.366,365.505]
];

function drawPeruMap(){
  try{
    if(!PERU_MAP_LINES || !PERU_MAP_LINES.length) return;

    ctx.save();
    ctx.setLineDash([]);

    // Mantener visible como los aros del radar (l√≠nea delgada, estilo t√°ctico)
    // Doble trazo sutil para mejorar visibilidad sin ‚Äúgrueso‚Äù
    const wThin = Math.max(0.8, 0.45*zoom);
    const wGlow = Math.max(1.6, 0.8*zoom);

    // Trazo base (muy suave)
    ctx.strokeStyle='rgba(46,231,79,0.10)';
    ctx.lineWidth=wGlow;
    ctx.beginPath();
    for(let i=0;i<PERU_MAP_LINES.length;i++){
      const s=PERU_MAP_LINES[i];
      const a=toScreen(s[0],s[1]);
      const b=toScreen(s[2],s[3]);
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
    }
    ctx.stroke();

    // Trazo principal (delgado)
    ctx.strokeStyle='rgba(46,231,79,0.32)';
    ctx.lineWidth=wThin;
    ctx.beginPath();
    for(let i=0;i<PERU_MAP_LINES.length;i++){
      const s=PERU_MAP_LINES[i];
      const a=toScreen(s[0],s[1]);
      const b=toScreen(s[2],s[3]);
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
    }
    ctx.stroke();

    ctx.restore();
  }catch(e){ /* silent */ }
}



const tool={tool:'none',drawing:false,a:null,b:null,poly:[]};

function drawShapes(){
  st.drawings.forEach(d=>{
    ctx.save();

    // === NUEVO: color militar amarillo ===
    ctx.strokeStyle = d.color || '#ffea00';
    ctx.fillStyle   = d.color || '#ffea00';

    // === NUEVO: l√≠neas m√°s delgadas estilo radar militar ===
    ctx.lineWidth = (d.id === st.selectedDrawing ? 1.0 : 0.6);

    const s = toScreen(d.x, d.y);

    // --- BULLSEYE ---
    if(d.type === 'bullseye'){
      [4,8,12].forEach(r=>{
        ctx.beginPath();
        ctx.arc(s.x, s.y, r, 0, 2*Math.PI);
        ctx.stroke();
      });

      ctx.beginPath();
      ctx.moveTo(s.x - 12, s.y);
      ctx.lineTo(s.x + 12, s.y);
      ctx.moveTo(s.x, s.y - 12);
      ctx.lineTo(s.x, s.y + 12);
      ctx.stroke();
    }

    // --- PUNTO ---
    if(d.type === 'point'){
      // Puntito sutil blanco
      ctx.fillStyle = d.dotColor || d.color || 'rgba(255,255,255,0.75)';
      ctx.beginPath();
      ctx.arc(s.x, s.y, 2.2, 0, 2*Math.PI);
      ctx.fill();
    }

    // --- L√çNEA ---
    if(d.type === 'line'){
      const e = toScreen(d.ex, d.ey);
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(e.x, e.y);
      ctx.stroke();
    }

    
    // --- ARWY (l√≠nea entrecortada m√°s delgada) ---
    if(d.type === 'arwy' && d.ex!==undefined){
      const e = toScreen(d.ex, d.ey);
      ctx.setLineDash([2,6]);
      ctx.lineWidth = (d.id === st.selectedDrawing ? 0.8 : 0.4);
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(e.x, e.y);
      ctx.stroke();
      ctx.setLineDash([]);
    }

// --- C√çRCULO ---
    if(d.type === 'circle'){
      ctx.beginPath();
      ctx.arc(s.x, s.y, d.r * zoom * PX_PER_NM, 0, 2*Math.PI);
      ctx.stroke();
    }

    // --- CUADRADO ---
    if(d.type === 'square'){
      const a = d.a * zoom * PX_PER_NM;
      ctx.strokeRect(s.x - a/2, s.y - a/2, a, a);
    }

    // --- POL√çGONO ---
    if(d.type === 'polygon' && Array.isArray(d.pts) && d.pts.length >= 2){
      ctx.beginPath();
      const p0 = toScreen(d.pts[0].x, d.pts[0].y);
      ctx.moveTo(p0.x, p0.y);
      for(let i=1;i<d.pts.length;i++){
        const pi = toScreen(d.pts[i].x, d.pts[i].y);
        ctx.lineTo(pi.x, pi.y);
      }
      ctx.closePath();
      ctx.stroke();
    }

    // --- LABEL ---
    if(d.type === 'label'){
      ctx.font = 'bold 14px monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = '#221a00';
      ctx.shadowBlur = 5;
      ctx.fillText(d.text, s.x, s.y);
      ctx.shadowBlur = 0;
    }


    // --- NOMBRE (delgado) ---
    // Se muestra para todos los gr√°ficos excepto Punto (solo punto) y Etiqueta (ya tiene texto).
    if(d.name && d.type!=='label' && (d.type!=='point' || d.showName)){
      let nx=d.x, ny=d.y;
      if((d.type==='line' || d.type==='arwy') && d.ex!==undefined){ nx=(d.x+d.ex)/2; ny=(d.y+d.ey)/2; }
      else if(d.type==='polygon' && Array.isArray(d.pts) && d.pts.length>=3){
        try{ const c=polyCentroid(d.pts); nx=c.x; ny=c.y; }catch(_){}
      }
      const ns = toScreen(nx, ny);
      ctx.save();
      ctx.font = '12px monospace';          // letras delgadas (no bold)
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = d.color || '#ffea00';
      ctx.fillText(d.name, ns.x, ns.y - 8);
      ctx.restore();
    }

    ctx.restore();
  });

  // === DIBUJO TEMPORAL (l√≠neas punteadas) ===
  if(tool.drawing){
    ctx.save();

    // amarillo militar
    ctx.strokeStyle = '#ffea00';
    if(tool.tool === 'arwy'){
      ctx.setLineDash([2,6]);
      ctx.lineWidth = 0.45;
    }else{
      ctx.setLineDash([4,4]);
      ctx.lineWidth = 0.6;
    }

    if(tool.tool === 'polygon'){
      const pts = Array.isArray(tool.poly) ? tool.poly : [];
      if(pts.length){
        ctx.beginPath();
        const p0 = toScreen(pts[0].x, pts[0].y);
        ctx.moveTo(p0.x, p0.y);
        for(let i=1;i<pts.length;i++){
          const pi = toScreen(pts[i].x, pts[i].y);
          ctx.lineTo(pi.x, pi.y);
        }
        if(tool.b){
          const pb = toScreen(tool.b.x, tool.b.y);
          ctx.lineTo(pb.x, pb.y);
        }
        ctx.stroke();
      }
    } else if(tool.a && tool.b){
      const s = toScreen(tool.a.x, tool.a.y);
      const e = toScreen(tool.b.x, tool.b.y);

      if(tool.tool === 'line' || tool.tool === 'arwy'){
        ctx.beginPath();
        ctx.moveTo(s.x, s.y);
        ctx.lineTo(e.x, e.y);
        ctx.stroke();
      } else if(tool.tool === 'circle'){
        const r = Math.hypot(tool.b.x - tool.a.x, tool.b.y - tool.a.y) * zoom * PX_PER_NM;
        ctx.beginPath();
        ctx.arc(s.x, s.y, r, 0, 2*Math.PI);
        ctx.stroke();
      } else if(tool.tool === 'square'){
        const side = Math.max(Math.abs(tool.b.x - tool.a.x), Math.abs(tool.b.y - tool.a.y));
        const cx = tool.a.x + (tool.b.x - tool.a.x)/2;
        const cy = tool.a.y + (tool.b.y - tool.a.y)/2;
        const c  = toScreen(cx, cy);
        const a  = side * zoom * PX_PER_NM;
        ctx.strokeRect(c.x - a/2, c.y - a/2, a, a);
      }
    }


    // === MEDIDAS EN VIVO (solo mientras dibujas) ===
    // Siempre en km (desaparece al soltar click porque tool.drawing pasa a false)
    try{
      let measureTxt = '';
      if(tool.tool === 'polygon'){
        const pts = Array.isArray(tool.poly) ? tool.poly : [];
        if(pts.length >= 1 && tool.b){
          // Per√≠metro parcial: suma de segmentos + segmento al cursor
          let perNM = 0;
          for(let i=1;i<pts.length;i++){
            perNM += Math.hypot(pts[i].x-pts[i-1].x, pts[i].y-pts[i-1].y);
          }
          if(pts.length >= 1){
            const last = pts[pts.length-1];
            perNM += Math.hypot(tool.b.x-last.x, tool.b.y-last.y);
          }
          measureTxt = `Per√≠metro: ${(perNM * NM2KM).toFixed(2)} km`;
        }
      } else if(tool.a && tool.b){
        const dx = tool.b.x - tool.a.x;
        const dy = tool.b.y - tool.a.y;
        const distNM = Math.hypot(dx, dy);
        if(tool.tool === 'line' || tool.tool === 'arwy'){
          measureTxt = `Distancia: ${(distNM * NM2KM).toFixed(2)} km`;
        } else if(tool.tool === 'circle'){
          measureTxt = `Radio: ${(distNM * NM2KM).toFixed(2)} km`;
        } else if(tool.tool === 'square'){
          const sideNM = Math.max(Math.abs(dx), Math.abs(dy));
          measureTxt = `Lado: ${(sideNM * NM2KM).toFixed(2)} km`;
        }
      }

      if(measureTxt){
        // Ancla cerca del cursor (tool.b)
        const anchor = tool.b ? toScreen(tool.b.x, tool.b.y) : (tool.a ? toScreen(tool.a.x, tool.a.y) : {x:20,y:20});
        const x = anchor.x + 10;
        const y = anchor.y - 10;

        ctx.save();
        ctx.setLineDash([]);
        ctx.font = '12px system-ui';
        ctx.textBaseline = 'bottom';

        const pad = 5;
        const tw = ctx.measureText(measureTxt).width;
        const bw = tw + pad*2;
        const bh = 18;

        ctx.fillStyle = 'rgba(0,0,0,0.72)';
        ctx.fillRect(x - pad, y - bh, bw, bh);

        ctx.strokeStyle = '#ffea00';
        ctx.lineWidth = 1;
        ctx.strokeRect(x - pad, y - bh, bw, bh);

        ctx.fillStyle = '#ffea00';
        ctx.fillText(measureTxt, x, y - 4);
        ctx.restore();
      }
    }catch(_){}

    ctx.restore();
  }
}


function polyCentroid(pts){
  let sx=0, sy=0;
  const n = (pts && pts.length) ? pts.length : 0;
  if(!n) return {x:0, y:0};
  for(const p of pts){ sx += (p.x||0); sy += (p.y||0); }
  return {x:sx/n, y:sy/n};
}

function pickShape(wx, wy){
  const tol = 10/(zoom*PX_PER_NM);
  for(let i = (st.drawings||[]).length - 1; i >= 0; i--){
    const d = st.drawings[i];
    if(!d) continue;

    if(d.type === 'line' && d.ex!==undefined){
      const dx = d.ex - d.x, dy = d.ey - d.y;
      if(dx===0 && dy===0) continue;
      const t = ((wx-d.x)*dx + (wy-d.y)*dy) / (dx*dx + dy*dy);
      if(t>=0 && t<=1){
        const dd = Math.hypot(wx - (d.x + t*dx), wy - (d.y + t*dy));
        if(dd < tol) return d.id;
      }
      continue;
    }

    // resto: aproximaci√≥n por centro (tolerancia por tipo)
    let hr = tol;
    if(d.type==='circle') hr = (d.r||0);
    else if(d.type==='square') hr = ((d.a||0)/2);
    else if(d.type==='label') hr = (20/zoom);
    else if(d.type==='bullseye') hr = (12/zoom);
    if(Math.hypot(wx-(d.x||0), wy-(d.y||0)) < hr + tol) return d.id;
  }
  return null;
}

function __distPointToSegPx(px,py,x1,y1,x2,y2){
  const vx=x2-x1, vy=y2-y1;
  const wx=px-x1, wy=py-y1;
  const c1 = vx*wx + vy*wy;
  if(c1<=0) return Math.hypot(px-x1,py-y1);
  const c2 = vx*vx + vy*vy;
  if(c2<=c1) return Math.hypot(px-x2,py-y2);
  const t = c1/c2;
  const ix = x1 + t*vx, iy = y1 + t*vy;
  return Math.hypot(px-ix,py-iy);
}

function __pointInPolyPx(px, py, poly){
  let inside = false;
  for(let i=0, j=poly.length-1; i<poly.length; j=i++){
    const xi=poly[i].x, yi=poly[i].y;
    const xj=poly[j].x, yj=poly[j].y;
    const intersect = ((yi>py) !== (yj>py)) && (px < (xj-xi)*(py-yi)/( (yj-yi)||1e-9 ) + xi);
    if(intersect) inside = !inside;
  }
  return inside;
}

function __hitDrawingPx(d, px, py, tolPx){
  const s = toScreen(d.x, d.y);

  if(d.type==='point'){
    return Math.hypot(px-s.x, py-s.y) <= (4 + tolPx);
  }

  if((d.type==='line' || d.type==='arwy') && d.ex!==undefined){
    const e = toScreen(d.ex, d.ey);
    return __distPointToSegPx(px,py,s.x,s.y,e.x,e.y) <= tolPx;
  }

  if(d.type==='circle' && d.r!==undefined){
    const rpx = d.r * zoom * PX_PER_NM;
    const dist = Math.hypot(px-s.x, py-s.y);
    return dist <= (rpx + tolPx);
  }

  if(d.type==='square' && d.a!==undefined){
    const half = (d.a * zoom * PX_PER_NM)/2;
    const dx = Math.abs(px - s.x), dy = Math.abs(py - s.y);
    return (dx <= half + tolPx && dy <= half + tolPx);
  }

  if(d.type==='polygon' && Array.isArray(d.pts) && d.pts.length>=3){
    const poly = d.pts.map(p=>toScreen(p.x,p.y));
    if(__pointInPolyPx(px,py,poly)) return true;
    let best=1e9;
    for(let i=0;i<poly.length;i++){
      const A=poly[i], B=poly[(i+1)%poly.length];
      const dd=__distPointToSegPx(px,py,A.x,A.y,B.x,B.y);
      if(dd<best) best=dd;
    }
    return best <= tolPx;
  } else if(d.type==='polygon' && Array.isArray(d.pts) && d.pts.length>=2){
    let best=1e9;
    for(let i=0;i<d.pts.length;i++){
      const a=d.pts[i], b=d.pts[(i+1)%d.pts.length];
      const A=toScreen(a.x,a.y), B=toScreen(b.x,b.y);
      const dd=__distPointToSegPx(px,py,A.x,A.y,B.x,B.y);
      if(dd<best) best=dd;
    }
    return best <= tolPx;
  }

  if(d.type==='bullseye'){
    const dist=Math.hypot(px-s.x, py-s.y);
    if(dist <= 12 + tolPx) return true;
    if(Math.abs(px-s.x)<=tolPx && Math.abs(py-s.y)<=12+tolPx) return true;
    if(Math.abs(py-s.y)<=tolPx && Math.abs(px-s.x)<=12+tolPx) return true;
    return false;
  }

  if(d.type==='label'){
    try{
      ctx.save();
      ctx.font = 'bold 14px monospace';
      const t = d.text || '';
      const w = ctx.measureText(t).width;
      const h = 16;
      ctx.restore();
      const left = s.x - w/2 - tolPx, right = s.x + w/2 + tolPx;
      const top = s.y - h/2 - tolPx, bottom = s.y + h/2 + tolPx;
      return px>=left && px<=right && py>=top && py<=bottom;
    }catch(_){
      return Math.hypot(px-s.x, py-s.y) <= (10 + tolPx);
    }
  }

  return Math.hypot(px-s.x, py-s.y) <= (tolPx);
}

function pickShapePrecisePx(px, py, tolPx=7){
  for(let i = (st.drawings||[]).length - 1; i >= 0; i--){
    const d = st.drawings[i];
    if(d && __hitDrawingPx(d, px, py, tolPx)) return d.id;
  }
  return null;
}

function __findDrawingById(id){
  return (st.drawings||[]).find(d=>d.id===id) || null;
}

/* ===== ALT arrastra avi√≥n / dibujo ===== */

let draggingPlane=null,draggingDrawing=null,dragStart=null;

// ===== D + CLICK: arrastrar gr√°ficos (dibujos) =====
let __dDown = false;
addEventListener('keydown', (e)=>{ if(e.key==='d' || e.key==='D') __dDown = true; });
addEventListener('keyup',   (e)=>{ if(e.key==='d' || e.key==='D') __dDown = false; });

// Captura primero para no interferir con otras interacciones
// 1) Doble click para SELECCIONAR (m√°s preciso)
// 2) Con dibujo seleccionado: mantener "D" + click/arrastrar para MOVER
// 3) Click derecho: men√∫ (Eliminar / Cambiar nombre)
(function(){
  const SEL_TOL_PX = 6; // selecci√≥n m√°s precisa (menos "radio" amplio)
  let __ctx = null;
  let __ctxTargetId = null;

  function ensureCtxMenu(){
    if(__ctx) return __ctx;
    __ctx = document.getElementById('drawingCtxMenu');
    if(!__ctx){
      __ctx = document.createElement('div');
      __ctx.id = 'drawingCtxMenu';
      __ctx.innerHTML = `
        <button class="ctxItem" data-act="rename">Cambiar nombre</button>
        <button class="ctxItem" data-act="delete">Eliminar gr√°fico</button>
      `;
      document.body.appendChild(__ctx);
    }
    __ctx.style.display = 'none';
    __ctx.addEventListener('click',(ev)=>{
      const b = ev.target.closest('button[data-act]');
      if(!b) return;
      const act = b.getAttribute('data-act');
      const id = __ctxTargetId;
      const d = id ? __findDrawingById(id) : null;

      if(act==='delete' && id){
        if(st && Array.isArray(st.drawings)){
          st.drawings = st.drawings.filter(x=>x.id!==id);
          if(st.selectedDrawing===id) st.selectedDrawing = null;
        }
        hideCtx();
        if(typeof repaintNav==='function') repaintNav();
        if(typeof repaintAlt==='function') repaintAlt();
        if(typeof repaintPairs==='function') repaintPairs();
        if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function') window._SETCA_SYNC.push();
      }

      if(act==='rename' && d){
        const cur = d.name || '';
        const nn = prompt('Nuevo nombre del gr√°fico:', cur);
        if(nn!==null){
          const t = (nn||'').trim();
          d.name = t ? t : null;
        }
        hideCtx();
        if(typeof repaintNav==='function') repaintNav();
        if(typeof repaintAlt==='function') repaintAlt();
        if(typeof repaintPairs==='function') repaintPairs();
        if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function') window._SETCA_SYNC.push();
      }
    });
    return __ctx;
  }

  function hideCtx(){
    const m = ensureCtxMenu();
    m.style.display = 'none';
    __ctxTargetId = null;
  }

  function showCtx(clientX, clientY, id){
    const m = ensureCtxMenu();
    __ctxTargetId = id;

    // clamp dentro de ventana
    const pad = 8;
    m.style.display = 'block';
    m.style.left = '0px';
    m.style.top  = '0px';
    const rect = m.getBoundingClientRect();
    const x = Math.min(window.innerWidth - rect.width - pad, Math.max(pad, clientX));
    const y = Math.min(window.innerHeight - rect.height - pad, Math.max(pad, clientY));
    m.style.left = x + 'px';
    m.style.top  = y + 'px';
  }

  // Ocultar men√∫ al click en cualquier parte
  document.addEventListener('mousedown', (e)=>{
    const m = ensureCtxMenu();
    if(m.style.display==='none') return;
    if(!m.contains(e.target)) hideCtx();
  }, true);

  // Selecci√≥n precisa por doble click
  cvs.addEventListener('dblclick', (e)=>{
    if(tool && tool.tool && tool.tool !== 'none') return;
    const r = cvs.getBoundingClientRect();
    const px = e.clientX - r.left, py = e.clientY - r.top;
    const hit = pickShapePrecisePx(px, py, SEL_TOL_PX);
    if(hit){
      st.selectedDrawing = hit;
    }else{
      st.selectedDrawing = null;
    }
    hideCtx();
  }, true);

  // Men√∫ contextual (click derecho) sobre el gr√°fico
  cvs.addEventListener('contextmenu', (e)=>{
    if(tool && tool.tool && tool.tool !== 'none') return;
    const r = cvs.getBoundingClientRect();
    const px = e.clientX - r.left, py = e.clientY - r.top;
    const hit = pickShapePrecisePx(px, py, SEL_TOL_PX);
    if(!hit){ hideCtx(); return; }
    e.preventDefault();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation(); else e.stopPropagation();
    st.selectedDrawing = hit;
    showCtx(e.clientX, e.clientY, hit);
  }, true);

  // D + click/arrastrar para mover gr√°fico (sin necesidad de preseleccionar)
  cvs.addEventListener('mousedown', (e)=>{
    if(e.button!==0) return;
    if(!__dDown) return;
    if(tool && tool.tool && tool.tool !== 'none') return;

    const r = cvs.getBoundingClientRect();
    const px = e.clientX - r.left, py = e.clientY - r.top;
    const hit = pickShapePrecisePx(px, py, SEL_TOL_PX);
    if(!hit) return;

    const d = __findDrawingById(hit);
    if(!d) return;
    st.selectedDrawing = hit;

    e.preventDefault();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation(); else e.stopPropagation();

    draggingDrawing = d;
    dragStart = {x:e.clientX, y:e.clientY};
    hideCtx();
  }, true);

})();

cvs.addEventListener('mousedown',e=>{
  if(e.button!==0 || !e.altKey) return;
  const r=cvs.getBoundingClientRect();const wx=toWorld(e.clientX-r.left,e.clientY-r.top).x;const wy=toWorld(e.clientX-r.left,e.clientY-r.top).y;
  const hit=null; // ALT: solo mover aeronaves, no dibujos if(hit){st.selectedDrawing=hit;draggingDrawing=st.drawings.find(d=>d.id===hit);dragStart={x:e.clientX,y:e.clientY};return;}
  let best=null,bd=1e9;st.planes.forEach(p=>{const d=Math.hypot(wx-p.x,wy-p.y);if(d<15/zoom && d<bd){bd=d;best=p;}});
  if(best){draggingPlane=best;dragStart={x:e.clientX,y:e.clientY};}
});
addEventListener('mousemove',e=>{
  if(draggingDrawing){
  const dx=(e.clientX-dragStart.x)/(zoom*PX_PER_NM), dy=(e.clientY-dragStart.y)/(zoom*PX_PER_NM);
  draggingDrawing.x+=dx; draggingDrawing.y+=dy;
  if(draggingDrawing.ex!==undefined){ draggingDrawing.ex+=dx; draggingDrawing.ey+=dy; }
  if(draggingDrawing.type==='polygon' && Array.isArray(draggingDrawing.pts)){
    draggingDrawing.pts.forEach(p=>{ p.x+=dx; p.y+=dy; });
  }
  dragStart={x:e.clientX,y:e.clientY};
}
  if(draggingPlane){const r=cvs.getBoundingClientRect();const w=toWorld(e.clientX-r.left,e.clientY-r.top);const sw=toWorld(dragStart.x-r.left,dragStart.y-r.top);draggingPlane.x+=w.x-sw.x;draggingPlane.y+=w.y-sw.y;dragStart={x:e.clientX,y:e.clientY};}
});
addEventListener('mouseup',()=>{
  const movedPlane = draggingPlane;
  const movedDrawing = draggingDrawing;
  draggingPlane=null; draggingDrawing=null; dragStart=null;
  if((movedPlane||movedDrawing)){
    if(typeof repaintNav==='function') repaintNav();
    if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function') window._SETCA_SYNC.push();
  }
});


// ==== DRAW EDITOR BINDINGS ====
(function(){
  const toolBtns = Array.from($$('#pDraw .tool'));

  function setDrawTool(name){
    tool.tool = name || 'none';
    tool.drawing = false;
    tool.a = null;
    tool.b = null;
    tool.poly = [];

    // (solo visual) evita que se vea "apretado" por focus
    toolBtns.forEach(btn=>{
      btn.classList.toggle('active', btn.getAttribute('data-tool') === tool.tool && tool.tool !== 'none');
    });
  }

  function resetDrawTool(){
    setDrawTool('none');
    try{ if(document.activeElement) document.activeElement.blur(); }catch(_){}
    try{ cvs.focus && cvs.focus({preventScroll:true}); }catch(_){}
  }

  function polyCentroid(pts){
    let sx=0, sy=0;
    pts.forEach(p=>{ sx+=p.x; sy+=p.y; });
    return {x: sx/pts.length, y: sy/pts.length};
  }

  // Set tool when clicking buttons
  toolBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      setDrawTool(b.getAttribute('data-tool'));
    });
  });

  // Polygon: click to add vertices, double-click to finish
  cvs.addEventListener('mousedown', e=>{
    if(e.button!==0 || e.altKey) return;
    if(tool.tool==='none') return;

    const r=cvs.getBoundingClientRect();
    const w=toWorld(e.clientX-r.left, e.clientY-r.top);

    if(tool.tool==='polygon'){
      tool.poly = Array.isArray(tool.poly) ? tool.poly : [];
      tool.poly.push({x:w.x, y:w.y});
      tool.a = tool.poly[0];
      tool.b = {x:w.x, y:w.y};
      tool.drawing = true;
      return;
    }

    // Other tools: click-drag
    tool.a = {x:w.x, y:w.y};
    tool.b = {x:w.x, y:w.y};
    tool.drawing = true;
  });

  addEventListener('mousemove', e=>{
    // Polygon preview follows mouse even without holding button
    if(tool.tool==='polygon' && Array.isArray(tool.poly) && tool.poly.length){
      const r=cvs.getBoundingClientRect();
      const w=toWorld(e.clientX-r.left, e.clientY-r.top);
      tool.b = {x:w.x, y:w.y};
      tool.drawing = true;
      return;
    }

    if(e.buttons!==1) return;
    if(!tool.drawing || !tool.a) return;
    const r=cvs.getBoundingClientRect();
    const w=toWorld(e.clientX-r.left, e.clientY-r.top);
    tool.b = {x:w.x, y:w.y};
  });

  addEventListener('dblclick', e=>{
    if(tool.tool!=='polygon') return;
    if(!Array.isArray(tool.poly) || tool.poly.length < 3) return;
    e.preventDefault();

    const pts = tool.poly.slice(0);
    const c = polyCentroid(pts);
    const id='D-'+Math.random().toString(36).slice(2,6).toUpperCase();
    st.drawings.push({id,type:'polygon',x:c.x,y:c.y,pts});
    ensureDrawingName(st.drawings[st.drawings.length-1]);
    st.selectedDrawing = id;

    resetDrawTool(); // vuelve a la regla
  }, true);

  addEventListener('mouseup', e=>{
    // Polygon finaliza con doble click (arriba)
    if(tool.tool==='polygon') return;

    if(!tool.drawing || !tool.a || !tool.b) return;
    const a=tool.a, b=tool.b;
    tool.drawing=false;

    const id='D-'+Math.random().toString(36).slice(2,6).toUpperCase();
    let created = false;

    if(tool.tool==='point'){
      st.drawings.push({id,type:'point',x:a.x,y:a.y}); created = true;
} else if(tool.tool==='line'){
      st.drawings.push({id,type:'line',x:a.x,y:a.y,ex:b.x,ey:b.y}); created = true;
      ensureDrawingName(st.drawings[st.drawings.length-1]);
    } else if(tool.tool==='arwy'){
      st.drawings.push({id,type:'arwy',x:a.x,y:a.y,ex:b.x,ey:b.y}); created = true;
      ensureDrawingName(st.drawings[st.drawings.length-1]);
    } else if(tool.tool==='circle'){
      const r=Math.hypot(b.x-a.x,b.y-a.y);
      st.drawings.push({id,type:'circle',x:a.x,y:a.y,r}); created = true;
      ensureDrawingName(st.drawings[st.drawings.length-1]);
    } else if(tool.tool==='square'){
      const side=Math.max(Math.abs(b.x-a.x),Math.abs(b.y-a.y));
      const cx=a.x+(b.x-a.x)/2, cy=a.y+(b.y-a.y)/2;
      st.drawings.push({id,type:'square',x:cx,y:cy,a:side}); created = true;
      ensureDrawingName(st.drawings[st.drawings.length-1]);
    } else if(tool.tool==='bullseye'){
      st.drawings.push({id,type:'bullseye',x:a.x,y:a.y}); created = true;
      ensureDrawingName(st.drawings[st.drawings.length-1]);
    } else if(tool.tool==='label'){
      const text=prompt('Texto de etiqueta:');
      if(text){ st.drawings.push({id,type:'label',x:a.x,y:a.y,text}); created = true;
        ensureDrawingName(st.drawings[st.drawings.length-1]);
      }
    }

    if(created) st.selectedDrawing = id;

    // Soltar herramienta (vuelve a la regla)
    resetDrawTool();
  });

  // Place button uses numeric inputs (y luego vuelve a la regla)
  // Crear punto por coordenadas geogr√°ficas (Lat/Lon en DMS o decimal)
  function __parseCoordDMS(val, isLat){
    if(val===null || val===undefined) return null;
    let s0 = String(val).trim();
    if(!s0) return null;

    // Normaliza: may√∫sculas, decimal con punto, y soporta OESTE/ESTE
    let s = s0.toUpperCase().replace(/,/g,'.');
    s = s.replace(/OESTE/g,'W').replace(/ESTE/g,'E');

    // Decimal puro (opcional hemisferio al final)
    const dec = s.match(/^\s*([-+]?\d+(?:\.\d+)?)\s*([NSEWO])?\s*$/);
    if(dec){
      let n = parseFloat(dec[1]);
      if(!isFinite(n)) return null;
      let sign = (n<0) ? -1 : 1;
      n = Math.abs(n);
      let hemi = dec[2] ? dec[2].toUpperCase() : null;
      if(hemi==='O') hemi='W';
      if(hemi){
        if(hemi==='S' || hemi==='W') sign = -1;
        if(hemi==='N' || hemi==='E') sign = 1;
      }
      const out = sign * n;
      if(isLat && (out < -90 || out > 90)) return null;
      if(!isLat && (out < -180 || out > 180)) return null;
      return out;
    }

    // DMS: detecta hemisferio al final (N,S,E,W,O)
    const hm = s.match(/([NSEWO])\s*$/);
    let hemi = hm ? hm[1] : null;
    if(hemi==='O') hemi='W';

    // Extrae n√∫meros: deg min sec (sec puede tener decimales)
    const nums = s
      .replace(/[NSEWO]/g,'')
      .replace(/[^0-9.+-]+/g,' ')
      .trim()
      .split(/\s+/)
      .filter(Boolean);
    if(!nums.length) return null;

    let deg = parseFloat(nums[0]);
    let min = nums.length>1 ? parseFloat(nums[1]) : 0;
    let sec = nums.length>2 ? parseFloat(nums[2]) : 0;
    if(!isFinite(deg) || !isFinite(min) || !isFinite(sec)) return null;

    let sign = 1;
    if(deg < 0){ sign = -1; deg = Math.abs(deg); }

    if(hemi){
      if(hemi === 'S' || hemi === 'W') sign = -1;
      if(hemi === 'N' || hemi === 'E') sign = 1;
    }

    const out = sign * (deg + (min/60) + (sec/3600));
    if(isLat && (out < -90 || out > 90)) return null;
    if(!isLat && (out < -180 || out > 180)) return null;
    return out;
  }

  const placeLLBtn = $('#placeLL');
  if(placeLLBtn){
    placeLLBtn.onclick = ()=>{
      const lat = __parseCoordDMS($('#coordLat') && $('#coordLat').value, true);
      const lon = __parseCoordDMS($('#coordLon') && $('#coordLon').value, false);
      if(lat===null || lon===null){
        alert('Coordenadas inv√°lidas. Ejemplos:\n- 12¬∞01\'20\"S\n- -12.0222\n- 77¬∞06\'50\"W\n- -77.1139');
        return;
      }
      const ref = (window.st && st.radarCenter) ? st.radarCenter : (window.CENTER_AIRPORT || {lat:0,lon:0});
      const p = llToLocalNM(lat, lon, ref.lat, ref.lon);
      const x = p.x, y = p.y;
      const id='D-'+Math.random().toString(36).slice(2,10).toUpperCase();
      // Punto por coordenadas: blanco sutil, renombrable (muestra nombre si lo asignas)
      st.drawings.push({id,type:'point',x,y,dotColor:'rgba(255,255,255,0.75)',showName:true});
      st.selectedDrawing=id;
      resetDrawTool();
    };
  }

})();

/* ===== Alerts ===== */
let __lastAlertPaint=0;
function paintAlerts(){
  const now = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
  if(now - __lastAlertPaint < 350) return; // throttle UI
  __lastAlertPaint = now;

  const wrap=$('#missileAlerts');
  if(!wrap) return;
  wrap.innerHTML='';

  const missiles=(st.missiles||[]).filter(m=>!m.status || m.status==='fly');

  if(!missiles.length){
    const d=document.createElement('div');
    d.className='missileEmpty';
    d.textContent='NO HAY MISILES EN VUELO';
    wrap.appendChild(d);
    return;
  }

  missiles.forEach(m=>{
    const L = (st.planes||[]).find(p=>p.id===m.launcher) || {name: m.launcher, x:m.x, y:m.y};
    const T = (st.planes||[]).find(p=>p.id===m.tgt) || {name: m.tgt, x:m.tx||m.x, y:m.ty||m.y};

    // Distancia SIEMPRE en NM y (KM), independiente del toggle M√©trico/Imperial
    const distNM = Math.hypot((T.x||0)-(m.x||0), (T.y||0)-(m.y||0));
    const distKM = distNM * NM2KM;
    const distTxt = `${distNM.toFixed(1)} NM (${distKM.toFixed(1)} KM)`;
const div=document.createElement('div');
    div.className='missileCard';
    div.innerHTML = `
      <div class="missileHdr">
        <div class="missileTitle"><span class="missileDot"></span> MISIL ENTRANTE</div>
        <div class="missileDist">${distTxt}</div>
      </div>
      <div class="missileGrid">
        <div class="missileRow">
          <span class="missileK">ORIG</span><span class="missileV">${(L.name||'').toString()}</span>
          <span class="missileArrow">‚Üí</span>
          <span class="missileK">TGT</span><span class="missileV">${(T.name||'').toString()}</span>
        </div>
        <div class="missileRow">
          <span class="missileK">TIPO</span><span class="missileV">${(m.name || m.type || 'N/A').toString()}</span>
        </div>
      </div>
    `;
    wrap.appendChild(div);
  });
}

/* ===== Telemetr√≠a y Reporte ===== */
// ======================================================
// === FUNCI√ìN MEJORADA: GENERADOR DE REPORTE T√ÅCTICO ===
// ======================================================
const tel = { rows: [], evts: [] };

function fmt(ms) {
  if (ms < 0) ms = 0;
  const s = Math.floor(ms / 1000);
  return `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
}

function logTel() {
  if (st.paused) return;
  tel.rows.push({
    t: st.elapsed,
    planes: st.planes.map(p => ({
      id: p.id,
      name: p.name,
      alt: p.alt,
      spd: p.spd
    }))
  });
}

function logEvent(txt) {
  tel.evts.push({ t: st.elapsed, txt });
}

let telTick = 0;

function renderReport() {
  const cont = $('#reportContent');
  const fecha = new Date().toLocaleString();
  const lanz = tel.evts.filter(e => e.txt.includes('LANZAMIENTO')).length;
  const hits = tel.evts.filter(e => e.txt.includes('SPLASH')).length;
  const tasa = lanz ? ((hits / lanz) * 100).toFixed(1) + '%' : 'N/A';

  // === ENCABEZADO ===
  let html = `
  <h2 style="color:#000; margin-bottom:6px;">REPORTE T√ÅCTICO</h2>
  <div class="row" style="justify-content:space-between; font-size:13px; color:#000;">
    <span><b>Fecha:</b> ${fecha}</span>
    <span><b>Duraci√≥n:</b> ${fmt(st.elapsed)}</span>
    <span><b>Tasa de acierto:</b> ${tasa}</span>
  </div>
  <div class="row" style="justify-content:flex-end;gap:8px; margin:5px 0;">
    <button onclick="window.print()" style="padding:4px 8px;font-size:12px;">üñ®Ô∏è Imprimir</button>
  </div>`;

  // === ESTADO FINAL DE AERONAVES ===
  html += `
  <h3 style="color:#000; margin:4px 0;">Estado Final de Aeronaves</h3>
  <table style="width:100%; border-collapse:collapse; font-size:12px; color:#000;">
    <thead>
      <tr style="background:#e6e6e6;">
        <th style="border:1px solid #999; padding:3px;">Nombre</th>
        <th style="border:1px solid #999; padding:3px;">Rol</th>
        <th style="border:1px solid #999; padding:3px;">Estado</th>
        <th style="border:1px solid #999; padding:3px;">Derribos</th>
        <th style="border:1px solid #999; padding:3px;">Velocidad</th>
        <th style="border:1px solid #999; padding:3px;">Altitud</th>
      </tr>
    </thead>
    <tbody>`;

  st.planes.forEach(p => {
    const stt = p._hit
      ? '<b style="color:red;">DESTRUIDO</b>'
      : '<span style="color:#000;">Activo</span>';
    const vel = st.metric
      ? `${p.spd.toFixed(0)} km/h`
      : `${(p.spd * KMH2KTS).toFixed(0)} kts`;
    const alt = st.metric
      ? `${(p.alt * FT2M | 0)} m`
      : `${p.alt | 0} ft`;
    html += `
      <tr>
        <td style="border:1px solid #999; padding:3px;">${p.name}</td>
        <td style="border:1px solid #999; padding:3px;">${st.roles[p.id] || 'N/A'}</td>
        <td style="border:1px solid #999; padding:3px;">${stt}</td>
        <td style="border:1px solid #999; padding:3px;">${p.kills || 0}</td>
        <td style="border:1px solid #999; padding:3px;">${vel}</td>
        <td style="border:1px solid #999; padding:3px;">${alt}</td>
      </tr>`;
  });

  html += `</tbody></table>`;

  // === GR√ÅFICOS ===
  html += `
  <h3 style="color:#000; margin:6px 0;">Gr√°ficos</h3>
  <div class="charts" style="display:flex;gap:10px;justify-content:center;">
    <div style="width:48%;height:220px;"><canvas id="altChart"></canvas></div>
    <div style="width:48%;height:220px;"><canvas id="spdChart"></canvas></div>
  </div>`;

  // === EVENTOS ===
  html += `
  <h3 style="color:#000; margin:6px 0;">Eventos</h3>
  <table style="width:100%; border-collapse:collapse; font-size:12px;">
    <tbody>`;
  [...tel.evts].reverse().forEach(e => {
    let s = '';
    if (e.txt.includes('SPLASH') || e.txt.includes('FALLA'))
      s = 'style="color:red;font-weight:700"';
    if (e.txt.includes('LANZAMIENTO'))
      s = 'style="color:#ff6600;font-weight:700"';
    html += `<tr><td style="width:60px;border-bottom:1px solid #ddd;">[${fmt(e.t)}]</td><td ${s}>${e.txt}</td></tr>`;
  });
  html += `</tbody></table>`;

  cont.innerHTML = html;

  // === GRAFICAR ===
  if (tel.rows.length > 1) {
    const labels = tel.rows.map(r => fmt(r.t));
    const ids = [...new Set(tel.rows.flatMap(r => r.planes.map(p => p.id)))];

    // Paleta de colores m√°s distinguible (para m√∫ltiples aeronaves)
    const palette = [
      '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
      '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe',
      '#008080', '#e6beff', '#9a6324', '#800000', '#808000'
    ];

    // Dataset ALTITUD
    const altDS = ids.map((id, i) => ({
      label: (st.planes.find(p => p.id === id)?.name) || id,
      data: tel.rows.map(r => {
        const p = r.planes.find(x => x.id === id);
        return p ? (st.metric ? p.alt * FT2M : p.alt) : null;
      }),
      borderColor: palette[i % palette.length],
      fill: false,
      tension: 0.15,
      pointRadius: 0
    }));

    // Dataset VELOCIDAD
    const spdDS = ids.map((id, i) => ({
      label: (st.planes.find(p => p.id === id)?.name) || id,
      data: tel.rows.map(r => {
        const p = r.planes.find(x => x.id === id);
        return p ? (st.metric ? p.spd : p.spd * KMH2KTS) : null;
      }),
      borderColor: palette[(i + 3) % palette.length], // desplazado para distinguir
      fill: false,
      tension: 0.15,
      pointRadius: 0
    }));

    // Gr√°fico de Altitud
    new Chart($('#altChart').getContext('2d'), {
      type: 'line',
      data: { labels, datasets: altDS },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#000', font: { size: 11 } } },
          title: {
            display: true,
            text: `Altitud (${st.metric ? 'm' : 'ft'})`,
            color: '#000',
            font: { size: 13, weight: 'bold' }
          }
        },
        scales: {
          x: { ticks: { color: '#000' }, grid: { color: '#ccc' } },
          y: { ticks: { color: '#000' }, grid: { color: '#ddd' } }
        }
      }
    });

    // Gr√°fico de Velocidad
    new Chart($('#spdChart').getContext('2d'), {
      type: 'line',
      data: { labels, datasets: spdDS },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#000', font: { size: 11 } } },
          title: {
            display: true,
            text: `Velocidad (${st.metric ? 'km/h' : 'kts'})`,
            color: '#000',
            font: { size: 13, weight: 'bold' }
          }
        },
        scales: {
          x: { ticks: { color: '#000' }, grid: { color: '#ccc' } },
          y: { ticks: { color: '#000' }, grid: { color: '#ddd' } }
        }
      }
    });
  }
}


/* ===== UI repaint ===== */
function repaintPlanesList(){
  const list=$('#planeList'); list.innerHTML='';
  st.planes.forEach(p=>{
    const b=document.createElement('button'); b.className='mini btn focusable'; b.textContent=p.name;
    if(st.sel.includes(p.id)) b.classList.add('hi');
    b.onclick=()=>{const i=st.sel.indexOf(p.id); if(i>=0) st.sel.splice(i,1); else st.sel.push(p.id); repaintNav(); repaintStudent(); repaintAlt(); flash(b);};
    list.appendChild(b);
  });
}
function repaintNav(){
  const wrap=$('#navCards'); 
  if(!wrap) return;
  wrap.innerHTML='';
  st.sel.forEach(id=>{
    const p=st.planes.find(x=>x.id===id); 
    if(!p) return;

    const c=document.createElement('div');
    c.className='card navCard';

    c.innerHTML=`
      <div class="navHeader">
        <input id="nm-${id}" class="ghost focusable focusAlt" type="text" value="${p.name}" style="flex:1;width:auto;min-width:90px">
        <span class="navTitle">RUMBO</span>
        <span class="pill">${p.hdg.toFixed(0)}¬∞</span>
      </div>

      <div class="navRow">
        <span class="lbl">Rumbo</span>
        <button class="mini btn focusable biasBtn" title="Forzar giro por izquierda" data-bias="L" data-id="${id}">I</button>
        <button class="mini btn focusable biasBtn" title="Forzar giro por derecha" data-bias="R" data-id="${id}">D</button>
        <input id="hdg-${id}" class="ghost focusable focusAlt" type="number" value="${p.tgtHdg.toFixed(0)}">
        <button class="mini btn focusable" data-hdg="-10" data-id="${id}">-10</button>
        <button class="mini btn focusable" data-hdg="+10" data-id="${id}">+10</button>
      </div>

      <div class="navRow">
        <span class="lbl">Vel</span>
        <input id="spd-${id}" class="ghost focusable focusAlt" type="number"
               value="${st.metric?p.tgtSpd.toFixed(0):(p.tgtSpd*KMH2KTS).toFixed(0)}">
        <button class="mini btn focusable" data-spd="-50" data-id="${id}">-50</button>
        <button class="mini btn focusable" data-spd="+50" data-id="${id}">+50</button>
      </div>

      <div class="navRow">
        <span class="lbl">Alt</span>
        <input id="alt-${id}" class="ghost focusable focusAlt" type="number"
               value="${st.metric?(p.tgtAlt*FT2M|0):(p.tgtAlt|0)}">
        <button class="mini btn focusable" data-alt="-100" data-id="${id}">-100</button>
        <button class="mini btn focusable" data-alt="+100" data-id="${id}">+100</button>
      </div>

      <div class="navRow navBottom">
        <span class="lbl">Giro¬∞/s</span>
        <input id="tr-${id}" class="ghost focusable focusAlt" type="number" step="0.1" value="${p.turn.toFixed(1)}">
        <button class="mini btn focusable" data-turn="-1" data-id="${id}">-1</button>
        <button class="mini btn focusable" data-turn="+1" data-id="${id}">+1</button>

        <span class="lbl" style="margin-left:6px">ROL</span>
        <select id="role-${id}" class="ghost focusable focusAlt">
          <option>Friend</option>
          <option>Bandit</option>
          <option>Neutral</option>
          <option>Civilian</option>
        </select>

        <span class="lbl" style="margin-left:6px">OBJ</span>
        <select id="tgt-${id}" class="ghost focusable focusAlt navObj"></select>

        <div class="navWeapons">
          <button class="mini btn focusable" data-m="AMRAAM" data-id="${id}">AMRAAM</button>
          <button class="mini btn focusable" data-m="R77" data-id="${id}">R-77</button>
          <button class="mini btn focusable" data-act="jam" data-id="${id}">Jammer</button>
        </div>
      </div>
    `;

    wrap.appendChild(c);

    // Focus glow + flash
    const focusables=c.querySelectorAll('.focusable, input, select, button');
    focusables.forEach(el=>{
      el.addEventListener('focus',()=>el.classList.add('focusGlow'));
      el.addEventListener('blur',()=>el.classList.remove('focusGlow'));
      el.addEventListener('click',()=>flash(el));
    });

    // Nombre
    c.querySelector('#nm-'+id).onchange=e=>{p.name=e.target.value; repaintAlt();};

    // Botones de rumbo +/-10
    c.querySelectorAll('button[data-hdg]').forEach(btn=>{
      btn.onclick = ()=>{
        const delta = parseFloat(btn.getAttribute('data-hdg')) || 0;
        p.tgtHdg = ((p.tgtHdg + delta) % 360 + 360) % 360;
        repaintNav();
      };
    });

    // Sesgo de giro (I/D) toggle
    c.querySelectorAll('button[data-bias]').forEach(btn=>{
      const b = btn.getAttribute('data-bias');
      if((p.turnBias||'')===b) btn.classList.add('biasOn');
      btn.onclick = ()=>{
        p.turnBias = (p.turnBias===b) ? null : b;
        repaintNav();
      };
    });

    // Botones velocidad +/-50
    c.querySelectorAll('button[data-spd]').forEach(btn=>{
      btn.onclick = ()=>{
        const delta = parseFloat(btn.getAttribute('data-spd')) || 0;
        const cambio = st.metric ? delta : delta * KTS2KMH;
        p.tgtSpd = Math.max(0, (p.tgtSpd || 0) + cambio);
        repaintNav();
      };
    });

    // Botones altitud +/-100
    c.querySelectorAll('button[data-alt]').forEach(btn=>{
      btn.onclick = ()=>{
        const delta = parseFloat(btn.getAttribute('data-alt')) || 0;
        const cambio = st.metric ? (delta / FT2M) : delta;
        p.tgtAlt = Math.max(0, (p.tgtAlt || 0) + cambio);
        repaintNav();
      };
    });

    // Botones giro +/-1
    c.querySelectorAll('button[data-turn]').forEach(btn=>{
      btn.onclick = ()=>{
        const delta = parseFloat(btn.getAttribute('data-turn')) || 0;
        p.turn = Math.max(0, (p.turn || 0) + delta);
        repaintNav();
      };
    });

    // Cambios manuales en campos
    c.querySelector('#hdg-'+id).onchange = e => { p.tgtHdg = parseFloat(e.target.value) || 0; };
    c.querySelector('#spd-'+id).onchange = e => {
      const val = +e.target.value || 0;
      p.tgtSpd = st.metric ? val : val * KTS2KMH;
    };
    c.querySelector('#alt-'+id).onchange = e => {
      const val = +e.target.value || 0;
      p.tgtAlt = st.metric ? (val / FT2M) : val;
    };
    c.querySelector('#tr-'+id).onchange = e => { p.turn = +e.target.value || 2; };

    // Rol (estado global)
    const role=c.querySelector('#role-'+id); 
    role.value=st.roles[id]||'Neutral'; 
    role.onchange=e=>st.roles[id]=e.target.value;

    // Objetivo
    const tgt=c.querySelector('#tgt-'+id);
    tgt.innerHTML = `<option value="">Seleccionar...</option>` + st.planes
      .filter(x=>x.id!==id)
      .map(x=>`<option value="${x.id}">${x.name}</option>`)
      .join('');

    // Armas
    c.querySelectorAll('button[data-m]').forEach(b=>b.onclick=ev=>{
      const mid=ev.currentTarget.dataset.id;
      const tg=c.querySelector('#tgt-'+mid).value;
      if(tg) launch(mid,tg,ev.currentTarget.dataset.m);
      else alert('Seleccione objetivo');
      flash(ev.currentTarget);
    });

    // Jammer
    const jam=c.querySelector('button[data-act="jam"]'); 
    if(p.jamming) jam.classList.add('hi'); 
    jam.onclick=()=>{p.jamming=!p.jamming; jam.classList.toggle('hi'); flash(jam);};
  });
}
function repaintStudent(){
  const box=$('#studentInfo'); if(st.sel.length===0){box.textContent='Selecciona aviones (Instructor).';return;} box.innerHTML='';
  st.sel.forEach(id=>{
    const p=st.planes.find(x=>x.id===id); if(!p) return;
    const d=document.createElement('div'); d.className='card mini';
    d.innerHTML=`<strong>${p.name}</strong><br>Rumbo: ${p.hdg.toFixed(0)}¬∞<br>Vel: ${st.metric?`${p.spd.toFixed(0)} km/h`:`${(p.spd*KMH2KTS).toFixed(0)} kts`}<br>Alt: ${st.metric?`${(p.alt*FT2M|0)} m`:`${p.alt|0} ft`}`;
    box.appendChild(d);
  });
}
function repaintPairs(){
  const sA=$('#pairA'),sB=$('#pairB'); sA.innerHTML=''; sB.innerHTML='';
  st.planes.forEach(p=>{const a=document.createElement('option');a.value=p.id;a.textContent=p.name;sA.appendChild(a);sB.appendChild(a.cloneNode(true));});
  repaintPairList();
}
function repaintAlt(){
  const list=$('#altList'); 
  if(!list) return;
  list.innerHTML='';
  // Panel informativo: nombre + altura en FT (ordenado de mayor a menor)
  const sorted=[...st.planes].sort((a,b)=>(b.alt||0)-(a.alt||0));
  sorted.forEach(p=>{
    const row=document.createElement('div'); 
    row.className='row'; 
    row.style.justifyContent='space-between'; 
    row.style.alignItems='center';

    const tag=document.createElement('span'); 
    tag.className='pill'; 
    tag.textContent=p.name;

    const val=document.createElement('span'); 
    val.className='badge'; 
    val.textContent=`${(p.alt||0)|0} ft`;

    row.appendChild(tag); 
    row.appendChild(val); 
    list.appendChild(row);
  });

  // Referencia al suelo (0 ft)
  const ground=document.createElement('div');
  ground.className='row';
  ground.style.justifyContent='space-between';
  ground.style.alignItems='center';
  ground.style.opacity='0.65';

  const g1=document.createElement('span'); g1.className='pill'; g1.textContent='SUELO';
  const g2=document.createElement('span'); g2.className='badge'; g2.textContent='0 ft';
  ground.appendChild(g1); ground.appendChild(g2);
  list.appendChild(ground);
}

// Refresco suave del panel de alturas (solo UI)
setInterval(()=>{ try{ repaintAlt(); }catch(e){} }, 900);

/* ===== Loop ===== */
let lastTS=0,accFPS=0,frames=0;
function loop(ts){
  const dt=Math.max(0,(ts-lastTS)/1000); lastTS=ts;
  if(!st.paused){ st.elapsed = performance.now() - st.t0; telTick += dt; if(telTick>5){logTel(); telTick=0;} }
  ctx.clearRect(0,0,W,H);
  if (st.radarFail) { drawGrid(); ctx.fillStyle='rgba(255,50,50,0.12)'; ctx.fillRect(0,0,W,H); ctx.font='bold 36px monospace'; ctx.fillStyle='#ff4d4d'; ctx.textAlign='center'; ctx.fillText('FALLA DE RADAR', W/2, H/2); requestAnimationFrame(loop); return; }
  drawGrid(); drawPeruMap(); drawAirports(); sweepDetect(dt); drawSweep(dt);
  if(!st.paused){ st.planes.forEach(p=>updatePlane(p,dt)); updateMissiles(dt); updatePairs(); }
  
// Trajectory visualization
if(st.showTraj){
  ctx.strokeStyle='rgba(46,231,79,0.4)';
  ctx.lineWidth=1;
  st.planes.forEach(p=>{
    if(p.ghosts.length>1){
      ctx.beginPath();
      p.ghosts.forEach((g,i)=>{
        const sg=toScreen(g.x,g.y);
        if(i===0) ctx.moveTo(sg.x,sg.y); else ctx.lineTo(sg.x,sg.y);
      });
      ctx.stroke();
    }
  });
}

  st.planes.forEach(p=>drawPlane(p)); drawPairs(); drawMissiles(); drawShapes();
  if(measuring&&rA&&rB){
    ctx.beginPath();ctx.moveTo(rA.x,rA.y);ctx.lineTo(rB.x,rB.y);ctx.strokeStyle='#2ee74f';ctx.lineWidth=1;ctx.stroke();
    const sx=(rA.x-CX-offX)/(zoom*PX_PER_NM),sy=(rA.y-CY-offY)/(zoom*PX_PER_NM),ex=(rB.x-CX-offX)/(zoom*PX_PER_NM),ey=(rB.y-CY-offY)/(zoom*PX_PER_NM);
    const dx=ex-sx,dy=ey-sy;const dNM=Math.hypot(dx,dy),dKM=dNM*NM2KM;let ang=(Math.atan2(dx,-dy)*180/Math.PI+360)%360;
    const lbl=st.metric?`${String(Math.round(ang)).padStart(3,'0')}¬∞ / ${dKM.toFixed(1)} KM`:`${String(Math.round(ang)).padStart(3,'0')}¬∞ / ${dNM.toFixed(1)} NM`;
    const midX=(rA.x+rB.x)/2,midY=(rA.y+rB.y)/2;ctx.fillStyle='#2ee74f';ctx.font='14px monospace';ctx.textAlign='center';ctx.fillText(lbl,midX,midY-10);
  }
  paintAlerts();
  accFPS+=dt;frames++;if(accFPS>=0.5){fpsEl.textContent=String(Math.round(frames/accFPS));accFPS=0;frames=0;}
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===== Wire buttons ===== */
$('#start').onclick=()=>{
  if(st.paused){
    st.paused=false; simStateEl.textContent='RUN'; stateChip.textContent='En marcha'; stateChip.style.borderColor='#2ee74f'; stateChip.style.color='#2ee74f';
    if(!st.t0) st.t0 = performance.now(); else st.t0 = performance.now() - st.elapsed;
  }
};
$('#pause').onclick = ()=>{
  st.paused = !st.paused; // toggle local
  const chip = document.getElementById('stateChip');
  const simst = document.getElementById('simstate');
  if(chip) chip.textContent = st.paused ? 'Pausada' : 'En curso';
  if(simst) simst.textContent = st.paused ? 'PAUSA' : 'RUN';
};
$('#toggleLabels').onclick = ()=>{
  // 0 = normal (data block), 1 = solo nombre, 2 = sin etiquetas, 3 = radar anal√≥gico
  st.labelMode = (st.labelMode + 1) % 4;

  // compat: algunos parches a√∫n revisan showLabels
  st.showLabels = (st.labelMode===0 || st.labelMode===1);

  const btn = document.getElementById('toggleLabels');
  if(!btn) return;

  if(st.labelMode===0){
    btn.textContent = 'üß∑ Etiquetas';
    btn.style.opacity = '1';
  } else if(st.labelMode===1){
    btn.textContent = 'üß∑ Solo nombre';
    btn.style.opacity = '1';
  } else if(st.labelMode===2){
    btn.textContent = 'üß∑ Sin etiquetas';
    btn.style.opacity = '0.65';
  } else {
    btn.textContent = 'üì° Anal√≥gico';
    btn.style.opacity = '1';
  }
};
$('#reportBtn').onclick=()=>{ $('#report').style.display='block'; renderReport(); };
$('#closeReport').onclick=()=>{ $('#report').style.display='none'; };
$('#uMetric').onclick=()=>{ st.metric=true; repaintNav(); repaintStudent(); repaintAlt(); flash($('#uMetric')); };
$('#uImperial').onclick=()=>{ st.metric=false; repaintNav(); repaintStudent(); repaintAlt(); flash($('#uImperial')); };
$('#windSpd').onchange=e=>{ st.windKmh = st.metric?(+e.target.value||0):((+e.target.value||0)*KTS2KMH); flash(e.target); };
$('#windDir').onchange=e=>{ st.windDir = +e.target.value||0; flash(e.target); };
$('#failRadar').onclick=e=>{ st.radarFail=!st.radarFail; e.currentTarget.classList.toggle('hi',st.radarFail); flash(e.currentTarget); };
$('#toggleSweep').onclick=e=>{ st.sweep=!st.sweep; e.currentTarget.classList.toggle('hi',st.sweep); flash(e.currentTarget); };
$('#toggleAirports').onclick=e=>{ 
  openAptoModal();
  flash(e.currentTarget);
};

/* ===== APTO selector (LOCAL) ===== */
const APTO_LS_KEY = 'setca_apto_cfg_v2';
let __aptoDraft = null;

function __aptoSaveCfg(cfg){
  try{
    const out = {
      enabled: !!cfg.enabled,
      mode: cfg.mode,
      custom: Array.from(cfg.customSet || cfg.custom || [])
    };
    localStorage.setItem(APTO_LS_KEY, JSON.stringify(out));
    // legacy (por compatibilidad con versiones anteriores)
    localStorage.setItem('setca_showAirports', out.enabled ? '1' : '0');
  }catch(_){}
}

function __aptoSetButtonState(){
  const cfg = window.__uiAptoCfg || {enabled:false, mode:'all', customSet:new Set()};
  window.__uiShowAirports = !!cfg.enabled && (cfg.mode!=='custom' || (cfg.customSet && cfg.customSet.size>0));
  const btn = document.getElementById('toggleAirports');
  if(btn) btn.classList.toggle('hi', window.__uiShowAirports);
}

function __aptoModeUI(mode){
  const bMaj = document.getElementById('aptoModeMajor');
  const bAll = document.getElementById('aptoModeAll');
  const bCus = document.getElementById('aptoModeCustom');
  if(bMaj) bMaj.classList.toggle('hi', mode==='major');
  if(bAll) bAll.classList.toggle('hi', mode==='all');
  if(bCus) bCus.classList.toggle('hi', mode==='custom');

  const wrap = document.getElementById('aptoCustomWrap');
  if(wrap) wrap.classList.toggle('hidden', mode!=='custom');
}

function __aptoRenderList(){
  if(!__aptoDraft || __aptoDraft.mode!=='custom') return;
  const list = document.getElementById('aptoList');
  const search = document.getElementById('aptoSearch');
  if(!list || !search) return;

  list.innerHTML = '';
  const q = (search.value || '').toLowerCase().trim();

  const arr = (st.airports || []).slice().sort((a,b)=>String(a.icao||'').localeCompare(String(b.icao||'')));

  for(const ap of arr){
    const icao = ap.icao || '';
    if(!icao) continue;

    const title = `${icao}${ap.iata?`/${ap.iata}`:''}`;
    const line1 = `${title} ‚Äî ${ap.name||''}`.trim();
    const line2 = `${ap.city||''}${ap.type?` ‚Ä¢ ${String(ap.type).replace(/_/g,' ')}`:''}`.trim();

    const hay = (line1 + ' ' + line2).toLowerCase();
    if(q && !hay.includes(q)) continue;

    const row = document.createElement('label');
    row.className = 'aptoItem';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.dataset.icao = icao;
    cb.checked = __aptoDraft.customSet.has(icao);

    const txt = document.createElement('div');
    const t = document.createElement('div'); t.className = 't'; t.textContent = line1;
    const s = document.createElement('div'); s.className = 's'; s.textContent = line2;
    txt.appendChild(t); txt.appendChild(s);

    row.appendChild(cb);
    row.appendChild(txt);
    list.appendChild(row);
  }
}

function openAptoModal(){
  const ov = document.getElementById('aptoOverlay');
  if(!ov) return;

  const cfg = window.__uiAptoCfg || { enabled:true, mode:'all', custom:[], customSet:new Set() };
  __aptoDraft = {
    enabled: !!cfg.enabled,
    mode: (cfg.mode==='major' || cfg.mode==='custom' || cfg.mode==='all') ? cfg.mode : 'all',
    customSet: new Set(cfg.customSet || cfg.custom || [])
  };

  const en = document.getElementById('aptoEnabled');
  if(en) en.checked = __aptoDraft.enabled;

  __aptoModeUI(__aptoDraft.mode);

  const search = document.getElementById('aptoSearch');
  if(search) search.value = '';

  __aptoRenderList();

  ov.style.display = 'flex';
  ov.setAttribute('aria-hidden','false');

  if(__aptoDraft.mode==='custom' && search) search.focus();
}

function closeAptoModal(){
  const ov = document.getElementById('aptoOverlay');
  if(!ov) return;
  ov.style.display = 'none';
  ov.setAttribute('aria-hidden','true');
  __aptoDraft = null;
}

function bindAptoUI(){
  const ov = document.getElementById('aptoOverlay');
  if(!ov) return;

  const closeBtn = document.getElementById('aptoClose');
  const cancelBtn = document.getElementById('aptoCancel');
  const applyBtn = document.getElementById('aptoApply');

  if(closeBtn) closeBtn.addEventListener('click', closeAptoModal);
  if(cancelBtn) cancelBtn.addEventListener('click', closeAptoModal);

  ov.addEventListener('click', (e)=>{ if(e.target === ov) closeAptoModal(); });

  const enabled = document.getElementById('aptoEnabled');
  if(enabled) enabled.addEventListener('change', (e)=>{ if(__aptoDraft) __aptoDraft.enabled = !!e.target.checked; });

  const bMaj = document.getElementById('aptoModeMajor');
  const bAll = document.getElementById('aptoModeAll');
  const bCus = document.getElementById('aptoModeCustom');

  if(bMaj) bMaj.addEventListener('click', ()=>{ if(!__aptoDraft) return; __aptoDraft.mode='major'; __aptoModeUI('major'); });
  if(bAll) bAll.addEventListener('click', ()=>{ if(!__aptoDraft) return; __aptoDraft.mode='all'; __aptoModeUI('all'); });
  if(bCus) bCus.addEventListener('click', ()=>{ if(!__aptoDraft) return; __aptoDraft.mode='custom'; __aptoModeUI('custom'); __aptoRenderList(); const s=document.getElementById('aptoSearch'); if(s) s.focus(); });

  const search = document.getElementById('aptoSearch');
  if(search) search.addEventListener('input', ()=>{ __aptoRenderList(); });

  const list = document.getElementById('aptoList');
  if(list) list.addEventListener('change', (e)=>{
    const t = e.target;
    if(!__aptoDraft || !t || t.tagName!=='INPUT' || t.type!=='checkbox') return;
    const icao = t.dataset.icao;
    if(!icao) return;
    if(t.checked) __aptoDraft.customSet.add(icao);
    else __aptoDraft.customSet.delete(icao);
  });

  const selAll = document.getElementById('aptoSelAll');
  const selNone = document.getElementById('aptoSelNone');

  if(selAll) selAll.addEventListener('click', ()=>{
    if(!__aptoDraft) return;
    const boxes = Array.from(document.querySelectorAll('#aptoList input[type="checkbox"][data-icao]'));
    boxes.forEach(b=>{ b.checked = true; __aptoDraft.customSet.add(b.dataset.icao); });
  });

  if(selNone) selNone.addEventListener('click', ()=>{
    if(!__aptoDraft) return;
    const boxes = Array.from(document.querySelectorAll('#aptoList input[type="checkbox"][data-icao]'));
    boxes.forEach(b=>{ b.checked = false; __aptoDraft.customSet.delete(b.dataset.icao); });
  });

  if(applyBtn) applyBtn.addEventListener('click', ()=>{
    if(!__aptoDraft) return;

    const cfg = {
      enabled: !!__aptoDraft.enabled,
      mode: (__aptoDraft.mode==='major' || __aptoDraft.mode==='custom' || __aptoDraft.mode==='all') ? __aptoDraft.mode : 'all',
      custom: Array.from(__aptoDraft.customSet),
      customSet: new Set(__aptoDraft.customSet)
    };

    window.__uiAptoCfg = cfg;
    __aptoSaveCfg(cfg);
    __aptoSetButtonState();
    closeAptoModal();
  });

  // Estado inicial del bot√≥n (cuando carga la p√°gina)
  __aptoSetButtonState();
}

window.addEventListener('DOMContentLoaded', bindAptoUI);



$('#modeDigital').onclick=()=>{ st.mode='digital'; flash($('#modeDigital')); };
$('#predPlus').onclick=()=>{ st.predMin=Math.min(60,st.predMin+1); $('#predVal').textContent=st.predMin; flash($('#predPlus')); };
$('#predMinus').onclick=()=>{ st.predMin=Math.max(0,st.predMin-1); $('#predVal').textContent=st.predMin; flash($('#predMinus')); };
$('#addFighter').onclick=()=>{
  const n=st.planes.length+1,id='R'+n,nm=id;
  const p={name:nm,id,x:(Math.random()*200-100),y:(Math.random()*200-100),hdg:Math.random()*360,spd:420,tgtSpd:420,alt:20000+(Math.random()*6000|0),tgtAlt:20000+(Math.random()*6000|0),turn:2,tgtHdg:Math.random()*360,ghosts:[],lastDet:0,fail:{comms:false,eng:'none',cab:'none',gear:false,bird:false},kills:0,fuel:100,jamming:false};
  st.planes.push(p); st.roles[id]=Math.random()>.5?'Friend':'Bandit'; repaintPlanesList(); repaintNav(); repaintPairs(); repaintAlt(); flash($('#addFighter'));
};
$('#addCom').onclick=()=>{
  const id='COM-'+Date.now(),edge=Math.floor(Math.random()*4),range=MAX_RANGE_NM*1.1; let x=0,y=0,hdg=0;
  if(edge===0){x=-range;y=(Math.random()-0.5)*range;hdg=90;} else if(edge===1){x=range;y=(Math.random()-0.5)*range;hdg=270;} else if(edge===2){y=-range;x=(Math.random()-0.5)*range;hdg=180;} else {y=range;x=(Math.random()-0.5)*range;hdg=0;}
  const p={name:'COMERCIAL '+(Math.floor(Math.random()*900)+100),id,x,y,hdg,spd:850,tgtSpd:850,alt:30000+(Math.random()*8000|0),tgtAlt:30000+(Math.random()*8000|0),turn:1.2,tgtHdg:hdg,ghosts:[],lastDet:0,fail:{comms:false,eng:'none',cab:'none',gear:false,bird:false},kills:0,fuel:100,jamming:false};
  st.planes.push(p); st.roles[id]='Civilian'; repaintPlanesList(); repaintNav(); repaintPairs(); repaintAlt(); flash($('#addCom'));
};

$('#altFt').onclick=()=>{ st.altUnit='ft'; repaintAlt(); flash($('#altFt')); };
$('#altM').onclick=()=>{ st.altUnit='m'; repaintAlt(); flash($('#altM')); };
$('#doPair').onclick=()=>{
  const a=$('#pairA').value,b=$('#pairB').value;
  if(a&&b&&a!==b){
    const ex=st.pairs.find(pr=>(pr.a===a&&pr.b===b)||(pr.a===b&&pr.b===a));
    if(!ex){st.pairs.push({a,b}); repaintPairList();} else alert('Ya emparejados.');
  } else alert('Seleccione dos distintos.');
};
$('#unPair').onclick=()=>{ st.pairs=[]; repaintPairList(); };
/* Online (beta) code removed per user request */
/* ===== Inicializaci√≥n ===== */
function initUI(){
  repaintPlanesList(); repaintNav(); repaintStudent(); repaintPairs(); repaintAlt();
  const swbtn = $('#toggleSweep'); if(swbtn) swbtn.classList.toggle('hi', !!st.sweep);
  const frbtn = $('#failRadar'); if(frbtn) frbtn.classList.toggle('hi', !!st.radarFail);
  const apbtn = $('#toggleAirports'); if(apbtn) apbtn.classList.toggle('hi', !!window.__uiShowAirports);
}
initUI(); try{fitToPlanes && fitToPlanes();}catch(e){}
requestAnimationFrame(()=>{ repaintPlanesList(); repaintNav(); repaintStudent(); repaintPairs(); repaintAlt(); });



// ==== FORMATION SYSTEM ====
$$('#pFormations button[data-form]').forEach(btn=>{
  btn.onclick=()=>{
    const key = btn.getAttribute('data-form');
    const map = {
      'RANGE':'RANGE',
      'VIC':'VIC',
      'CHAMPAGNE':'CHAMPAGNE',
      'AZIMUT2':'AZIMUT2',
      'WALL4':'WALL4',
      'LEADTRAIL2':'LEADTRAIL2',
      'LINEABREAST2':'LINEABREAST2',
      'BOX6':'BOX4',
      'CONTAINER4':'BOX4'
    };
    spawnFormation(map[key]||'LINEABREAST2');
    repaintPlanesList(); repaintNav(); repaintAlt();
    flash(btn);
  };
});</script>
<script>
  // === Sync online: debounce + flush (ENTER) ===
  let __syncTimer = null;
  let __syncPending = false;

  function scheduleSync(delay=90){
    __syncPending = true;
    if(__syncTimer) return;
    __syncTimer = setTimeout(()=>{
      __syncTimer = null;
      if(!__syncPending) return;
      __syncPending = false;
      try{ window._SETCA_SYNC && window._SETCA_SYNC.push && window._SETCA_SYNC.push(); }catch(e){}
    }, delay);
  }

  function flushSync(){
    try{
      if(__syncTimer){ clearTimeout(__syncTimer); __syncTimer=null; }
      __syncPending = false;
      window._SETCA_SYNC && window._SETCA_SYNC.push && window._SETCA_SYNC.push();
    }catch(e){}
  }

  // Exponer para compatibilidad
  window.scheduleSync = scheduleSync;
  window.flushSync = flushSync;

  // Conectar con los botones principales
  ['#addFighter','#addCom','#delLast','#pause','#start'].forEach(id=>{
    const el = document.querySelector(id);
    if(el){
      const orig = el.onclick;
      el.onclick = (e)=>{ const r = orig(e); scheduleSync(); return r; };
    }
  });

  // Cuando se suelta el mouse (mover aviones o dibujos)
  addEventListener('mouseup', ()=>scheduleSync(), {passive:true});

  // ENTER en navegaci√≥n => aplicar change y FLUSH inmediato
  addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    const t = e.target;
    if(!t || t.tagName!=='INPUT') return;
    const id = (t.id||'');
    // Campos del panel de navegaci√≥n
    if(/^((nm|hdg|spd|alt|tr)-)/.test(id)){
      try{
        // forzar onchange (en algunos navegadores Enter no dispara change)
        t.dispatchEvent(new Event('change', {bubbles:true}));
      }catch(_){}
      flushSync();
    }
  }, true);

  // Enviar un primer estado al cargar
  setTimeout(()=>scheduleSync(0),1200);
</script>
<!-- === SETCA Enhancements Patch (Alumno + Emparejamientos + Falla Radar + Pinch Zoom + T√≠tulo) === -->
<style>
  #radarFailOverlay{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.6); color:#ff4d4d; font: 700 24px monospace; z-index: 50;
    border: 1px solid rgba(255,77,77,0.6);
    pointer-events:none;
  }
  header .setca-subtitle{ font-size:12px; color:#b6f3b6; margin-top:2px; }

  /* === Men√∫ contextual de gr√°ficos === */
  #drawingCtxMenu{
    position:fixed;
    z-index:99999;
    display:none;
    background:rgba(5,10,6,0.95);
    border:1px solid var(--warn);
    border-radius:10px;
    padding:6px;
    box-shadow:0 10px 25px rgba(0,0,0,0.55);
    font-family:monospace;
    min-width:170px;
  }
  #drawingCtxMenu .ctxItem{
    width:100%;
    text-align:left;
    background:transparent;
    border:0;
    color:var(--txt);
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    font-weight:400;
  }
  #drawingCtxMenu .ctxItem:hover{
    background:rgba(255,224,102,0.12);
  }

</style>
<script>
(function(){
  const st = (window.st = window.st || {});

  // Title / Subtitle
  try{
    const hdr = document.querySelector('header') || document.body;
    let title = hdr.querySelector('h1');
    if (!title){ title = document.createElement('h1'); hdr.prepend(title); }
    title.textContent = 'SETCA';
    let sub = hdr.querySelector('.setca-subtitle');
    if(!sub){ sub = document.createElement('div'); sub.className = 'setca-subtitle'; title.insertAdjacentElement('afterend', sub); }
    sub.textContent = 'Sistema de Entrenamiento T√°ctico de Control de Aeronaves';
  }catch(e){ console.warn('SETCA title patch:', e); }

  // Alumno button
  try{
    const hdr = document.querySelector('header') || document.body;
    let alumnoBtn = document.getElementById('alumnoBtn');
    if(!alumnoBtn){
      alumnoBtn = document.createElement('button');
      alumnoBtn.id = 'alumnoBtn';
      alumnoBtn.textContent = 'üéØ Alumno';
      hdr.appendChild(alumnoBtn);
      // Bot√≥n de Salas
      let salasBtn = document.getElementById('salasBtn');
      if(!salasBtn){
        salasBtn = document.createElement('button');
        salasBtn.id = 'salasBtn';
        salasBtn.textContent = 'üì° Salas';
        hdr.appendChild(salasBtn);
      }
      salasBtn.addEventListener('click', ()=>{
        if(window.setcaRooms && typeof window.setcaRooms.open==='function'){
          window.setcaRooms.open();
        }
      });

      // Boton OFF: muestra resumen de sesion y cierra
      let offBtn = document.getElementById('offBtn');
      if(!offBtn){
        offBtn = document.createElement('button');
        offBtn.id = 'offBtn';
        offBtn.textContent = '‚èª OFF';
        offBtn.title = 'Salir de SETCA';
        offBtn.style.marginLeft = '6px';
        offBtn.style.borderColor = '#b33';
        offBtn.style.color = '#fff';
        offBtn.style.background = '#3a1111';
        hdr.appendChild(offBtn);
      }
      offBtn.addEventListener('click', ()=>{
        if(typeof window.setcaOff === 'function'){
          window.setcaOff();
        }else{
          // Fallback si el modulo de salas aun no cargo
          const start = Number(sessionStorage.getItem('setca_session_start')||Date.now());
          const ms = Date.now() - start;
          const s = Math.max(0, Math.floor(ms/1000));
          const hh = String(Math.floor(s/3600)).padStart(2,'0');
          const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          alert('Tiempo conectado: ' + hh + ':' + mm + ':' + ss + '\n(Salas aun no inicializadas)');
          try{ window.close(); }catch(_){ }
          location.href = 'about:blank';
        }
      });
    }
    const toHide = ['#pCmd','#pPlanes','#pNav','#pFormations','#pDraw'];
    alumnoBtn.addEventListener('click', ()=>{
      st.modoAlumno = !st.modoAlumno;
      toHide.forEach(sel=>{ const el = document.querySelector(sel); if(el){ el.style.display = st.modoAlumno ? 'none' : ''; } });
      alumnoBtn.classList.toggle('hi', !!st.modoAlumno);
      (window.repaintPlanesList||function(){})();
      (window.repaintNav||function(){})();
      (window.repaintPairs||function(){})();
      (window.repaintAlt||function(){})();
    });
  }catch(e){ console.warn('Alumno button patch:', e); }

  // Names -> pairs
  try{
    document.addEventListener('change', (e)=>{
      const t = e.target;
      if(!t || !t.id) return;
      if(t.id.startsWith('nm-')){
        const pid = t.id.slice(3);
        if(Array.isArray(st.planes)){
          const p = st.planes.find(x => x.id === pid || x.name === pid);
          if(p){ p.name = t.value || p.name; }
        }
        (window.repaintPlanesList||function(){})();
        (window.repaintPairs||function(){})();
        (window.repaintPairList||function(){})();
        (window.scheduleSync||function(){})();
      }
    }, true);
  }catch(e){ console.warn('Name->Pairs patch:', e); }

  // Radar fail (sync) + overlay
  try{
    const failBtn = document.getElementById('failRadar');
    if(failBtn){
      failBtn.addEventListener('click', ()=>{
        st.radarFailNet = !st.radarFailNet;
        (window.scheduleSync||function(){})();
      });
    }
    let center = document.getElementById('center') || document.querySelector('main') || document.body;
    let overlay = document.getElementById('radarFailOverlay');
    if(!overlay){
      overlay = document.createElement('div');
      overlay.id = 'radarFailOverlay';
      overlay.textContent = 'FALLA DE RADAR (ALUMNO)';
      center.style.position = center.style.position || 'relative';
      center.appendChild(overlay);
    }
    setInterval(()=>{ overlay.style.display = (st.modoAlumno && st.radarFailNet) ? 'flex' : 'none'; }, 200);
  }catch(e){ console.warn('Falla Radar overlay patch:', e); }

  // ===== Pinch-zoom t√°ctil nativo centrado en el punto medio =====
(function(){
  const cvs = document.getElementById('radar');
  if(!cvs) return;

  let pinch = null;
  const MIN_Z = 0.02, MAX_Z = 15;

  function dist(e){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    return Math.hypot(dx, dy);
  }

  function mid(e){
    return {
      x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
      y: (e.touches[0].clientY + e.touches[1].clientY) / 2
    };
  }

  cvs.addEventListener('touchstart', (e)=>{
    if(e.touches.length === 2){
      e.preventDefault();
      const m = mid(e);
      const rect = cvs.getBoundingClientRect();

      // Centro inicial del gesto en coordenadas del mundo
      const mx = m.x - rect.left;
      const my = m.y - rect.top;
      const worldX = (mx - CX - offX) / (zoom * PX_PER_NM);
      const worldY = (my - CY - offY) / (zoom * PX_PER_NM);

      pinch = {
        d0: dist(e),
        z0: zoom,
        worldX,
        worldY,
        screenX: mx,
        screenY: my
      };
    }
  }, {passive:false});

  cvs.addEventListener('touchmove', (e)=>{
    if(pinch && e.touches.length === 2){
      e.preventDefault();
      const scale = dist(e) / pinch.d0;
      const newZoom = Math.min(MAX_Z, Math.max(MIN_Z, pinch.z0 * scale));

      // Mantiene el punto medio fijo durante el zoom
      const m = mid(e);
      const rect = cvs.getBoundingClientRect();
      const mx = m.x - rect.left;
      const my = m.y - rect.top;

      const newScreenX = pinch.worldX * newZoom * PX_PER_NM + CX + offX;
      const newScreenY = pinch.worldY * newZoom * PX_PER_NM + CY + offY;

      offX -= (newScreenX - mx);
      offY -= (newScreenY - my);

      zoom = newZoom;
    }
  }, {passive:false});

  cvs.addEventListener('touchend', ()=>{
    pinch = null;
  }, {passive:true});
})();

  // Missile sync: call scheduleSync after launch
  try{
    const origLaunch = window.launch;
    if(typeof origLaunch === 'function'){
      window.launch = function(){
        const r = origLaunch.apply(this, arguments);
        (window.scheduleSync||function(){})();
        return r;
      };
    }
  }catch(e){ console.warn('Missile sync patch:', e); }

  // Repaint on remote updates
  window.addEventListener('setca-remote-update', ()=>{
    (window.repaintPlanesList||function(){})();
    (window.repaintNav||function(){})();
    (window.repaintPairs||function(){})();
    (window.repaintAlt||function(){})();
  });
})();
</script>
<!-- === /SETCA Enhancements Patch === -->


<script>
/* === PATCH: sync name changes to planes list & pairs + enrich report tactical data === */
(function(){
  function safeCall(fn){ try{ if(typeof fn==='function') fn(); }catch(e){console.warn(e); } }

  document.addEventListener('change', function(e){
    const t = e.target;
    if(!t || !t.id) return;
    if(t.id.startsWith('nm-')){
      const pid = t.id.slice(3);
      if(Array.isArray(st.planes)){
        const p = st.planes.find(x => x.id === pid);
        if(p){
          p.name = t.value || p.name;
          safeCall(repaintPlanesList);
          safeCall(repaintNav);
          safeCall(repaintPairs);
          safeCall(repaintPairList);
          safeCall(repaintStudent);
          if(window.scheduleSync) try{ window.scheduleSync(); }catch(e){console.warn(e);}
        }
      }
    }
  }, true);

  if(typeof renderReport === 'function'){
    const origRender = renderReport;
    window.renderReport = function(){
      origRender();
      try{
        const cont = document.getElementById('reportContent');
        if(!cont) return;
        const diagnostics = [];
        const COLLISION_NM = 1.0;
        st.planes.forEach(p=>{
          let nearest = null, nde=1e9;
          st.planes.forEach(q=>{
            if(p.id===q.id) return;
            const d = Math.hypot(p.x-q.x, p.y-q.y);
            if(d < nde){ nde = d; nearest = q; }
          });
          if(nearest && nde <= COLLISION_NM){
            const closing = Math.abs(((p.hdg - nearest.hdg)+540)%360 - 180) > 60 ? 'En cierre' : 'Rumbo similar/contrario';
            diagnostics.push({
              type:'collision',
              text: `RIESGO COLISI√ìN: ${p.name} ‚Üî ${nearest.name} ‚Äî Distancia ${(nde).toFixed(2)} NM ‚Äî ${closing}`
            });
          }
        });

        st.missiles.forEach(m=>{
          const L = st.planes.find(x=>x.id===m.launcher);
          const T = st.planes.find(x=>x.id===m.tgt);
          if(L && T){
            diagnostics.push({type:'launch', text:`LANZAMIENTO: ${L.name} -> ${T.name} (${m.name}). Posici√≥n lanz.: X:${L.x.toFixed(1)} Y:${L.y.toFixed(1)} NM`});
          }
        });

        st.planes.forEach(p=>{
          let nearest=null, nde=1e9;
          st.planes.forEach(q=>{ if(p.id===q.id) return; const d=Math.hypot(p.x-q.x,p.y-q.y); if(d<nde){ nde=d; nearest=q; }});
          if(nearest && nde < 3.0){
            const dAlt = nearest.alt - p.alt;
            let maneuver = '';
            if(Math.abs(dAlt) < 500) maneuver = 'Subir 500 ft / Descender 500 ft o cambio de rumbo ¬±20¬∞';
            else if(dAlt > 500) maneuver = 'Descender 500 ft';
            else maneuver = 'Subir 500 ft';
            diagnostics.push({type:'maneuver', text:`MANIOBRA POSIBLE: ${p.name} con ${nearest.name} ‚Äî Dist ${nde.toFixed(2)} NM ‚Äî Recomendaci√≥n: ${maneuver}`});
          }
        });

        st.pairs.forEach(pr=>{
          const A = st.planes.find(x=>x.id===pr.a), B = st.planes.find(x=>x.id===pr.b);
          if(!A || !B) return;
          if(pr.dNM && pr.dNM < 1.2){
            diagnostics.push({type:'pairRisk', text:`EMPAREJAMIENTO RIESGO: ${A.name} ‚Üî ${B.name} ‚Äî Dist ${pr.dNM.toFixed(2)} NM ‚Äî ŒîAlt ${pr.dAlt|0} ft`});
          }
        });

        const diagHtml = ['<h3>Diagn√≥sticos T√°cticos</h3><table><thead><tr><th>Tipo</th><th>Detalle</th></tr></thead><tbody>'];
        diagnostics.forEach(d=>{ diagHtml.push(`<tr><td>${d.type.toUpperCase()}</td><td>${d.text}</td></tr>`); });
        if(diagnostics.length===0) diagHtml.push('<tr><td colspan="2">Ning√∫n evento t√°ctico detectado.</td></tr>');
        diagHtml.push('</tbody></table>');
        cont.insertAdjacentHTML('beforeend', diagHtml.join(''));

        const counts = diagnostics.reduce((acc,cur)=>{ acc[cur.type]=(acc[cur.type]||0)+1; return acc; }, {});
        const summary = `<div style="margin-top:6px;padding:8px;border:1px solid #ccc;background:#fff9"><strong>Resumen t√°ctico:</strong> ${Object.entries(counts).map(([k,v])=>`${k}: ${v}`).join(' ‚Ä¢ ') || 'Sin incidentes'}</div>`;
        cont.insertAdjacentHTML('afterbegin', summary);
      }catch(err){ console.warn('Enhanced report failed', err); }
    };
  }
})();
</script>

<script>

/* === PATCH: missile alerts refined + remove manual click-hit + collision risk at same level === */
(function(){
  const COLLISION_HORIZ_NM = 1.2;   // distancia horizontal para riesgo de colisi√≥n
  const COLLISION_ALT_FT   = 500;   // diferencia de altitud para "mismo nivel"

  // --- Eliminar el comportamiento de click-hit manual si fue agregado previamente ---
  try{
    if(window.__clickHitHandlerAttached){
      const cvs = document.getElementById('radar');
      if(cvs && window.__clickHitHandler){
        cvs.removeEventListener('click', window.__clickHitHandler, true);
      }
      window.__clickHitHandlerAttached = false;
      window.__clickHitHandler = null;
    }
  }catch(e){ /* no-op */ }

  // --- Riesgo de colisi√≥n: pares de aviones cerca y mismo nivel ---
  function computeCollisionRisks(){
    const planes = st.planes || [];
    const risks = [];
    for(let i=0;i<planes.length;i++){
      for(let j=i+1;j<planes.length;j++){
        const A = planes[i], B = planes[j];
        const dNM = Math.hypot((A.x||0)-(B.x||0),(A.y||0)-(B.y||0));
        const dAlt = Math.abs((A.alt||0)-(B.alt||0));
        if(dNM <= COLLISION_HORIZ_NM && dAlt <= COLLISION_ALT_FT){
          risks.push({a:A,b:B,dNM});
        }
      }
    }
    st.collisionRisks = risks;
  }

  function drawCollisionAlerts(){
    if(!st.collisionRisks || !st.collisionRisks.length) return;
    const t = (performance.now()%1000)/1000;
    const pulse = 1 + 0.6*Math.sin(t*2*Math.PI);
    ctx.save();
    st.collisionRisks.forEach(r=>{
      const sA = toScreen(r.a.x, r.a.y);
      const sB = toScreen(r.b.x, r.b.y);
      const midX = (sA.x + sB.x)/2, midY = (sA.y + sB.y)/2;
      const rpx = Math.max(18, 12*pulse);
      ctx.strokeStyle = 'rgba(255,77,77,0.85)';
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(sA.x, sA.y, rpx, 0, 2*Math.PI); ctx.stroke();
      ctx.beginPath(); ctx.arc(sB.x, sB.y, rpx, 0, 2*Math.PI); ctx.stroke();
      ctx.setLineDash([6,4]);
      ctx.strokeStyle='rgba(255,120,120,0.85)';
      ctx.beginPath(); ctx.moveTo(sA.x, sA.y); ctx.lineTo(sB.x, sB.y); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = '#ff4d4d'; ctx.font = 'bold 12px monospace'; ctx.textAlign='center';
      ctx.fillText('RIESGO COLISI√ìN', midX, midY - 12);
      ctx.fillStyle = '#ffe066'; ctx.font='11px monospace';
      ctx.fillText(`${r.a.name} ‚Üî ${r.b.name} ‚Äî ${r.dNM.toFixed(2)} NM`, midX, midY + 6);
    });
    ctx.restore();
  }

  // Integrar el overlay de colisiones despu√©s de dibujar misiles (o al final del frame)
  if(typeof window.drawMissiles === 'function'){
    const __origDrawMissiles = window.drawMissiles;
    window.drawMissiles = function(){
      __origDrawMissiles();
      try{ computeCollisionRisks(); drawCollisionAlerts(); }catch(e){}
    };
  }

  // --- Mejorar alertas de misiles (origen‚Üídestino + distancia restante) ---
  function refreshMissilePanel(){
    const panel = document.getElementById('missileAlerts');
    if(!panel) return;
    panel.innerHTML = '';
    const missiles = st.missiles || [];
    if(!missiles.length){
      const d=document.createElement('div');
      d.className='card';
      d.textContent='No hay misiles en vuelo.';
      panel.appendChild(d);
      return;
    }
    missiles.forEach(m=>{
      if(m.status && m.status!=='fly') return;
      const L = (st.planes||[]).find(p=>p.id===m.launcher) || {name: m.launcher, x:m.x, y:m.y};
      const T = (st.planes||[]).find(p=>p.id===m.tgt) || {name: m.tgt, x:m.tx||m.x, y:m.ty||m.y};
      const distNM = Math.hypot((T.x||0)-(m.x||0), (T.y||0)-(m.y||0));
      const distKM = distNM * NM2KM;
      const nmInt = Math.max(0, Math.round(distNM));
      const kmInt = Math.max(0, Math.round(distKM));
      const distTxt = `${String(nmInt).padStart(3,'0')} NM (${String(kmInt).padStart(3,'0')} KM)`;
      const card=document.createElement('div');
      card.className='card';
      card.style.background='rgba(20,0,0,0.6)';
      card.style.borderColor='#b00';
      card.style.color='#ffe066';
      card.innerHTML = `<strong>!! MISIL ENTRANTE !!</strong><br>
        Origen: <strong>${L.name}</strong> ‚Üí Destino: <strong>${T.name}</strong><br>
        Tipo: ${m.name || m.type || 'N/A'} ‚Ä¢ DISTANCIA RESTANTE: <strong>${distTxt}</strong>`;
      panel.appendChild(card);
    });
  }
  // --- Extender reporte si existe ---
  if(typeof window.renderReport === 'function'){
    const __origReport = window.renderReport;
    window.renderReport = function(){
      __origReport();
      try{
        const cont = document.getElementById('reportContent');
        if(!cont) return;
        let html = '<h3>Misiles activos (detalle)</h3><table><thead><tr><th>Id</th><th>Tipo</th><th>Origen</th><th>Destino</th><th>Dist rest (NM)</th></tr></thead><tbody>';
        (st.missiles||[]).forEach(m=>{
          const L = (st.planes||[]).find(p=>p.id===m.launcher) || {name:m.launcher,x:m.x,y:m.y};
          const T = (st.planes||[]).find(p=>p.id===m.tgt) || {name:m.tgt,x:m.x,y:m.y};
          const distNM = Math.hypot((T.x||0)-(m.x||0),(T.y||0)-(m.y||0));
          html += `<tr><td>${m.id||''}</td><td>${m.name||m.type||''}</td><td>${L.name||''}</td><td>${T.name||''}</td><td>${distNM.toFixed(2)}</td></tr>`;
        });
        if(!(st.missiles||[]).length) html += '<tr><td colspan="5">Ninguno</td></tr>';
        html += '</tbody></table>';
        cont.insertAdjacentHTML('beforeend', html);
      }catch(e){}
    };
  }

})(); 
/* === END PATCH === */

</script>

<script>
/* === PATCH: Full missile + radar + jammer realtime sync (launch + update via Firebase) === */
(function(){
  if(typeof getDatabase!=='function'||typeof ref!=='function'||typeof set!=='function'||typeof onValue!=='function'){
    console.warn('Firebase not loaded, sync patch skipped.');
    return;
  }
  const db = getDatabase();
  const ROOM_ID = (typeof getRoomId==='function') ? getRoomId() : (window.ROOM_ID || 'sala-default');
  const stateRef = ref(db, `rooms/${ROOM_ID}/state`);
  let currentUID = window.currentUID || ('U' + Math.random().toString(36).slice(2));

  // --- Wrap launch() to push missile immediately ---
  const origLaunch = window.launch;
  if(typeof origLaunch==='function'){
    window.launch = function(launcherId,targetId,type){
      const result = origLaunch.apply(this, arguments);
      try{
        const L = (window.st.planes||[]).find(p=>p.id===launcherId);
        const T = (window.st.planes||[]).find(p=>p.id===targetId);
        const missile = (window.st.missiles||[]).slice(-1)[0]; // last missile
        if(missile){
          const payload = {
            event:'launch',
            missile: missile,
            by: currentUID,
            ts: Date.now()
          };
          set(ref(db, `rooms/${ROOM_ID}/events/MS_${missile.id||Date.now()}`), payload);
        }
        if(window.scheduleSync) window.scheduleSync();
      }catch(e){ console.warn('Sync launch fail', e); }
      return result;
    };
  }

  // --- Update missiles, radarFail, jammers into state every 0.3s ---
  setInterval(()=>{
    try{
      const s = window.st || {};
      const payload = {
        missiles: s.missiles || [],
        radarFail: s.radarFail || false,
        jammers: s.planes ? s.planes.filter(p=>p.jamming).map(p=>p.id) : [],
        by: currentUID,
        ts: Date.now()
      };
      set(ref(db, `rooms/${ROOM_ID}/dynamic`), payload);
    }catch(e){}
  }, 300);

  // --- Listen for remote missiles and recreate them if not present ---
  onValue(ref(db, `rooms/${ROOM_ID}/dynamic`), (snap)=>{
    const v = snap.val();
    if(!v || v.by===currentUID) return;
    try{
      // Radar fail sync
      if(typeof v.radarFail!=='undefined'){
        window.st.radarFail = v.radarFail;
      }
      // Jammers sync
      (window.st.planes||[]).forEach(p=>{ p.jamming = Array.isArray(v.jammers) && v.jammers.includes(p.id); });

      // Missiles sync
      if(Array.isArray(v.missiles)){
        const existing = new Set((window.st.missiles||[]).map(m=>m.id));
        v.missiles.forEach(m=>{
          if(!existing.has(m.id)){
            (window.st.missiles||[]).push(Object.assign({}, m));
            if(window.showLaunchNotice) window.showLaunchNotice(m);
          }
        });
      }
    }catch(e){ console.warn('Apply remote missile/radar sync fail', e); }
  });

  // --- Listen for launch events (redundant safety) ---
  onValue(ref(db, `rooms/${ROOM_ID}/events`), (snap)=>{
    const data = snap.val();
    if(!data) return;
    Object.entries(data).forEach(([k, evt])=>{
      if(!evt || evt.by===currentUID) return;
      if(evt.event==='launch' && evt.missile){
        const m = evt.missile;
        const exists = (window.st.missiles||[]).some(x=>x.id===m.id);
        if(!exists){
          (window.st.missiles||[]).push(Object.assign({}, m));
          if(window.showLaunchNotice) window.showLaunchNotice(m);
        }
      }
    });
  });

  console.log('Realtime missile/radar/jammer sync active.');
})();
/* === END PATCH === */

// === Override: Delete specific plane instead of last ===
(function(){
  const btn = document.getElementById('delLast');
  if(!btn) return;
  btn.onclick = ()=>{
    if(!st || !Array.isArray(st.planes) || st.planes.length===0) return;
    const options = st.planes.map(p=> `${p.id} ‚Äî ${p.name}`).join('\n');
    const pick = prompt('Eliminar avion (ID - Nombre):\n' + options + '\n\nEscribe el ID exactamente tal cual aparece:');
    if(!pick) return;
    const id = pick.split('‚Äî')[0].trim();
    const before = st.planes.length;
    st.planes = st.planes.filter(p=> p.id !== id);
    if(st.sel && st.sel.includes(id)){ st.sel = st.sel.filter(x=>x!==id); }
    if(before !== st.planes.length){
      repaintPlanesList && repaintPlanesList();
      repaintNav && repaintNav();
      repaintAlt && repaintAlt();
      // push to cloud if available
      if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function'){ window._SETCA_SYNC.push(); }
    }
  };
})();

</script>


<div id="aptoOverlay" class="aptoOverlay" aria-hidden="true">
  <div class="aptoCard">
    <div class="aptoHead">
      <div class="aptoTitle">APTO ‚Ä¢ Aeropuertos</div>
      <button id="aptoClose" class="btn mini focusable" title="Cerrar">‚úï</button>
    </div>
    <div class="aptoBody">
      <div class="aptoRow">
        <label class="chk" style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="aptoEnabled">
          <span>Mostrar en mapa</span>
        </label>
        <span class="aptoLocal">LOCAL</span>
      </div>

      <div class="aptoSeg">
        <button id="aptoModeMajor" class="btn mini focusable">Principales</button>
        <button id="aptoModeAll" class="btn mini focusable">Todos</button>
        <button id="aptoModeCustom" class="btn mini focusable">Uno por uno</button>
      </div>

      <div id="aptoCustomWrap" class="aptoCustom hidden">
        <input id="aptoSearch" type="text" placeholder="Buscar ICAO / IATA / ciudad / nombre">
        <div id="aptoList" class="aptoList"></div>
        <div class="aptoActions">
          <button id="aptoSelAll" class="btn mini focusable">Marcar visible</button>
          <button id="aptoSelNone" class="btn mini focusable">Quitar visible</button>
        </div>
      </div>
    </div>

    <div class="aptoFoot">
      <button id="aptoApply" class="btn mini focusable">Aplicar</button>
      <button id="aptoCancel" class="btn mini focusable">Cerrar</button>
    </div>
  </div>
</div>

<div id="deleteModal" style="position:fixed;top:0;left:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);z-index:9999;">
  <div style="background:#1b1b1b;padding:20px;border-radius:6px;color:#eaffea;min-width:260px;">
    <h3>Eliminar avi√≥n</h3>
    <select id="deleteSelect" style="width:100%;margin-top:10px;margin-bottom:15px;background:#111;color:#eaffea;border:1px solid #555;"></select>
    <button id="confirmDelete" class="btn mini focusable">Eliminar</button>
    <button id="cancelDelete" class="btn mini focusable" style="margin-left:10px;">Cancelar</button>
  </div>
</div>


<script>
(function setupDeleteUI(){
  function bind(){
    const btn = document.getElementById('delLast');
    const modal = document.getElementById('deleteModal');
    const sel = document.getElementById('deleteSelect');
    const ok = document.getElementById('confirmDelete');
    const cancel = document.getElementById('cancelDelete');
    if(!btn || !modal || !sel || !ok || !cancel) return false;

    // Make sure no previous listeners accumulate
    btn.replaceWith(btn.cloneNode(true));
    const newBtn = document.getElementById('delLast');

    newBtn.addEventListener('click', ()=>{
      // Populate select fresh
      sel.innerHTML = '';
      if(window.st && Array.isArray(st.planes)){
        st.planes.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.id + " ‚Äî " + p.name;
          sel.appendChild(opt);
        });
      }
      modal.style.display='flex';
    });

    ok.replaceWith(ok.cloneNode(true));
    cancel.replaceWith(cancel.cloneNode(true));
    const ok2 = document.getElementById('confirmDelete');
    const cancel2 = document.getElementById('cancelDelete');

    ok2.addEventListener('click', ()=>{
      const id = sel.value;
      if(id && window.st && Array.isArray(st.planes)){
        st.planes = st.planes.filter(p=>p.id!==id);
        if(st.sel) st.sel = st.sel.filter(x=>x!==id);
        if(typeof repaintPlanesList==='function') repaintPlanesList();
        if(typeof repaintNav==='function') repaintNav();
        if(typeof repaintAlt==='function') repaintAlt();
        if(typeof repaintPairs==='function') repaintPairs();
        if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function'){ window._SETCA_SYNC.push(); }
      }
      modal.style.display='none';
    });
    cancel2.addEventListener('click', ()=>{ modal.style.display='none'; });

    // Also close modal on background click
    modal.addEventListener('click', (e)=>{
      if(e.target===modal) modal.style.display='none';
    });

    return true;
  }

  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    bind();
  } else {
    document.addEventListener('DOMContentLoaded', bind, { once:true });
  }

  // Fallback rebinder (in case other code rebinds later)
  setTimeout(bind, 800);
  setTimeout(bind, 2000);
})();
</script>


<script>
function fitRadar(){
  const box = document.getElementById('radarBox');
  const cvs = document.getElementById('radar');
  if(!box || !cvs) return;
  const w = box.clientWidth;
  cvs.width = w;
  cvs.height = w;
}
window.addEventListener('resize', fitRadar);
window.addEventListener('orientationchange', fitRadar);
setTimeout(fitRadar,200);
</script>


<script>
const __delBtn=document.getElementById('delDraw'); if(__delBtn) __delBtn.onclick = ()=>{
  const modal = document.getElementById('deleteDrawingModal');
  const sel = document.getElementById('deleteDrawingSelect');
  sel.innerHTML='';
  if(st && Array.isArray(st.drawings)){
    st.drawings.forEach((d,i)=>{
      const opt=document.createElement('option');
      opt.value=i;
      opt.textContent=d.name||('Gr√°fico '+(i+1));
      sel.appendChild(opt);
    });
  }
  modal.style.display='flex';
};
</script>


<script>
(function(){
  const btn = document.getElementById('delDraw');
  const modal = document.getElementById('deleteDrawingModal');
  const sel = document.getElementById('deleteDrawingSelect');
  if(btn){
    btn.onclick = ()=>{
      if(sel){
        sel.innerHTML='';
        if(window.st && Array.isArray(window.st.drawings)){
          window.st.drawings.forEach((d,i)=>{
            const opt=document.createElement('option');
            opt.value=i;
            opt.textContent=d.name||('Gr√°fico '+(i+1));
            sel.appendChild(opt);
          });
        }
      }
      if(modal) modal.style.display='flex';
    };
  }
})();
</script>


<div id="deleteDrawingModal" style="position:fixed;top:0;left:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);z-index:99999;">
  <div style="background:#111;padding:16px;border:1px solid #2a5;border-radius:8px;color:#eaffea;min-width:280px;max-width:360px;">
    <h3 style="margin-top:0;margin-bottom:10px;">Administrar gr√°ficos</h3>

    <label style="font-size:12px;opacity:.85;">Selecciona un gr√°fico</label>
    <select id="deleteDrawingSelect" style="width:100%;margin:6px 0 10px 0;"></select>

    <label style="font-size:12px;opacity:.85;">Nombre</label>
    <input id="drawingNameInput" type="text" style="width:100%;margin:6px 0 12px 0;padding:6px;border-radius:6px;border:1px solid #2a5;background:#0b0b0b;color:#eaffea;" placeholder="Escribe el nuevo nombre‚Ä¶"/>

    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="renameDrawingBtn" style="flex:1;min-width:120px;">Cambiar nombre</button>
      <button id="confirmDeleteDrawing" style="flex:1;min-width:120px;">Eliminar</button>
      <button id="cancelDeleteDrawing" style="flex:1;min-width:120px;">Cerrar</button>
    </div>

    <div style="margin-top:10px;font-size:12px;opacity:.75;line-height:1.25;">
      Tip: Mant√©n <b>D</b> + click izquierdo para mover un gr√°fico.
    </div>
  </div>
</div>


<script>
(function(){
  const btn = document.getElementById('delDraw');
  const modal = document.getElementById('deleteDrawingModal');
  const sel = document.getElementById('deleteDrawingSelect');
  const ok = document.getElementById('confirmDeleteDrawing');
  const cancel = document.getElementById('cancelDeleteDrawing');
  if(btn){
    btn.onclick = ()=>{
      if(sel){
        sel.innerHTML='';
        if(window.st && Array.isArray(window.st.drawings)){
          window.st.drawings.forEach((d,i)=>{
            const opt=document.createElement('option');
            opt.value=i;
            opt.textContent=d.name||('Gr√°fico '+(i+1));
            sel.appendChild(opt);
          });
        }
      }
      modal.style.display='flex';
    };
  }
  if(ok){
    ok.onclick = ()=>{
      const idx = parseInt(sel.value);
      if(!isNaN(idx) && window.st && Array.isArray(window.st.drawings)){
        window.st.drawings.splice(idx,1);
        if(typeof repaintNav==='function') repaintNav();
        if(typeof repaintAlt==='function') repaintAlt();
        if(typeof repaintPairs==='function') repaintPairs();
        if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function'){ window._SETCA_SYNC.push(); }
      }
      modal.style.display='none';
    };
  }
  if(cancel){
    cancel.onclick = ()=>{ modal.style.display='none'; };
  }
  if(modal){
    modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none'; });
  }
})();
</script>


<script>
function ensureDrawingName(d){
  if(!d || d.name) return;
  const base = {circle:'C√≠rculo', line:'L√≠nea', arwy:'ARWY', point:'Punto', square:'Cuadrado', bullseye:'Bullseye', label:'Etiqueta', polygon:'Pol√≠gono'}[d.type] || 'Gr√°fico';
  let count = 1;
  if(window.st && Array.isArray(st.drawings)){
    count = st.drawings.filter(x => x.type === d.type).length;
  }
  d.name = base + " " + count;
}
</script>


<script>
(function(){
  const btn = document.getElementById('delDraw');
  const modal = document.getElementById('deleteDrawingModal');
  const sel = document.getElementById('deleteDrawingSelect');
  const ok = document.getElementById('confirmDeleteDrawing');
  const cc = document.getElementById('cancelDeleteDrawing');
  if(btn){
    btn.onclick = ()=>{
      if(sel){
        sel.innerHTML='';
        if(window.st && Array.isArray(st.drawings)){
          st.drawings.forEach((d,i)=>{
            const opt=document.createElement('option');
            opt.value=i;
            opt.textContent=d.name||('Gr√°fico '+(i+1));
            sel.appendChild(opt);
          });
        }
      }
      modal.style.display='flex';
    };
  }
  if(ok){
    ok.onclick = ()=>{
      const idx=parseInt(sel.value);
      if(!isNaN(idx) && st.drawings && st.drawings[idx]){
        st.drawings.splice(idx,1);
        if(typeof repaintNav==='function') repaintNav();
        if(typeof repaintAlt==='function') repaintAlt();
        if(typeof repaintPairs==='function') repaintPairs();
        if(window._SETCA_SYNC && typeof _SETCA_SYNC.push==='function') _SETCA_SYNC.push();
      }
      modal.style.display='none';
    };
  }
  if(cc){
    cc.onclick = ()=>{ modal.style.display='none'; };
  }
})();
</script>


<script>
(function(){
  const cvs = document.getElementById('radar');
  function fitRadar(){
    if(!cvs) return;
    const w = cvs.parentElement.clientWidth;
    cvs.width = w;
    cvs.height = w;
  }
  window.addEventListener('resize', fitRadar);
  window.addEventListener('orientationchange', fitRadar);
  document.addEventListener('DOMContentLoaded', fitRadar);
  setTimeout(fitRadar, 150);
})();
</script>

<script>
(function(){
  const exportBtn = document.getElementById('exportFormBtn');
  const importBtn = document.getElementById('importFormBtn');
  const fileInput = document.getElementById('formFileInput');
  if(!exportBtn || !importBtn || !fileInput) return;

  // === EXPORTAR ===
  exportBtn.onclick = ()=>{
    if(!window.st || !Array.isArray(st.planes) || st.planes.length===0){
      alert('No hay formaciones para exportar.');
      return;
    }
    const data = {
      version: 'SETCA-Form-1.0',
      timestamp: new Date().toISOString(),
      planes: st.planes,
      roles: st.roles,
      drawings: st.drawings
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `formaciones_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
    a.click();
  };

  // === IMPORTAR ===
  importBtn.onclick = ()=>{ fileInput.click(); };

  fileInput.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const data = JSON.parse(ev.target.result);
        if(!data.planes) throw new Error('Archivo inv√°lido');
        // Limpia los actuales y carga los nuevos
        st.planes = data.planes;
        st.roles = data.roles || {};
        st.drawings = data.drawings || [];
        repaintPlanesList && repaintPlanesList();
        repaintNav && repaintNav();
        repaintAlt && repaintAlt();
        repaintPairs && repaintPairs();
        alert('Formaciones cargadas correctamente.');
      }catch(err){
        alert('Error al cargar el archivo: '+err.message);
      }
    };
    reader.readAsText(file);
  });
})();
</script>
<!-- === PARCHE: Botones de aviones m√°s peque√±os + selecci√≥n amarilla === -->
<style>
  /* Cuadros m√°s peque√±os (para que entren m√°s en pantalla) */
  #planeList {
    display: grid !important;
    grid-template-columns: repeat(7, 34px) !important; /* 6 por fila */
    grid-auto-rows: 34px !important;
    gap: 5px !important;
    justify-content: start !important;
    align-content: start !important;
    padding: 4px !important;
  }

  /* Estilo base de los botones (cuadros) */
  #planeList button {
    width: 34px !important;
    height: 34px !important;
    font-size: 9px !important;
    line-height: 34px !important;
    padding: 0 !important;
    margin: 0 !important;
    text-align: center !important;
    border-radius: 6px !important;
    border: 1px solid #2a6 !important;
    background: #0e2b17 !important;
    color: var(--txt) !important;
    transition: background 0.2s, border-color 0.2s;
    cursor: pointer !important;
  }

  /* Cuando un bot√≥n est√© seleccionado */
  #planeList button.active {
    background: #ffe066 !important; /* Amarillo */
    border-color: #ffd700 !important;
    color: #000 !important;
  }

  /* Controles del bot√≥n "Etiqueta" (mantengo igual) */
  #tagControlWrap {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    margin-bottom: 6px;
  }

  #tagNudge {
    background: #102a18;
    border: 1px solid #2a6;
    color: var(--txt);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 12px;
    cursor: pointer;
  }

  #tagNudge:hover {
    background: #164f2b;
  }

  #tagPos {
    font: 12px monospace;
    color: var(--mut);
    padding: 2px 6px;
    border: 1px solid #2a6;
    border-radius: 6px;
    background: #0a110b;
  }

  /* === Men√∫ contextual de gr√°ficos === */
  #drawingCtxMenu{
    position:fixed;
    z-index:99999;
    display:none;
    background:rgba(5,10,6,0.95);
    border:1px solid var(--warn);
    border-radius:10px;
    padding:6px;
    box-shadow:0 10px 25px rgba(0,0,0,0.55);
    font-family:monospace;
    min-width:170px;
  }
  #drawingCtxMenu .ctxItem{
    width:100%;
    text-align:left;
    background:transparent;
    border:0;
    color:var(--txt);
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    font-weight:400;
  }
  #drawingCtxMenu .ctxItem:hover{
    background:rgba(255,224,102,0.12);
  }

</style>

<script>
/* === Parche funcional de selecci√≥n/deselecci√≥n amarilla en botones === */
(function(){
  document.addEventListener('DOMContentLoaded', ()=>{
    const lista = document.getElementById('planeList');
    if(!lista) return;

    lista.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button');
      if(!btn) return;
      btn.classList.toggle('active'); // cambia entre normal y amarillo
    });
  });
})();
</script>
<!-- === /PARCHE === -->  


<!-- ROOMS MODAL -->
<div id="roomsModal" class="rooms-hidden">
  <div class="rooms-backdrop"></div>
  <div class="rooms-dialog">
    <h3>Salas de entrenamiento</h3>
    <div id="roomsCurrent" style="margin-bottom:6px;font-size:13px;"></div>
    <div class="rooms-row" style="margin-bottom:8px;">
      <label for="roomsUsername" style="margin-right:4px;">Tu indicativo:</label>
      <input id="roomsUsername" placeholder="Ej: Oso" style="width:130px;">
      <button id="roomsSaveName">Guardar</button>
    </div>
    <div id="roomsList"></div>
    <div style="text-align:right;margin-top:8px;">
      <button id="roomsClose">Cerrar</button>
    </div>
  </div>
</div>

<style>
#roomsModal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#roomsModal.rooms-open{ display:flex; }
#roomsModal .rooms-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.6);
}
#roomsModal .rooms-dialog{
  position:relative;
  background:#111;
  color:#eee;
  padding:10px 14px;
  border-radius:8px;
  min-width:260px;
  max-width:420px;
  max-height:80vh;
  overflow:auto;
  box-shadow:0 0 10px #000;
  font-family:monospace;
  font-size:13px;
}
#roomsList .room-row{
  padding:4px 0;
  border-bottom:1px solid #333;
  cursor:pointer;
}
#roomsList .room-row:hover{
  background:#181818;
}
#roomsList .room-name{
  font-weight:bold;
}
#roomsList small{
  display:block;
  font-size:11px;
  color:#8f8;
}

  /* === Men√∫ contextual de gr√°ficos === */
  #drawingCtxMenu{
    position:fixed;
    z-index:99999;
    display:none;
    background:rgba(5,10,6,0.95);
    border:1px solid var(--warn);
    border-radius:10px;
    padding:6px;
    box-shadow:0 10px 25px rgba(0,0,0,0.55);
    font-family:monospace;
    min-width:170px;
  }
  #drawingCtxMenu .ctxItem{
    width:100%;
    text-align:left;
    background:transparent;
    border:0;
    color:var(--txt);
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    font-weight:400;
  }
  #drawingCtxMenu .ctxItem:hover{
    background:rgba(255,224,102,0.12);
  }

</style>

<script type="module">
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

const db = getDatabase();
const auth = getAuth();

const salas = ["alfa","bravo","charlie","delta","eco","foxtrot","golf","hotel","india","juliet"];

function getRoomId(){
  const h = (location.hash || "").replace(/^#/,"").trim();
  return h || "sala-default";
}
let currentRoom = getRoomId();

// ---- Session tracking (persiste por pestana) ----
const __sessKey = 'setca_session_start';
let sessionStart = Number(sessionStorage.getItem(__sessKey) || 0);
if(!sessionStart){
  sessionStart = Date.now();
  try{ sessionStorage.setItem(__sessKey, String(sessionStart)); }catch(_){ }
}

// Cache global de usuarios por sala
window.__setcaPresence = window.__setcaPresence || {};

let username = localStorage.getItem("setca_username") || "sinNombre";

const modal = document.getElementById("roomsModal");
const roomsCurrent = document.getElementById("roomsCurrent");
const roomsList = document.getElementById("roomsList");
const usernameInput = document.getElementById("roomsUsername");
const saveNameBtn = document.getElementById("roomsSaveName");
const closeBtn = document.getElementById("roomsClose");

if(usernameInput){ usernameInput.value = username; }

function refreshCurrent(){
  // Exponer sala actual para otros componentes
  window.__setcaCurrentRoom = currentRoom || 'sala-default';
  if(roomsCurrent){
    roomsCurrent.textContent = "Sala actual: " + String(currentRoom||"sala-default").toUpperCase();
  }
  const salasBtn = document.getElementById("salasBtn");
  if(salasBtn){
    salasBtn.title = "Sala actual: " + String(currentRoom||"sala-default").toUpperCase();
  }
}

function openModal(){
  if(!modal) return;
  refreshCurrent();
  modal.classList.add("rooms-open");
}
function closeModal(){
  if(!modal) return;
  modal.classList.remove("rooms-open");
}

if(closeBtn){
  closeBtn.addEventListener("click", closeModal);
}
if(modal){
  modal.addEventListener("click", (e)=>{
    if(e.target === modal || (e.target && e.target.classList && e.target.classList.contains("rooms-backdrop"))){
      closeModal();
    }
  });
}
if(saveNameBtn){
  saveNameBtn.addEventListener("click", ()=>{
    username = usernameInput.value || "sinNombre";
    localStorage.setItem("setca_username", username);
  });
}

// Exponer API global para que el bot√≥n de Salas lo pueda abrir
window.setcaRooms = {
  open: openModal,
  close: closeModal
};

let uid = null;
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, u=>{
  if(!u) return;
  uid = u.uid;
  startPresence();
});

function startPresence(){
  // Escuchar lista de usuarios por sala
  salas.forEach(sala=>{
    const uRef = ref(db, `rooms/${sala}/users`);
    onValue(uRef, snap=>{
      const val = snap.val() || {};
      const entries = Object.values(val);
      const names = entries.map(v => (v && v.name) ? v.name : "sinNombre");
      // Guardar cache de presencia
      try{ window.__setcaPresence[sala] = names.slice(); }catch(_){ }
      const count = names.length;
      const rowId = "room-row-" + sala;
      let row = document.getElementById(rowId);
      if(!row){
        row = document.createElement("div");
        row.id = rowId;
        row.className = "room-row";
        row.onclick = ()=>chooseRoom(sala);
        roomsList.appendChild(row);
      }
      const label = sala.toUpperCase() + ": " + count + " conectados";
      const namesHtml = names.length ? `<small>${names.map(n => `${n} <button class='kick-user' data-user='${n}' style='font-size:10px;'>-</button>`).join('<br>')}</small>` : "";
      row.innerHTML = `<span class="room-name">${label}</span>${namesHtml}`;
    });
  });

  // Heartbeat de presencia en la sala actual
  setInterval(()=>{
    if(!uid) return;
    const nameToUse = (usernameInput && usernameInput.value) ? usernameInput.value : username;
    username = nameToUse || username;
    localStorage.setItem("setca_username", username);
    window.__setcaUsername = username;
    const meRef = ref(db, `rooms/${currentRoom}/users/${uid}`);
    set(meRef, { name: username, t: Date.now() });
  }, 5000);

  refreshCurrent();
}


// EXIT BUTTON HANDLER
document.addEventListener("click", (e)=>{
  if(e.target && e.target.classList.contains("rooms-exit")){
    const sala = e.target.getAttribute("data-sala");
    if(uid && sala){
      const userRef = ref(db, `rooms/${sala}/users/${uid}`);
      set(userRef, null);
    }
    e.stopPropagation();
  }
});

// Kick user handler
document.addEventListener("click", (e)=>{
  if(e.target && e.target.classList.contains("kick-user")){
    const name = e.target.getAttribute("data-user");
    // remove from current room
    salas.forEach(s=>{
      const uRef = ref(db, `rooms/${s}/users`);
      onValue(uRef, snap=>{
        const val = snap.val()||{};
        for(const uid2 in val){
          if(val[uid2].name === name){
            // move to default
            set(ref(db, `rooms/${s}/users/${uid2}`), null);
            set(ref(db, `rooms/sala-default/users/${uid2}`), {name:name, t:Date.now()});
          }
        }
      }, {onlyOnce:true});
    });
    e.stopPropagation();
  }
});

// ---- OFF: resumen de sesion + cleanup de presencia + cierre ----
window.setcaOff = async function(){
  try{
    const start = sessionStart || Number(sessionStorage.getItem(__sessKey) || Date.now());
    const ms = Date.now() - start;
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');

    const room = String(currentRoom || 'sala-default');
    const users = (window.__setcaPresence && window.__setcaPresence[room]) ? window.__setcaPresence[room] : [];

    const planes = (window.st && Array.isArray(window.st.planes)) ? window.st.planes : [];
    const planeNames = planes.map(p => (p && (p.name || p.id)) ? (p.name || p.id) : 'sinID');

    // Limpiar presencia propia
    try{
      if(uid){
        await set(ref(db, `rooms/${room}/users/${uid}`), null);
      }
    }catch(e){
      console.warn('OFF: no se pudo limpiar presencia', e);
    }

    const msg = [
      'SETCA - Cierre de sesion',
      '-----------------------',
      `Indicativo: ${window.__setcaUsername || username || 'sinNombre'}`,
      `Sala: ${room.toUpperCase()}`,
      `Tiempo conectado: ${hh}:${mm}:${ss}`,
      '',
      `Usuarios conectados (${users.length}):`,
      (users.length ? ' - ' + users.join('\n - ') : ' - (ninguno)'),
      '',
      `Aviones en frecuencia (${planes.length}):`,
      (planeNames.length ? ' - ' + planeNames.join('\n - ') : ' - (ninguno)')
    ].join('\n');

    alert(msg);

    // Intentar cerrar la pestana/ventana
    try{ window.close(); }catch(_){ }
    // Si el navegador no permite cerrar, al menos detenemos la app
    setTimeout(()=>{
      try{ window.close(); }catch(_){ }
      try{ location.href = 'about:blank'; }catch(_){ }
    }, 80);
  }catch(err){
    console.error('OFF handler error:', err);
    alert('No se pudo cerrar correctamente. Puedes cerrar la pestana manualmente.');
    try{ location.href = 'about:blank'; }catch(_){ }
  }
};

function chooseRoom(sala){
  const prevRoom = currentRoom;
if(sala === currentRoom) return;
  currentRoom = sala;
  // cambiar hash para que TODO el simulador use esa sala
  location.hash = "#" + sala;
  
  // REMOVE USER FROM PREVIOUS ROOM
  if(uid){
    const oldRef = ref(db, `rooms/${prevRoom}/users/${uid}`);
    set(oldRef, null);
  }
  location.reload();

}
</script>



<script>
document.querySelectorAll('#pCmdBody .btn').forEach(btn=>{
  btn.addEventListener('mousedown', ()=>btn.classList.add('btn-hold'));
  btn.addEventListener('mouseup', ()=>btn.classList.remove('btn-hold'));
  btn.addEventListener('mouseleave', ()=>btn.classList.remove('btn-hold'));
});
</script>


<script>
/* === PATCH LOCAL: Data Block movible con CTRL + drag (NO sincroniza) === */
(function(){
  const cvs = document.getElementById('radar');
  if(!cvs) return;

  let draggingTag = null;
  let tagStart = null;

  function ensureTag(p){
    if(p.tagDx === undefined) p.tagDx = 12;
    if(p.tagDy === undefined) p.tagDy = -6;
  }

  cvs.addEventListener('mousedown', e=>{
    if(e.button !== 0 || !e.ctrlKey) return;

    const r = cvs.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;

    const wx = (mx - window.CX - window.offX) / (window.zoom * window.PX_PER_NM);
    const wy = (my - window.CY - window.offY) / (window.zoom * window.PX_PER_NM);

    let best = null;
    let bd = 999;

    (window.st.planes || []).forEach(p=>{
      ensureTag(p);
      const tx = p.x + p.tagDx/(window.zoom*window.PX_PER_NM);
      const ty = p.y + p.tagDy/(window.zoom*window.PX_PER_NM);
      const d = Math.hypot(wx - tx, wy - ty);
      if(d < 8/(window.zoom*window.PX_PER_NM) && d < bd){
        bd = d;
        best = p;
      }
    });

    if(best){
      draggingTag = best;
      tagStart = { x: e.clientX, y: e.clientY };
      e.preventDefault();
    }
  });

  addEventListener('mousemove', e=>{
    if(e.buttons!==1) return;
    if(!draggingTag) return;
    draggingTag.tagDx += (e.clientX - tagStart.x);
    draggingTag.tagDy += (e.clientY - tagStart.y);
    tagStart = { x: e.clientX, y: e.clientY };
  });

  addEventListener('mouseup', ()=>{
    draggingTag = null;
    tagStart = null;
  });
})();
</script>


<script>
/* === FIX REAL: CTRL + drag DATA BLOCK (LOCAL ONLY) === */
(function(){
  const cvs = document.getElementById('radar');
  if(!cvs) return;

  let dragging = null;
  let start = null;

  function hitTag(p, mx, my){
    if(p.tagDx===undefined) p.tagDx=12;
    if(p.tagDy===undefined) p.tagDy=-6;
    const s = {x: window.CX+window.offX+p.x*window.zoom*window.PX_PER_NM,
               y: window.CY+window.offY+p.y*window.zoom*window.PX_PER_NM};
    const x = s.x + p.tagDx;
    const y = s.y + p.tagDy;
    return (mx>x && mx<x+88 && my>y-12 && my<y+44);
  }

  cvs.addEventListener('mousedown', e=>{
    if(e.button!==0 || !(e.key==='z' || e.key==='Z' || e.getModifierState && e.getModifierState('Z'))) return;
    const r=cvs.getBoundingClientRect();
    const mx=e.clientX-r.left, my=e.clientY-r.top;
    for(const p of (window.st.planes||[])){
      if(hitTag(p,mx,my)){
        dragging=p;
        start={x:e.clientX,y:e.clientY};
        e.preventDefault();
        break;
      }
    }
  });

  addEventListener('mousemove', e=>{
    if(e.buttons!==1) return;
    if(!dragging) return;
    dragging.tagDx += (e.clientX-start.x);
    dragging.tagDy += (e.clientY-start.y);
    start={x:e.clientX,y:e.clientY};
  });

  addEventListener('mouseup', ()=>{
    dragging=null; start=null;
  });
})();
</script>





<script>
/* === ROBUST LOCAL: Z + drag DATA BLOCK (pointer events, captura, sin sync) === */
(function(){
  if(window.__tagDragInstalled) return;
  window.__tagDragInstalled = true;

  const cvs = document.getElementById('radar');
  if(!cvs || !window.st) return;

  // Track Z globally
  window.__zKeyDown = false;
  addEventListener('keydown', e=>{
    if(e.key==='z' || e.key==='Z'){ window.__zKeyDown = true; }
  }, true);
  addEventListener('keyup', e=>{
    if(e.key==='z' || e.key==='Z'){ window.__zKeyDown = false; }
  }, true);
  addEventListener('blur', ()=>{ window.__zKeyDown = false; }, true);

  let dragging = null;
  let lastClient = null;

  function ensureTag(p){
    if(p.tagDx===undefined) p.tagDx=12;
    if(p.tagDy===undefined) p.tagDy=-6;
  }

  // Hitbox matches the drawn box; slightly generous
  function hitTag(p, mx, my){
    ensureTag(p);
    const sx = window.CX + window.offX + p.x*window.zoom*window.PX_PER_NM;
    const sy = window.CY + window.offY + p.y*window.zoom*window.PX_PER_NM;
    const x  = sx + p.tagDx;
    const y  = sy + p.tagDy;
    const w = 96;   // a bit larger than draw
    const h = 64;
    return (mx > x-6 && mx < x-6+w && my > (y-18) && my < (y-18)+h);
  }

  function onPointerDown(e){
    if(e.button !== 0) return;
    if(!window.__zKeyDown) return;

    const r = cvs.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;

    // search top-most first (reverse)
    const planes = (window.st.planes || []);
    for(let i=planes.length-1;i>=0;i--){
      const p = planes[i];
      if(hitTag(p, mx, my)){
        dragging = p;
        lastClient = {x:e.clientX, y:e.clientY};
        try{ cvs.setPointerCapture(e.pointerId); }catch(_){}
        e.preventDefault();
        e.stopPropagation();
        return;
      }
    }
  }

  function onPointerMove(e){
    if(!dragging) return;
    if(!(e.buttons & 1)) return; // only while left pressed

    const dx = e.clientX - lastClient.x;
    const dy = e.clientY - lastClient.y;

    dragging.tagDx += dx;
    dragging.tagDy += dy;

    lastClient = {x:e.clientX, y:e.clientY};
    e.preventDefault();
    e.stopPropagation();
  }

  function onPointerUp(e){
    if(!dragging) return;
    dragging = null;
    lastClient = null;
    try{ cvs.releasePointerCapture(e.pointerId); }catch(_){}
    e.preventDefault();
    e.stopPropagation();
  }

  // Use capture phase to beat existing handlers
  cvs.addEventListener('pointerdown', onPointerDown, true);
  addEventListener('pointermove', onPointerMove, true);
  addEventListener('pointerup', onPointerUp, true);
  addEventListener('pointercancel', onPointerUp, true);
})();
</script>


<script>
/* === DEFINITIVO: DataBlock como OBJETO L√ìGICO (Z + drag, LOCAL, sin romper nada) === */
(function(){
  if(window.__dataBlockLogicInstalled) return;
  window.__dataBlockLogicInstalled = true;

  const cvs = document.getElementById('radar');
  if(!cvs || !window.st) return;

  // --- track Z ---
  let zDown = false;
  addEventListener('keydown',e=>{ if(e.key==='z'||e.key==='Z') zDown=true; },true);
  addEventListener('keyup',e=>{ if(e.key==='z'||e.key==='Z') zDown=false; },true);
  addEventListener('blur',()=>{ zDown=false; },true);

  let draggingPlane = null;
  let lastWorld = null;

  function ensureBlock(p){
    if(!p.dataBlock){
      p.dataBlock = {
        dx: (p.tagDx!==undefined?p.tagDx:12)/(window.zoom*window.PX_PER_NM),
        dy: (p.tagDy!==undefined?p.tagDy:-6)/(window.zoom*window.PX_PER_NM),
        w: 0.12,
        h: 0.08
      };
    }
  }

  function screenToWorld(mx,my){
    return {
      x:(mx-window.CX-window.offX)/(window.zoom*window.PX_PER_NM),
      y:(my-window.CY-window.offY)/(window.zoom*window.PX_PER_NM)
    };
  }

  function hitBlock(p,wx,wy){
    ensureBlock(p);
    const bx = p.x + p.dataBlock.dx;
    const by = p.y + p.dataBlock.dy;
    return (
      wx>bx && wx<bx+p.dataBlock.w &&
      wy>by && wy<by+p.dataBlock.h
    );
  }

  cvs.addEventListener('mousedown',e=>{
    if(e.button!==0 || !zDown) return;

    const r=cvs.getBoundingClientRect();
    const w=screenToWorld(e.clientX-r.left,e.clientY-r.top);

    for(const p of (window.st.planes||[])){
      if(hitBlock(p,w.x,w.y)){
        draggingPlane=p;
        lastWorld=w;
        e.preventDefault();
        e.stopPropagation();
        break;
      }
    }
  },true);

  addEventListener('mousemove',e=>{
    if(!draggingPlane) return;
    const r=cvs.getBoundingClientRect();
    const w=screenToWorld(e.clientX-r.left,e.clientY-r.top);

    const dx=w.x-lastWorld.x;
    const dy=w.y-lastWorld.y;

    draggingPlane.dataBlock.dx+=dx;
    draggingPlane.dataBlock.dy+=dy;

    draggingPlane.tagDx = draggingPlane.dataBlock.dx*(window.zoom*window.PX_PER_NM);
    draggingPlane.tagDy = draggingPlane.dataBlock.dy*(window.zoom*window.PX_PER_NM);

    lastWorld=w;
    e.preventDefault();
    e.stopPropagation();
  },true);

  addEventListener('mouseup',()=>{
    draggingPlane=null;
    lastWorld=null;
  },true);

})();
</script>


<script>
/* === FINAL HARD FIX: Window-level Z + drag DataBlock (LOCAL ONLY) === */
(function(){
  if(window.__FINAL_DATABLOCK_DRAG__) return;
  window.__FINAL_DATABLOCK_DRAG__ = true;

  let zDown = false;
  window.addEventListener('keydown',e=>{
    if(e.key==='z' || e.key==='Z') zDown = true;
  }, true);
  window.addEventListener('keyup',e=>{
    if(e.key==='z' || e.key==='Z') zDown = false;
  }, true);
  window.addEventListener('blur',()=>{ zDown=false; }, true);

  let dragging = null;
  let lastWorld = null;

  function screenToWorld(mx,my){
    return {
      x:(mx-window.CX-window.offX)/(window.zoom*window.PX_PER_NM),
      y:(my-window.CY-window.offY)/(window.zoom*window.PX_PER_NM)
    };
  }

  function ensureBlock(p){
    if(!p.dataBlock){
      p.dataBlock = {dx:0.02, dy:-0.01, w:0.12, h:0.08};
    }
  }

  function hitBlock(p, wx, wy){
    ensureBlock(p);
    const bx = p.x + p.dataBlock.dx;
    const by = p.y + p.dataBlock.dy;
    return wx>bx && wx<bx+p.dataBlock.w && wy>by && wy<by+p.dataBlock.h;
  }

  window.addEventListener('mousedown',e=>{
    if(e.button!==0 || !zDown || !window.st) return;
    const w = screenToWorld(e.clientX, e.clientY);
    for(const p of window.st.planes||[]){
      if(hitBlock(p, w.x, w.y)){
        dragging = p;
        lastWorld = w;
        e.preventDefault();
        e.stopPropagation();
        break;
      }
    }
  }, true);

  window.addEventListener('mousemove',e=>{
    if(!dragging) return;
    const w = screenToWorld(e.clientX, e.clientY);
    const dx = w.x - lastWorld.x;
    const dy = w.y - lastWorld.y;
    dragging.dataBlock.dx += dx;
    dragging.dataBlock.dy += dy;
    dragging.tagDx = dragging.dataBlock.dx*(window.zoom*window.PX_PER_NM);
    dragging.tagDy = dragging.dataBlock.dy*(window.zoom*window.PX_PER_NM);
    lastWorld = w;
    e.preventDefault();
    e.stopPropagation();
  }, true);

  window.addEventListener('mouseup',()=>{
    dragging = null;
    lastWorld = null;
  }, true);

})();
</script>


<script>
/* === FINAL FIX V2: Z + click + ARRRASTRAR Data Block (usa tagDx/tagDy + toScreen, LOCAL) === */
(function(){
  if(window.__DB_ZDRAG_V2__) return;
  window.__DB_ZDRAG_V2__ = true;

  const cvs = document.getElementById('radar');
  if(!cvs || !window.st || typeof toScreen!=='function') return;

  // Tecla Z global (no depende de foco)
  let zDown=false;
  window.addEventListener('keydown', e=>{ if(e.key==='z'||e.key==='Z') zDown=true; }, true);
  window.addEventListener('keyup', e=>{ if(e.key==='z'||e.key==='Z') zDown=false; }, true);
  window.addEventListener('blur', ()=>{ zDown=false; }, true);

  // Drag state
  let dragging=null;
  let last=null;

  // Caja (debe coincidir con el dibujo)
  const BOX_W=88;
  const BOX_H=56;
  const BOX_TOP=-12; // y = by-12

  function ensureTag(p){
    if(p.tagDx===undefined) p.tagDx=12;
    if(p.tagDy===undefined) p.tagDy=-6;
  }

  function getCanvasXY(ev){
    const r = cvs.getBoundingClientRect();
    const mx = ev.clientX - r.left;
    const my = ev.clientY - r.top;
    if(mx<0 || my<0 || mx>r.width || my>r.height) return null;
    return {mx,my};
  }

  function hitPlaneBlock(p, mx, my){
    ensureTag(p);
    const s = toScreen(p.x, p.y);
    const bx = s.x + p.tagDx;
    const by = s.y + p.tagDy;
    const x0 = bx;
    const y0 = by + BOX_TOP;
    return (mx>=x0 && mx<=x0+BOX_W && my>=y0 && my<=y0+BOX_H);
  }

  // Escuchar desde WINDOW para que overlays no bloqueen
  window.addEventListener('mousedown', (e)=>{
    if(e.button!==0 || !zDown) return;
    if(!window.st || !Array.isArray(st.planes)) return;

    const pt = getCanvasXY(e);
    if(!pt) return;

    // Buscar el block m√°s cercano/√∫ltimo (de arriba)
    for(let i=st.planes.length-1;i>=0;i--){
      const p = st.planes[i];
      if(hitPlaneBlock(p, pt.mx, pt.my)){
        dragging = p;
        last = pt;
        e.preventDefault();
        e.stopPropagation();
        return;
      }
    }
  }, true);

  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    const pt = getCanvasXY(e);
    if(!pt) return;

    const dx = pt.mx - last.mx;
    const dy = pt.my - last.my;

    dragging.tagDx = (dragging.tagDx||0) + dx;
    dragging.tagDy = (dragging.tagDy||0) + dy;

    last = pt;

    e.preventDefault();
    e.stopPropagation();
  }, true);

  window.addEventListener('mouseup', (e)=>{
    if(!dragging) return;
    dragging = null;
    last = null;
    e.preventDefault();
    e.stopPropagation();
  }, true);

})();
</script>


<script>
/* === HARD LOCAL LOCK: DataBlock NEVER syncs to Firebase === */
(function(){
  if(window.__DATABLOCK_LOCAL_LOCK__) return;
  window.__DATABLOCK_LOCAL_LOCK__ = true;

  // Mark fields as local-only
  function stripLocal(p){
    if(!p) return;
    delete p.tagDx;
    delete p.tagDy;
    delete p.dataBlock;
  }

  // Patch common sync functions if present
  const syncFns = ['scheduleSync','pushState','syncNow','sendState','saveState'];
  syncFns.forEach(fn=>{
    if(typeof window[fn]==='function'){
      const orig = window[fn];
      window[fn] = function(state){
        try{
          if(state && state.planes){
            state.planes.forEach(stripLocal);
          }
        }catch(e){}
        return orig.apply(this, arguments);
      };
    }
  });

  // Patch Firebase direct writes (defensive)
  if(window.firebase && firebase.database){
    const db = firebase.database();
    const origSet = db.ref().set;
    const origUpdate = db.ref().update;

    db.ref().set = function(data){
      try{
        if(data && data.planes){
          data.planes.forEach(stripLocal);
        }
      }catch(e){}
      return origSet.apply(this, arguments);
    };

    db.ref().update = function(data){
      try{
        if(data && data.planes){
          data.planes.forEach(stripLocal);
        }
      }catch(e){}
      return origUpdate.apply(this, arguments);
    };
  }

})();
</script>
<script>
/* === M√ìDULO B ‚Äî IA / Combate (4 MISILES + CONO 30¬∞ + 10s ENTRE LANZAMIENTOS) === */
(function(){
  if (!window.st) return;

  function bearing(from, to){
    const dx = (to.x || 0) - (from.x || 0);
    const dy = (to.y || 0) - (from.y || 0);
    return (Math.atan2(dx, -dy) * 180 / Math.PI + 360) % 360;
  }

  function distNM(a, b){
    return Math.hypot((a.x || 0) - (b.x || 0), (a.y || 0) - (b.y || 0));
  }

  function angleDiff(a, b){
    return Math.abs(((a - b + 540) % 360) - 180);
  }

  /* =========================================================
     MARCAR AGRESORES
  ========================================================= */
  function ensureAggressorFlags(){
    (st.planes || []).forEach(p => {
      if (st.roles[p.id] === 'Bandit' &&
          p.name &&
          p.name.toUpperCase().includes('AGRESOR')) {

        if (!p.aiAggressor) {
          p.aiAggressor = true;
          p._aiShotsFired = 0;
          p._aiLastShotTime = 0;
          p._aiLocked = null;
        }
      }
    });
  }

  /* =========================================================
     BLOQUEO ABSOLUTO EN launch()
  ========================================================= */

  if (!window._aggressorLaunchLimited && typeof window.launch === 'function') {

    window._aggressorLaunchLimited = true;
    const originalLaunch = window.launch;

    window.launch = function(srcId, tgtId, type){

      const shooter = (st.planes || []).find(p => p.id === srcId);
      if (!shooter) return;

      const isAggressor =
        shooter.name &&
        shooter.name.toUpperCase().includes("AGRESOR");

      if (isAggressor) {

        shooter._aiShotsFired = shooter._aiShotsFired || 0;
        shooter._aiLastShotTime = shooter._aiLastShotTime || 0;

        const now = performance.now();

        // üîí M√°ximo 4 total
        if (shooter._aiShotsFired >= 4) return;

        // ‚è± Separaci√≥n m√≠nima 10 segundos
        if (now - shooter._aiLastShotTime < 10000) return;

        shooter._aiShotsFired++;
        shooter._aiLastShotTime = now;
      }

      return originalLaunch(srcId, tgtId, type);
    };
  }

  /* =========================================================
     IA PRINCIPAL
  ========================================================= */

  function tickAI(){
    if (!window.st || st.paused) return;

    ensureAggressorFlags();

    const planes = st.planes || [];
    const friends = planes.filter(p => st.roles[p.id] === 'Friend');
    const aggressors = planes.filter(p => p.aiAggressor);

    if (!friends.length) return;

    aggressors.forEach(b => {

      let tgt = null;
      let dBest = 9999;

      friends.forEach(f => {
        const d = distNM(b, f);
        if (d < dBest) {
          dBest = d;
          tgt = f;
        }
      });

      if (!tgt) return;

      // Registrar enganche una vez
      if (!b._aiLocked) {
        b._aiLocked = tgt.id;
        if (window.logEvent) {
          logEvent(`INFORME TACTICO: AGRESOR ${b.name} ENGANCH√ì A ${tgt.name}`);
        }
      }

      // Persecuci√≥n constante
      const brgToTgt = bearing(b, tgt);
      b.tgtHdg = brgToTgt;
      b.tgtSpd = Math.max((tgt.spd || 450) + 100, 550);

      // Si ya dispar√≥ 4 ‚Üí solo persigue
      if ((b._aiShotsFired || 0) >= 4) return;

      // Verificar cono frontal ¬±30¬∞
      const currentHdg = b.hdg || b.tgtHdg || 0;
      const offAngle = angleDiff(currentHdg, brgToTgt);
      if (offAngle > 30) return;

      // Condici√≥n de rango
      if (dBest <= 40 && dBest >= 6) {
        const type = (dBest > 20) ? 'AMRAAM' : 'R77';
        window.launch(b.id, tgt.id, type);
      }

    });
  }

  setInterval(tickAI, 200);

})();
</script>
  


<script>
/* === FIX DEFINITIVO: Administrar gr√°ficos desde el bot√≥n BORRAR (renombrar + eliminar) === */
(function(){
  function bind(){
    const btn = document.getElementById('delDraw');
    const modal = document.getElementById('deleteDrawingModal');
    const sel = document.getElementById('deleteDrawingSelect');
    const nameIn = document.getElementById('drawingNameInput');
    const ren = document.getElementById('renameDrawingBtn');
    const del = document.getElementById('confirmDeleteDrawing');
    const close = document.getElementById('cancelDeleteDrawing');
    if(!btn || !modal || !sel || !nameIn || !ren || !del || !close) return false;

    // Limpia handlers previos (evita duplicados)
    btn.replaceWith(btn.cloneNode(true));
    const btn2 = document.getElementById('delDraw');

    function typeLabel(t){
      return ({line:'L√≠nea',arwy:'ARWY',circle:'C√≠rculo',polygon:'Pol√≠gono',square:'Cuadrado',point:'Punto',bullseye:'Bullseye',label:'Etiqueta'}[t] || t || 'Gr√°fico');
    }

    function refreshList(pickId){
      sel.innerHTML = '';
      const arr = (window.st && Array.isArray(st.drawings)) ? st.drawings : [];
      arr.forEach(d=>{
        try{ if(typeof ensureDrawingName==='function') ensureDrawingName(d); }catch(_){}
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = `${(d.name||('Gr√°fico '+d.id))} ‚Äî ${typeLabel(d.type)}`;
        sel.appendChild(opt);
      });

      if(pickId) sel.value = pickId;
      if(!sel.value && sel.options.length) sel.selectedIndex = 0;

      const cur = arr.find(x=>x.id===sel.value);
      nameIn.value = cur ? (cur.name || '') : '';
    }

    btn2.onclick = ()=>{
      if(window.st && Array.isArray(st.drawings)){
        st.drawings.forEach(d=>{ try{ if(typeof ensureDrawingName==='function') ensureDrawingName(d); }catch(_){} });
      }
      refreshList(st.selectedDrawing || null);
      modal.style.display = 'flex';
    };

    sel.onchange = ()=>{
      const cur = (st.drawings||[]).find(x=>x.id===sel.value);
      nameIn.value = cur ? (cur.name || '') : '';
      if(cur) st.selectedDrawing = cur.id;
    };

    ren.onclick = ()=>{
      const id = sel.value;
      const cur = (st.drawings||[]).find(x=>x.id===id);
      if(!cur) return;
      const t = (nameIn.value || '').trim();
      cur.name = t ? t : null;
      st.selectedDrawing = id;

      if(typeof repaintNav==='function') repaintNav();
      if(typeof repaintAlt==='function') repaintAlt();
      if(typeof repaintPairs==='function') repaintPairs();
      if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function') window._SETCA_SYNC.push();

      refreshList(id);
    };

    del.onclick = ()=>{
      const id = sel.value;
      if(window.st && Array.isArray(st.drawings)){
        st.drawings = st.drawings.filter(x=>x.id!==id);
        if(st.selectedDrawing===id) st.selectedDrawing = null;

        if(typeof repaintNav==='function') repaintNav();
        if(typeof repaintAlt==='function') repaintAlt();
        if(typeof repaintPairs==='function') repaintPairs();
        if(window._SETCA_SYNC && typeof window._SETCA_SYNC.push==='function') window._SETCA_SYNC.push();
      }
      modal.style.display = 'none';
    };

    close.onclick = ()=>{ modal.style.display = 'none'; };

    modal.addEventListener('click', (e)=>{
      if(e.target===modal) modal.style.display='none';
    }, true);

    return true;
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind, { once:true });
  }else{
    bind();
  }
  setTimeout(bind, 600);
  setTimeout(bind, 1800);
})();
</script>

</body>
</html>
B Y     W   A   L   L   A   C   E // v2.1
